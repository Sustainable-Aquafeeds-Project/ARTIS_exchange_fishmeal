---
title: "Explore scenario analysis"
output: html_document
date: "2024-11-25"
editor_options: 
  chunk_output_type: console
---

## Summary

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(qs)
library(scales)
library(viridis)
library(dplyr)
library(exploreARTIS)
library(patchwork)
library(ggsankey)


source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

fillet_artis <- full_artis %>%
  filter(hs6 != 230120) %>%
  dplyr::select(-hs_version) %>% # don't need this
  rename(consumer_iso3c = importer_iso3c) # just to make things consistent

artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) %>% ## read in attribute table with common names
  mutate(phylum = case_when(
    common_name %in% c("mackerels, tunas, and bonitos", "salmons and trouts", "herrings", "cartilaginous fishes nei", "flounders", "african lungfishes", "toothfish", "carps, minnows, loaches, etc", "blue whitings") ~ "chordata",
    TRUE ~ phylum
  )) # fix phylum mistakes
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

fm_data <-   qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_gf_final.qs")) %>%
  left_join(artis_taxa)

```

Save a file for top 20 contributing species per country for average years 2009-2013 (to match IFFO newton & jackson) and 2015-2019 (for latest years, excluding covid)

```{r}

  trade_flows_average <- fm_data %>%
    mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda") %>%
   #   filter(phylum %in% c("chordata", "arthropoda", "mollusca") ) %>%
    filter(year %in% c(2009:2013)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = mean(product_weight_t, na.rm = TRUE),
            live_weight_t = mean(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup()
  
  sum(trade_flows_average$product_weight_t) # 5608028 makes sense
  
  
  top_species_by_country <- trade_flows_average %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>%
  ungroup() %>%
  right_join(trade_flows_average, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) 
  
  sum(top_species_by_country$product_weight_t) # 5102744 ; should be less and it is

  ## save
  qs::qsave(top_species_by_country, here("outputs/top_species_fm_2009_2013.qs"))
  
  
  ## now do the same for 2015-2019
  
  
    trade_flows_average <- fm_data %>%
    mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda") %>%
          #  filter(phylum %in% c("chordata", "arthropoda", "mollusca") ) %>%
    filter(year %in% c(2015:2019)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = mean(product_weight_t, na.rm = TRUE),
            live_weight_t = mean(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup()
  
  sum(trade_flows_average$product_weight_t) # 5608028 makes sense
  
  
  top_species_by_country <- trade_flows_average %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>%
  ungroup() %>%
  right_join(trade_flows_average, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) 
  
  sum(top_species_by_country$product_weight_t) # 5102744 ; should be less and it is

  ## save
  qs::qsave(top_species_by_country, here("outputs/top_species_fm_2015_2019.qs"))
  
  
```


Figure 1: 
Trends from 1996-2020 split by phylum; 
 - we don't read in the data we've saved before because we want to see the actual yearly change. 
 - NOTE: should i calculate a 5 year rolling average for every year? I.e., 2009 = 2005-2009 average, 2010 = 2006-2010 average, etc. 

```{r}

fm_data_top_spp <- fm_data %>%
    mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
      filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda") %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>% # take the top 20 specices for each source country (and year?)
  ungroup() %>%
  right_join(fm_data, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) # this takes awhile to run

test <- fm_data_top_spp %>%
  group_by(year, source_country_iso3c) %>%
  summarise(n_distinct(sciname)) %>%
  ungroup()



fm_data_top_spp %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum() # 5160282
fm_data %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum()
5160282/6233093 # we retain ~89% of fishmeal reported in ARTIS by only keeping top 20 species.


test <- fm_data_top_spp %>%
       mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda" | sciname == "actinopterygii"|sciname == "animalia")

test %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum() # 5048806


all_spp_time <- fm_data_top_spp %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "All species")

finfish_time <- fm_data_top_spp %>%
  filter(phylum == "chordata") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Finfish") 

crust_time <- fm_data_top_spp %>%
  filter(phylum == "arthropoda") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Crustaceans") 

mollusc_time <- fm_data_top_spp %>%
  filter(phylum == "mollusca") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Molluscs")  %>%
  filter(product_t != 0)

overtime_all <- rbind(all_spp_time, finfish_time, crust_time, mollusc_time) %>%
  mutate(perc = scales::percent(round(prop, 2), accuracy = 1))

artis_palette(length(unique(overtime_all$fishmeal_type)))

ggplot(overtime_all, aes(x = year, y = product_t, color = fishmeal_type)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~data_type, scales = "free_x") + 
  labs(x = "Year", y = "Fishmeal product (tonnes)", color = "Fishmeal type") + 
    scale_color_manual(values = c("trimmings" = "#741A32", "whole fish" = "#114F59"), 
                     labels = c("Trimmings-derived", "Whole fish-derived")) + 
  scale_x_continuous(limits = c(1994.5, 2021.5), breaks = c(1996, 2002, 2008, 2014, 2020), 
                     labels = c(1996, 2002, 2008, 2014, 2020)) +
  theme(legend.position = "bottom") +
    geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "trimmings", data_type != "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "whole fish", data_type != "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year %in% c(2020), fishmeal_type == "trimmings", data_type == "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 0.5, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "whole fish", data_type == "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = -0.5, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "trimmings", data_type != "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = -0.5, hjust = 0.5, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "whole fish", data_type != "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
        geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "trimmings", data_type == "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "whole fish", data_type == "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0.5, hjust = 1, show.legend = FALSE, size = 3) 



ggsave(here("outputs/figs/MS/Figure_1_time.png"), width = 180, height =180 , units = "mm", bg = "white", dpi =300)


```

Compare our total fishmeal values to what FAO reports

```{r}
comm_codes <- read.csv(here("data/FI_Trade_PP_2024.1.0/CL_FI_COMMODITY_ISSCFC.csv")) %>%
  clean_names()

countries <- read.csv(here("data/FI_Trade_PP_2024.1.0/CL_FI_COUNTRY_GROUPS.csv")) %>%
  clean_names()

FAO_fm <- read.csv(here("data/FI_Trade_PP_2024.1.0/TRADE_PP_QUANTITY.csv")) %>%
  clean_names() %>%
  left_join(comm_codes, by = c("commodity_fao_code" = "code")) %>%
  left_join(countries, by = c("country_un_code" = "un_code")) %>%
  filter(sit_cv4 == 81.42) %>%
  group_by(period) %>%
  summarise(tonnes_pw = sum(value, na.rm = TRUE)) %>%
  ungroup()

```



## Figure 2. Production and trade flows

```{r}
top_species_by_country_2019 <- qs::qread(here("outputs/top_species_fm_2015_2019.qs"))
  
  sum(top_species_by_country_2019$product_weight_t) # 5164316; ok cool. Seems reasonable. FAO reports ~5.1 million tonnes for 2019 (figure 68 in FAO SOFIA, hard to tell the exact number)

   # Create a simplified trade flow visualization
  trade_flows <- top_species_by_country %>% 
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/sum(product_weight_t))
  
  sum(trade_flows$product_weight_t) # 5164316
  
    
## Ok let's try to make the sankey a bit prettier
    
# Setting up parameters based on user input-----------------------------------
  
  # Assign weight column to quantity
  quantity <- "product_weight_t"
    
    cols <- c("source_country_iso3c", "fishmeal_type", "importer_iso3c")

  # Summarizing data based on quantity variable selected
  links <- trade_flows %>%
    group_by(source_country_iso3c, fishmeal_type, importer_iso3c) %>% 
    summarize(total_q = sum(.data[[quantity]], na.rm = TRUE))

  
  # Rename specified columns to generic names for processing
  colnames(links) <- c(paste("col_", 1:length(cols), sep = ""), "total_q")
  cols <- colnames(links)[1:length(cols)]
  
  # Identify list of nodes by column by proportional flow cutoff
  node_names <- c()
  
  for(i in 1:length(cols)){
    # Identify nodes in the column falling below the threshold
    # i = 1 
    node_i <- links %>%
      rename(col_i = paste("col_", i, sep = "")) %>%
      group_by(col_i) %>%
      summarize(total_q = sum(total_q, na.rm=TRUE)) %>%
      ungroup() %>%
      mutate(total = sum(total_q, na.rm=TRUE)) %>%
      mutate(prop = total_q / total) %>%
      # label those below threshold as "Other" - otherwise keep name
      mutate(name_new = case_when(
        prop <= 0.03200603019175 ~ "Other", # this is the cutoff for including Chile on the left hand size
        TRUE ~ col_i
      ))
    
    # Create vector of nodes
    node_names_i <- node_i$name_new
    
    # Replace node names with "Other" when it falls below the threshold 
    # in links dataframe
    links <- links %>%
      rename(col_i = paste("col_", i, sep = "")) %>%
      mutate(col_i = case_when(
        col_i %in% node_names_i ~ col_i,
        TRUE ~ "Other"
      ))
    # rename working column with generic name perscribed above 
    colnames(links)[colnames(links) == "col_i"] <- paste("col_", i, sep = "")
    
    # vector of all node names
    node_names <- unique(c(node_names, node_names_i))
  }
  # vector of all node names across all columns of interest 
  node_names <- unique(node_names)
  
  # Creating dataframe from sankey----------------------------------------------
  # keep "Other" observation values if specified, remove if flase
  show.other = FALSE
  
  if(show.other == FALSE){
    node_names <- node_names[node_names != "Other"]
  }else{
    node_names <- node_names
  }
  
  sankey_df <- links %>%
    # Filtering data based on prop flow cutoff - use show.other value 
    filter_at(vars(cols), all_vars(. %in% node_names)) %>%
    ungroup() %>% 
    # rename("Phylum" = "col_1", 
    #        "Fishmeal type" = "col_2",
    #        "Consuming countries" = "col_3") %>%
        # rename( 
        #    "Fishmeal type" = "col_1",
        #    "Consuming countries" = "col_2")
    rename("Producing countries" = "col_1",
           "Fishmeal type" = "col_2",
           "Consuming countries" = "col_3") %>%
    mutate(`Fishmeal type` = str_to_sentence(`Fishmeal type`),
           `Producing countries` = countrycode(sourcevar = `Producing countries`, origin = "iso3c", destination = "country.name"),
           `Consuming countries` = countrycode(sourcevar = `Consuming countries`, origin = "iso3c", destination = "country.name")) %>%
    filter(!is.na(`Producing countries`))

  
    # col_1 = "phylum"
  # col_2 = "fishmeal_type"
  # col_3 = "importer_iso3c"
  
  sankey_df <- sankey_df %>%
    # Transforming into ggsankey format (x, node, next_x, next_node)
     # ggsankey::make_long(c("Phylum", "Fishmeal type", "Consuming countries"), value = total_q) 
       #  ggsankey::make_long(c("Fishmeal type", "Consuming countries"), value = total_q) 
            ggsankey::make_long(c("Producing countries", "Fishmeal type", "Consuming countries"), value = total_q) 



  
  num_nodes <- length(unique(c(sankey_df$node,sankey_df$next_node)))
  
  # Visualizing sankey diagram--------------------------------------------------

# Save the Sankey plot as object A
plot_a <- sankey_df %>%
    ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node
               )) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_label(size = 3, color = "black", fill = "gray") +
    theme_sankey(base_size = 10) +
    scale_fill_manual(values = artis_palette(num_nodes)) + 
    labs(x = NULL, title = "", 
         subtitle = "A") +
    theme(
      legend.position = "none",
      axis.text.x = element_text(color = "black", size = 10),
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
    )  + 
    scale_x_discrete(position = "bottom") 

ggsave(plot = plot_a, filename = here("outputs/figs/MS/figure_2a.png"), 
       width = 180, 
       height = 100,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Save the whole fish map as plot B
trade_flows_2 <- filter(top_species_by_country, exporter_iso3c != importer_iso3c)

plot_b <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "whole fish"), 
                   country_fill = "importer_iso3c", 
                   flow_arrows = TRUE, 
                   arrow_label = "Exports (million t)", 
                   fill_label = "Imports (million t)", 
                   value = "product_weight_t",
                   n_flows = 5) + 
    labs(subtitle = "B", caption = "Whole fish fishmeal") +
      theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(),            # Remove any rectangular elements
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")                            
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

test <- trade_flows_2 %>% filter(fishmeal_type == "whole fish") %>% group_by(importer_iso3c, exporter_iso3c) %>% summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>% ungroup()

test %>% filter(importer_iso3c == "CHN") %>% pull(tonnes) %>% sum()/sum(test$tonnes) # 0.4761825; ~48% of imports go to China. The scale on the plot makes it seem more like 80%? It's because the scale is out of 1 million. So that is millions of tonnes, not a proportion.


ggsave(plot = plot_b, filename = here("outputs/figs/MS/figure_2b.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the trimmings map as plot C
plot_c <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "importer_iso3c", 
                   flow_arrows = TRUE, 
                   arrow_label = "Exports (million t)", 
                   fill_label = "Imports (million t)", 
                   value = "product_weight_t", 
                   n_flows = 5) +
    labs(subtitle = "C", caption = "Trimmings fishmeal") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(),               # Remove any rectangular elements
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

ggsave(plot = plot_c, filename = here("outputs/figs/MS/figure_2c.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the fishmeal production map as plot D
plot_d1 <- plot_map(top_species_by_country %>% filter(fishmeal_type == "whole fish"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t"
                  )  

plot_d2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "whole fish"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_d2$layer[[2]]

arrow_scale <- plot_d2$scales$scales[[
  which(sapply(plot_d2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_d <- plot_d1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "D",
       caption = "Whole fish fishmeal", 
       color = "Exports (million t)",
       fill = "Production (million t)") +
  theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   # Remove any rectangular elements
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

ggsave(plot = plot_d, filename = here("outputs/figs/MS/figure_2d.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Save the fishmeal production map as plot E
plot_e1 <- plot_map(top_species_by_country %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t" 
                  ) 

plot_e2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_e2$layer[[2]]

arrow_scale <- plot_e2$scales$scales[[
  which(sapply(plot_e2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_e <- plot_e1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "E",
       caption = "Trimmings fishmeal", 
       color = "Exports (million t)", 
       fill = "Production (million t)") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   # Remove any rectangular elements
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )



ggsave(plot = plot_e, filename = here("outputs/figs/MS/figure_2e.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Combine plots using patchwork
# Then combine them with patchwork
combined_plot <- plot_a / (plot_b + plot_c) / (plot_d + plot_e) +
  # Adjust layout to give more space to maps
  plot_layout(
    heights = c(0.5, 1, 1),  # Heights for Sankey, middle maps, and bottom maps
    widths = c(1, 1)        # Equal widths for the maps
  ) &
  # Ensure consistent theme across all plots
  theme(
    plot.margin = margin(5, 5, 5, 5),
    plot.subtitle = element_text(size = 10, hjust = 0.1, color = "black")
  )
# Save the combined plot
ggsave(here("outputs/figs/MS/figure_2_combined.png"), 
       combined_plot,
       width = 320,      # Maximum width for good map visibility
       height = 300,     # Increased height for better map detail
       units = "mm", 
       bg = "white", 
       dpi = 300)
  
    
    
```

Figure 3. Species level bar chart 

```{r}
  
  
    trade_flows_4 <- top_species_by_country %>%
    group_by(common_name, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) 
    
    
    
    
plot_bar(trade_flows_4,
        bar_group = "common_name",
        fill_type = "fishmeal_type", 
        value = "product_weight_t", 
        top_n = 15)

ggsave(here("outputs/figs/MS/figure_3.png"),width = 250, height =100.92 , units = "mm", bg = "white")

```

## Trade flows and production stats for manuscript 

Explore trade flows and production statistics 

```{r}

total_tonnes <- top_species_by_country %>% 
  pull(product_weight_t) %>%
  sum()


  trade_flows_production <- top_species_by_country %>%
    group_by(source_country_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)

  
trade_flows_consumption <- top_species_by_country %>%
    group_by(importer_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)

trade_flows_imports <- top_species_by_country %>%
  filter(source_country_iso3c != importer_iso3c) %>%
    group_by(importer_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)


##  China production and consumption
### Total
trade_flows_consumption %>% filter(importer_iso3c == "CHN") %>% pull(product_weight_t) %>% sum() # 2301086
2301086/total_tonnes # 0.4455742

### Trimmings vs whole 
trade_flows_consumption %>% filter(importer_iso3c == "CHN") %>% group_by(fishmeal_type) %>% summarise(product = sum(product_weight_t)) %>% mutate(prop = product/2301086)

# A tibble: 2 Ã— 3
#   fishmeal_type  product  prop
#   <chr>            <dbl> <dbl>
# 1 trimmings     1285749. 0.559
# 2 whole fish    1015337. 0.441

trade_flows_production %>% filter(source_country_iso3c == "CHN") %>% group_by(fishmeal_type) %>% summarise(product = sum(product_weight_t)) %>% mutate(prop = product/total_tonnes)

## why does peru produce so much trimmings?
peru <- trade_flows_average %>% filter(source_country_iso3c == "PER")
  
# We present average production and associated trade patterns of fishmeal with the five latest years of data (2015-2019), we exclude 2020 due to the disruption of trade from the outbreak of the covid-19 pandemic. 
# 
# China
# China emerges as the dominant force across the fishmeal industry, using both domestic production and large imports volumes (Figure 2):
# Consumes approximately 2.61 million tonnes of fishmeal annually (~46% of global consumption), with 53% (1.4 million tonnes) from whole fish and 46% (1.2 million tonnes) from trimmings. 
# Produces around 900 thousand tonnes of trimmings-based fishmeal domestically (1st, ~15% of global production)
# Produces 560,873 tonnes of whole fish-based fishmeal domestically (2nd, ~10% of global production)
# Imports substantial quantities of both types: ~400k tonnes of trimmings-based and 861k tonnes of whole fish fishmeal
# 
# 
# Whole Fish Fishmeal trade (Figure 2B):
# Imports not including domestic production
# China's imports (861,453 tonnes) represent 15% of global fishmeal
# Japan (115,076 tonnes) and Norway (105,250 tonnes) show significant reliance on imports
# Taiwan and Turkey imports (77,082 and 70,514 tonnes respectively) suggest growing aquaculture industry
# 
# Trimmings-Based Fishmeal trade (Figure 2C):
# Imports not including domestic production
# China again leads imports (379,753 tonnes)
# Japan and Norway import 79,893 and 61,242tonnes respectively
# Taiwan 59,848 tonnes
# These patterns suggest a growing recognition of trimmings-based fishmeal as an alternative, especially in Asia
# 
# Major Consumers of Trimmings-Based Fishmeal:
# After China, Indonesia (352,159 tonnes), Vietnam (156,228 tonnes), and Japan (132,026) are significant consumers
# This suggests a strong market in Asia for trimmings
# 
# Major Consumers of Whole fish-Based Fishmeal:
# Consumption is more concentrated, with China (1.4 million tonnes) far ahead of others
# Japan (126,043 tonnes), Norway (123,561 tonnes), Indonesia (103,581 tonnes)
# 
# Whole Fish Specialists (Figure 2D):
# Peru leads global production (797,213 tonnes, 14%), leveraging its abundant anchovy fisheries
# China produces 560,873 tonnes of whole fish-based fishmeal domestically (2nd, 10% of global production)
# Chile follows with significant production (132,345 tonnes, 2.3%)
# Denmark's position (118,798 tonnes, 2.1%) reflects the North Atlantic fishing industry
# 
# Trimmings Specialists (Figure 2E):
# Aside from China (see above), Southeast Asian nations dominate trimmings-based production
# Indonesia (313,404 tonnes), Vietnam (214,756 tonnes), and Thailand (65,922 tonnes) collectively produce around 10% of global fishmeal
# This reflects the region's substantial seafood processing industry29
# 
# Summary
# 1. The fishmeal industry shows a clear geographic concentration in Asia, particularly China
# 2. There's a growing parallel market for trimmings-based fishmeal alongside traditional whole fish fishmeal worldwide
# 3. Countries show different strategies for securing supply:
#    Some focus on domestic production (Peru, Chile)
#    Others balance production and imports (China, Indonesia)
#    Some rely heavily on imports (Japan, Turkey, Norway)
# 4. Trimmings-based fishmeal is more prevalent in Asia




```


Species summary 

```{r}
  
  # Species summary
  species_summary <- top_species_by_country %>%
    group_by(sciname, common_name, source_country_iso3c, fishmeal_type) %>%
    summarise(
      total_product_weight = sum(product_weight_t, na.rm = TRUE)
    ) %>%
    arrange(desc(total_product_weight))

  species_summary_spp <- top_species_by_country %>%
    group_by(sciname, common_name, fishmeal_type) %>%
    summarise(
      total_product_weight = sum(product_weight_t, na.rm = TRUE)
    ) %>%
    arrange(desc(total_product_weight))

species_summary %>% filter(fishmeal_type == "whole fish", sciname == "engraulis ringens") %>% pull(total_product_weight) %>% sum()

species_summary %>% filter(fishmeal_type == "whole fish", sciname == "micromesistius poutassou") %>% pull(total_product_weight) %>% sum()



```


## Compare to Newton & Jackson 2013

 - Look at 2009-2013 numbers so it is comparable

```{r}
## Let's  compare to Newton and Jackson from IFFO and see if our numbers generally match

#The database includes fish, crustaceans and cephalopod molluscs but not mammals, other molluscs, reptiles, amphibians or plants as it is assumed that there are no usable by-products, or that they are not readily directed to fishmeal/ fish oil production. All of the usable supply is referred to as seafood henceforth, whether marine or freshwater. 

#The most up-to-date seafood production volume data for the last 5 years (2009-2013), taken from FAO FishStat, was averaged for each country for all species from capture and aquaculture. This was ranked to find the top twenty production species for each region for each of capture fisheries and aquaculture.  

top_species_by_country_2013 <- qs::qread(here("outputs/top_species_fm_2009_2013.qs"))
  
    sum(top_species_by_country_2013$product_weight_t) # 5102744
  

  test <- top_species_by_country_2013 %>% group_by(source_country_iso3c) %>% summarise(n_distinct(sciname)) # seems to have worked
  
  ## Newton and Jackson report ~4.639 million tonnes. Provided I followed the methodology then I should see something similar: 
  
  sum(top_species_by_country_2013$product_weight_t) # 5102744; we get ~5.1 million tonnes. They say that the "official IFFO figure is 4.8 million tonnes. So we are within an acceptable range I think! What does FAO report for 2013? 4.95 million tonnes
  
  test <- FAO_fm %>%
    filter(period == 2013) %>%
    pull(value) %>%
    sum() # 4945056
  
  ## ok lets look at trimmings vs whole fish amounts: Newton and jackson report 3.131 million tonnes from whole fish and 1.508 million tonnes from trimmings. We see that there is actually more from trimmings than whole fish... 
  
  top_species_by_country_2013 %>% filter(fishmeal_type == "whole fish") %>% pull(product_weight_t) %>% sum() # 2420112 whole fish
  top_species_by_country_2013 %>% filter(fishmeal_type == "trimmings") %>% pull(product_weight_t) %>% sum() # 2682632 trimmings


  ## lets look at just the chordata and cepholopods 
top_species_by_country_2013 %>% filter(fishmeal_type == "trimmings", phylum == "chordata"|class == "cephalopoda") %>% pull(product_weight_t) %>% sum() # 1550979 from trimmings 

top_species_by_country_2013 %>% filter(fishmeal_type == "whole fish", phylum == "chordata"|class == "cephalopoda") %>% pull(product_weight_t) %>% sum() # 2407542 from whole fish. Ok this is closer to what IFFO reports. Just less fishmeal overall.  


top_species_by_country_2013 %>% filter(phylum == "chordata"|class == "cephalopoda") %>% pull(product_weight_t) %>% sum() # 3958521 total products without shrimps/prawns


## OK: Results are very similar in the total amount of fishmeal produced compared to IFFO. But when looking at % breakdowns of trimmings vs whole fish, accounting for the same species and methods (arthropoda + chordata, 2009-2013 average). Not sure why this is the case? 
# For example: Newton and Jackson reports says they include crustaceans, squids/octopus, and finfish. If I apply the same methodology:
    # We get ~5.1 million tonnes compared to their 4.6 million tonnes total. This is in the range of uncertainty that is acceptable (they report official IFFO estimates of 4.8 million tonnes fishmeal)
    # We get ~2.4 million tonnes from whole fish vs their 3.1 million tonnes whole fish
    # We get ~2.7 million tonnes trimmings vs their 1.5 million tonnes trimmings.
    # So we are over estimating amount to trimmings compared to IFFO.
# HOWEVER, if we exclude any shrimp/prawn meal:
    # We get 3.95 million tonnes total vs their 4.6 million tonnes total. 
    # We get 2.4 million tonnes whole fish vs their 3.1 million tonnes whole fish
    # We get 1.5 million tonnes trimmings vs their 1.5 million tonnes trimmings
    # So excluding shrimp/prawn meal, we underestimate the total and whole fish meal, but are spot on with trimmings fishmeal. 	



region_order <- c("Europe", "Asia (exc China)", "China", "Africa", "South America", "North America", "Oceania", "Other nei", "Totals")


by_continent <- top_species_by_country %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  mutate(region = case_when(source_country_iso3c == "CHN" ~ "China",
                            owid_region == "Asia" & source_country_iso3c != "CHN" ~ "Asia (exc China)", 
                            is.na(owid_region) ~ "Other nei", 
                            TRUE ~ owid_region)) %>%
  group_by(region, fishmeal_type) %>%
  summarise(product_weight_t =  sum(product_weight_t, na.rm = TRUE)/1000) %>%
  ungroup() %>%
  pivot_wider(names_from = fishmeal_type, values_from = product_weight_t) %>%
  dplyr::select(region, whole_fish = `whole fish`, trimmings)


totals_row <- by_continent %>%
  summarise(region = "Totals",
            across(where(is.numeric), sum, na.rm = TRUE))



 by_continent <- bind_rows(by_continent, totals_row) %>%
  mutate(total =  whole_fish + trimmings) %>%
  mutate(perc_trim = trimmings/total*100) %>%
    mutate(region = factor(region, levels = region_order)) %>%
    arrange(region)
 
```
 
 
## Run high-level scenario of FM replacement with trimmings/divert forage fish to human consumption

To figure out: 
 - How much trimmings fishmeal could be created if BAU? I.e., we keep whole fish production going, but just utilise fillet trimmings to full extent. Could this extra trimmings FM make up for losses in whole fish reduction? 
 - How much trimmings fishmeal could be created if we directed all whole fish production FM to human consumption instead? Could this extra trimmings make up for losses in whole fish reduction?
 - How much extra human food would be created if we stopped whole fish production? Does this extra human food match the production amounts of fed aquaculture? 


How much trimmings fishmeal could be created if BAU? I.e., we keep whole fish production going, but just utilise fillet trimmings to full extent. Could this extra trimmings FM make up for losses in whole fish reduction? 

```{r}
# If a species is filleted and used as trimmings, then we will ultimately need to subtract that from the total we calculate. 

# Look at fillet data, determine how much of each filleted species is waste, assume all of that waste is used for fishmeal. 
extra_trimmings <- fillet_artis %>%
  left_join(artis_taxa) %>%
      mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
  mutate(processing_waste_t = live_weight_t - product_weight_t) %>%
  dplyr::select(-product_weight_t, -live_weight_t, -consumer_iso3c, -hs6) %>% 
  group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(processing_waste_t = sum(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    #trimmings_fm_t = processing_waste_t/2.975207, 
    processing_waste_t = processing_waste_t*0.96, # assuming 2% blood loss weight and 2% losses at primary fish processing stage
         fishmeal_type = "trimmings")

fillet_trim_2013 <- extra_trimmings %>%
  filter(year %in% c(2009:2013)) %>%
      group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
    summarise(
      processing_waste_t = sum(processing_waste_t, na.rm = TRUE)
    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
    summarise(
      processing_waste_t = mean(processing_waste_t, na.rm = TRUE)) %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(processing_waste_t = mean(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
    mutate(trimmings_fm_t = processing_waste_t/2.975207, 
         fishmeal_type = "trimmings")

sum(fillet_trim_2013$trimmings_fm_t) # 2475850 - 2.48 million tonnes; This is just additional fishmeal. Newton and Jackson say There is ~2.365 million unused by-product tonnes of fishmeal on average from 2009-2013. So we are exceeding them by ~200k tonnes. However, we need to subtract out the trimmings that we already include.
  
## do i need to use the top species data set i created? No since this is for yearly volumes.

fm_trim_df <- fm_data %>%
    mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda") %>%
    group_by(year, source_country_iso3c, exporter_iso3c, sciname, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
      live_weight_t = sum(live_weight_t)
    ) %>%
  ungroup() %>% 
  filter(fishmeal_type == "trimmings")


extra_trimmings_final <- extra_trimmings %>%
  left_join(., fm_trim_df) %>%
  mutate(product_weight_t = ifelse(is.na(product_weight_t), 0, product_weight_t)) %>%
    mutate(live_weight_t = ifelse(is.na(live_weight_t), 0, live_weight_t)) %>%
  mutate(unused_trimmings_t_lw = processing_waste_t - live_weight_t) %>%
mutate(unused_trimmings_t_lw = ifelse(unused_trimmings_t_lw < 0, 0, unused_trimmings_t_lw)) ## there are some negatives here... so we'll make these 0s; these are negatives because we might be overestimating the amount of trimmings from forage fisheries. But we can't have negative fishmeal so we'll just filter it out. 
  

extra_trimmings_2013 <- extra_trimmings_final %>%
  filter(year %in% c(2009:2013)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = sum(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = mean(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(unused_trimmings_t = unused_trimmings_t_lw/2.975)

  
sum(extra_trimmings_2013$unused_trimmings_t, na.rm = TRUE) # 2169336; pretty close; after accounting for what we already use

```

## Current day (2015 - 2019) scenarios 

```{r}
############## Look at 2015-2019 period now

extra_trimmings_2019 <- extra_trimmings_final %>% 
  filter(year %in% c(2015:2019)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = sum(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = mean(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(unused_trimmings_t = unused_trimmings_t_lw/2.975)

sum(extra_trimmings_2019$unused_trimmings_t, na.rm = TRUE) # 1857602

top_species_by_country_2019 %>% filter(fishmeal_type == "whole fish") %>% pull(product_weight_t) %>% sum() # 2113633

sum(extra_trimmings_2019$unused_trimmings_t, na.rm = TRUE)/2113633 # if we used fillet trimmings fully, that could cover ~88% of the demand


# If the reduction fisheries were instead re-allocated to human consumption, and their trimmings used for fish meal, AND fillet trimmings used fully, would this make up loss of whole fish-derived fishmeal? 

#### Look at only reductions fisheries SUITABLE for human consumption?
#### Will need to figure out %s of each fish species which are edible. We can figure this out by looking at the fillet data ARTIS provides.

fillet_conversion <- fillet_artis %>%
  filter(year %in% c(2015:2019)) %>%
  group_by(source_country_iso3c, sciname, year) %>%
  summarise(product_weight_t = sum(product_weight_t),
            live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>% 
    group_by(source_country_iso3c, sciname) %>%
  summarise(product_weight_t = mean(product_weight_t),
            live_weight_t = mean(live_weight_t)) %>%
  ungroup() %>% 
  mutate(processing_waste_t = live_weight_t - product_weight_t) %>%
  mutate(conversion = live_weight_t/product_weight_t) %>%
  group_by(source_country_iso3c, sciname) %>%
  summarise(conversion_fillet_mean = mean(conversion, na.rm = TRUE)) %>%
  ungroup()


top_species_by_country_2019 <- qs::qread(here("outputs/top_species_fm_2015_2019.qs"))

# this is the fishmeal that would be made from trimmings from redirecting forage fish to human consumption
extra_fillet_fishmeal <- top_species_by_country_2019 %>%
  left_join(fillet_conversion) %>%
  filter(phylum == "chordata") %>%
  group_by(sciname) %>%
  mutate(global_spp_conversion_mean = mean(conversion_fillet_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(global_conversion = mean(conversion_fillet_mean, na.rm = TRUE)) %>%
  mutate(conversion_fillet_final = ifelse(is.na(conversion_fillet_mean), global_spp_conversion_mean, conversion_fillet_mean)) %>%
    mutate(conversion_fillet_final = ifelse(is.na(conversion_fillet_final), global_conversion, conversion_fillet_final)) %>%
  dplyr::select(1:10, conversion_fillet_final) %>%
  filter(fishmeal_type != "trimmings") %>% # we only care about extra fm we could create from whole fish 
  mutate(fillet_weight = live_weight_t/conversion_fillet_final) %>%
  mutate(live_weight_for_extra_fm = (live_weight_t - fillet_weight)*0.96) %>% # i think we subtract out 4% from blood and processing loss here at the live weight section. Since the processing is at the primary fish processing stage (so liveweight stage). Hence the 0.96 multiplication
  mutate(extra_fm_weight = live_weight_for_extra_fm/2.975207)

sum(extra_fillet_fishmeal$extra_fm_weight) # 1387377 tonnes of fishmeal if we redirected all whole fish FM to human consumption

1387377 + 1857602 # 3244979 total fishmeal from utilising fillets trimmings and redirecting forage fish
top_species_by_country_2019 %>% filter(fishmeal_type == "whole fish") %>% pull(product_weight_t) %>% sum() # 2113633

3244979-2113633 # 1131346

sum(extra_fillet_fishmeal$fillet_weight) # 1960280 extra fillet tonnes

fillet_artis %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum()

1960280/3565793 # 0.5497459

# so if we fully utilised trimmings from fillets AND we redirected finfish whole fish fishmeal to human consumption, and used those trimmings for fishmeal, we could produce 3244979 tonnes of fish meal. This is 3244979 - 2113633 = 1131346 more tonnes than is currently demanded of whole fish derived fish meal! Would also produce 1960280 tonnes of fillets for human consumption. 


## lets try doing a full accounting now. We want unused trimmings (minus those already accounted for), trimmings produced from redirection to human consumption, and trimmings already produced

## how much fishmeal from non chordata wholefish? 
non_finfish_fm <- top_species_by_country_2019 %>% 
  filter(phylum != "chordata", fishmeal_type == "whole fish", product_weight_t > 0)
sum(non_finfish_fm$product_weight_t) # 9577.311

## fishmeal from trimmings already produced? 
top_species_by_country_2019 %>% filter(fishmeal_type == "trimmings") %>% pull(product_weight_t) %>% sum() # 3050683

# unused trimmings = 1857602
# redirected whole fish fillet trimmings = 1387377

1387377 + 1857602 + 3050683 + 9577.311 # 6305239 NEW TOTAL

sum(top_species_by_country_2019$product_weight_t)
# OLD TOTAL = 5164316

6305239 - 5164316 # WOULD BE PRODUCING 1140923 more tonnes than before
  
## what about if we fully utilised trimmings from shrimp/prawn aquaculture production? This assumes that all shrimp would be de-headed, de-shelled, and de-tailed. 

aqua_prod <- read.csv(file.path(rdsi_raw_data_dir, "fao/FAO_fishstat_2020/global_aquaculture_production_1950_2020.csv")) %>%
  clean_names() %>%
    rename(country= country_name,
         common_name = asfis_species_name,
         area = fao_major_fishing_area_name,
         environment = environment_name) %>% 
   dplyr::select(-unit_name, -asfis_species_name_1, -fao_major_fishing_area_code) %>% 
  mutate(common_name = tolower(common_name)) %>%
  dplyr::select(-c(starts_with("s_"))) %>% 
  dplyr::select(-s) %>%
        pivot_longer(names_to = "year", values_to = "value", cols = -c(country, common_name, area, environment, unit)) %>% 
      mutate(iso3c = countrycode(country, origin = "country.name", destination = "iso3c", warn = TRUE)) %>%
      mutate(iso3c = case_when(country == "Zanzibar" ~ "TZA",
                               country == "CuraÃƒÂ§ao" ~ "CUW",
                               country == "RÃƒÂ©union" ~ "REU", 
                               country == "TÃƒÂ¼rkiye" ~ "TUR",
                                TRUE ~ iso3c))  %>%
  filter(country != "FAO. 2022. Fishery and Aquaculture Statistics. Global aquaculture production 1950-2020 (FishStatJ). In: FAO Fisheries and Aquaculture Division [online]. Rome. Updated 2022. www.fao.org/fishery/statistics/software/fishstatj/en") %>%
  mutate(year = as.numeric(str_remove_all(year, "x_")))
 
  
## FAO says that yield of raw meat is ~45%; we'll apply this for now https://www.fao.org/4/x5931e/x5931e01.htm
## so trimmings yield would be 55% of the liveweight
shrimp_prod <- aqua_prod %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
  filter(year %in% c(2015:2019),
         value > 0) %>%
  mutate(trim_lw = value*0.55) %>%
#  mutate(trim_product_t = trim_lw/2.975) %>%
  dplyr::select(source_country_iso3c = iso3c, common_name, year, trim_lw) %>%
  mutate(fishmeal_type = "trimmings")




fm_trim_df <- fm_data %>%
    mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda") %>%
    group_by(year, source_country_iso3c, common_name, fishmeal_type) %>%
    summarise(
      live_weight_t = sum(live_weight_t)
    ) %>%
  ungroup() %>% 
  filter(fishmeal_type == "trimmings")

extra_shrimp_trim <- shrimp_prod %>%
  left_join(., fm_trim_df) %>%
    mutate(live_weight_t = ifelse(is.na(live_weight_t), 0, live_weight_t)) %>%
  mutate(unused_trimmings_t_lw = trim_lw - live_weight_t) %>%
mutate(unused_trimmings_t_lw = ifelse(unused_trimmings_t_lw < 0, 0, unused_trimmings_t_lw)) ## there are some negatives here... so we'll make these 0s; these are negatives because we might be overestimating the amount of trimmings from forage fisheries. But we can't have negative fishmeal so we'll just filter it out. 
  

extra_shrimp_trim_2019 <- extra_shrimp_trim %>%
  filter(year %in% c(2015:2019)) %>%
    group_by(year, source_country_iso3c, common_name) %>%
  summarise(unused_trimmings_t_lw = sum(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c, common_name) %>%
  summarise(unused_trimmings_t_lw = mean(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(unused_trimmings_t = unused_trimmings_t_lw/2.975)

sum(extra_shrimp_trim_2019$unused_trimmings_t) # 400716.4



1387377 + 1857602 + 3050683 + 9577.311 + 400716.4 # 6705956 NEW TOTAL

# OLD TOTAL = 5164316

6705956 - 5164316 # WOULD BE PRODUCING 1541640 more tonnes than before
```


```{r}
reduction_fisheries <- fm_data %>%
  filter(common_name %in% c("anchoveta(=peruvian anchovy)", "european pilchard(=sardine)", "blue whiting(=poutassou)", "chilean jack mackerel"),
         year == 2020) %>% 
  group_by(sciname, common_name, year) %>%
  summarise(live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup()
sum(reduction_fisheries$live_weight_t)/2.97


# from fishbase,  the W = aL^b
## for peruvian anchovy: W = 0.000457*L^3.13; average length at maturity is 12 cm

anchovy_weight = 0.00457*(12^3.13) # = 10.90821 grams
pilchard_weight = 0.00631*(14.8**3.08) # 25.37672 grams
blue_whiting_weight = 0.00417*(15**3.12) # 19.47784
chljackmack_weight = 0.01202*(40.5**2.93) # 616.2369
 
 
```



Does the increase in shrimp meal correlate with shrimp aquaculture increase?

Did oyster aquaculture production ever recover after 2013 in China? 

```{r}
## read in aquaculture production data

aqua_prod <- read.csv(file.path(rdsi_raw_data_dir, "fao/FAO_fishstat_2020/global_aquaculture_production_1950_2020.csv")) %>%
  clean_names() %>%
    rename(country= country_name,
         common_name = asfis_species_name,
         area = fao_major_fishing_area_name,
         environment = environment_name) %>% 
   dplyr::select(-unit_name, -asfis_species_name_1, -fao_major_fishing_area_code) %>% 
  mutate(common_name = tolower(common_name)) %>%
  dplyr::select(-c(starts_with("s_"))) %>% 
  dplyr::select(-s) %>%
        pivot_longer(names_to = "year", values_to = "value", cols = -c(country, common_name, area, environment, unit)) %>% 
      mutate(iso3c = countrycode(country, origin = "country.name", destination = "iso3c", warn = TRUE)) %>%
      mutate(iso3c = case_when(country == "Zanzibar" ~ "TZA",
                               country == "CuraÃƒÂ§ao" ~ "CUW",
                               country == "RÃƒÂ©union" ~ "REU", 
                               country == "TÃƒÂ¼rkiye" ~ "TUR",
                                TRUE ~ iso3c))  %>%
  filter(country != "FAO. 2022. Fishery and Aquaculture Statistics. Global aquaculture production 1950-2020 (FishStatJ). In: FAO Fisheries and Aquaculture Division [online]. Rome. Updated 2022. www.fao.org/fishery/statistics/software/fishstatj/en") %>%
  mutate(year = as.numeric(str_remove_all(year, "x_")))
 
  

shrimp_prod <- aqua_prod %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
  filter(year %in% c(1996:2020)) %>%
  group_by(year) %>% 
  summarise(tonnes = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)

overall_increase <- shrimp_prod %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 659% increase

avg_annual_increase <- shrimp_prod %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 8.81% average yearly increase 


ggplot(shrimp_prod, aes(x = year, y = tonnes)) + 
  geom_line()


  
shrimp_fm <- fm_data_top_spp %>%
  filter(phylum == "arthropoda") %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
    group_by(year) %>% 
  summarise(tonnes = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)



overall_increase <- shrimp_fm %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 441% increase

avg_annual_increase <- shrimp_fm %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 7.69% average yearly increase 



oyster_prod <- aqua_prod %>%
 # filter(str_detect(common_name, "oyster|Oyster")) %>%
  filter(year %in% c(1996:2020), iso3c == "CHN") %>%
  group_by(year) %>% 
  summarise(tonnes = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)

overall_increase <- oyster_prod %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 200% increase

avg_annual_increase <- oyster_prod %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 4.69% average yearly increase 



mollusc_time <- fm_data_top_spp %>%
  filter(phylum == "mollusca", source_country_iso3c == "CHN") %>%
  filter(str_detect(common_name, "oyster")) %>%
  group_by(year) %>%
  summarise(product_t = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_type = "Molluscs") 


## look at finfish over time, see if the reduction in 2010 was peruvian anchoveta


finfish_time <- fm_data %>%
  filter(phylum == "chordata", common_name == "anchoveta(=peruvian anchovy)") %>%
  group_by(year, common_name) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup()  %>%
  filter(year %in% c(2009:2010))

# 17% decrease in peruvian anchoveta 2009 - 2010

finfish_time <- fm_data %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  filter(phylum == "chordata",
         owid_region == "South America") %>%
  group_by(year, common_name) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  filter(tonnes > 1000) %>%
  filter(year %in% c(2009:2010)) %>%
  arrange(common_name, year) %>%
  group_by(common_name) %>%
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100) # -38.2407252% decrease in South America, matches global decrease 


finfish_time <- fm_data %>%
  filter(phylum == "chordata") %>%
  group_by(year) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)
# 38.0034010% decrease all species globally

```


```{r}
# library(tidyverse)
# library(here)
# library(janitor)
# 
# test <- read.csv(here("outputs/Book1.csv")) %>%
#   clean_names() %>%
#   filter(!is.na(station))
# 
# ggplot(test, aes(x = ln_no3, y = n_isotopic_composition_of_nitrate_d15nno3)) +
#   geom_point() + 
#   geom_line() + 
#   facet_wrap(~station) +
#   geom_smooth()
# 
# 
# slopes <- test %>%
#   group_by(station) %>%
#   summarize(slope = coef(lm(n_isotopic_composition_of_nitrate_d15nno3 ~ ln_no3, data = cur_data()))[2]) 
# 
# # Plot with slopes annotated
# ggplot(test, aes(x = ln_no3, y = n_isotopic_composition_of_nitrate_d15nno3)) +
#   geom_point() + 
#   geom_line() +
#   geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add regression line
#   facet_wrap(~station) +
#   geom_text(data = slopes, aes(x = Inf, y = -Inf, label = paste0("Slope: ", round(slope, 2))), 
#             hjust = 1.4, vjust = -1.4, inherit.aes = FALSE)
```


