---
title: "Explore scenario analysis"
output: html_document
date: "2024-11-25"
editor_options: 
  chunk_output_type: console
---

## Summary

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(qs)
library(scales)
library(viridis)
library(dplyr)

source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

fillet_artis <- full_artis %>%
  filter(hs6 != 230120) %>%
  dplyr::select(-hs_version) %>% # don't need this
  rename(consumer_iso3c = importer_iso3c) # just to make things consistent

artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) %>% ## read in attribute table with common names
  mutate(phylum = case_when(
    common_name %in% c("mackerels, tunas, and bonitos", "salmons and trouts", "herrings", "cartilaginous fishes nei", "flounders", "african lungfishes", "toothfish", "carps, minnows, loaches, etc", "blue whitings") ~ "chordata",
    TRUE ~ phylum
  )) # fix phylum mistakes
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

fm_data <-   qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_gf_final.qs")) %>%
  left_join(artis_taxa)

```

Figure 1: 
Trends from 1996-2020 split by phylum

```{r}
all_spp_time <- fm_data %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "All species")

finfish_time <- fm_data %>%
  filter(phylum == "chordata") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Finfish") 

crust_time <- fm_data %>%
  filter(phylum == "arthropoda") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Crustaceans") 

mollusc_time <- fm_data %>%
  filter(phylum == "mollusca") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Molluscs") 

overtime_all <- rbind(all_spp_time, finfish_time, crust_time, mollusc_time) %>%
  mutate(perc = scales::percent(round(prop, 2), accuracy = 1))

artis_palette(length(unique(overtime_all$fishmeal_type)))

ggplot(overtime_all, aes(x = year, y = product_t, color = fishmeal_type)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~data_type, scales = "free_x") + 
  labs(x = "Year", y = "Fishmeal product (tonnes)", color = "Fishmeal type") + 
    scale_color_manual(values = c("trimmings" = "#741A32", "whole fish" = "#114F59"), 
                     labels = c("Trimmings-derived", "Whole fish-derived")) + 
  scale_x_continuous(limits = c(1994.5, 2021.5), breaks = c(1996, 2002, 2008, 2014, 2020), 
                     labels = c(1996, 2002, 2008, 2014, 2020)) +
  theme(legend.position = "bottom") +
    geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "trimmings", data_type != "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "whole fish", data_type != "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year %in% c(2020), fishmeal_type == "trimmings", data_type == "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0.5, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "whole fish", data_type == "Molluscs"),
            aes(x = year, y = product_t, label = perc),
            vjust = -0.5, hjust = -0.1, show.legend = FALSE, size = 3) + 
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "trimmings", data_type != "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "whole fish", data_type != "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
        geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "trimmings", data_type == "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "whole fish", data_type == "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0.5, hjust = 1, show.legend = FALSE, size = 3) 



ggsave(here("outputs/figs/MS/Figure_1_time.png"), width = 180, height =180 , units = "mm", bg = "white", dpi =300)


```

Does the increase in shrimp meal correlate with shrimp aquaculture increase?

Did oyster aquaculture production ever recover after 2013 in China? 

```{r}
## read in aquaculture production data

aqua_prod <- read.csv(file.path(rdsi_raw_data_dir, "fao/FAO_fishstat_2020/global_aquaculture_production_1950_2020.csv")) %>%
  clean_names() %>%
    rename(country= country_name,
         common_name = asfis_species_name,
         area = fao_major_fishing_area_name,
         environment = environment_name) %>% 
   dplyr::select(-unit_name, -asfis_species_name_1, -fao_major_fishing_area_code) %>% 
  mutate(common_name = tolower(common_name)) %>%
  dplyr::select(-c(starts_with("s_"))) %>% 
  dplyr::select(-s) %>%
        pivot_longer(names_to = "year", values_to = "value", cols = -c(country, common_name, area, environment, unit)) %>% 
      mutate(iso3c = countrycode(country, origin = "country.name", destination = "iso3c", warn = TRUE)) %>%
      mutate(iso3c = case_when(country == "Zanzibar" ~ "TZA",
                               country == "CuraÃ§ao" ~ "CUW",
                               country == "RÃ©union" ~ "REU", 
                               country == "TÃ¼rkiye" ~ "TUR",
                                TRUE ~ iso3c))  %>%
  filter(country != "FAO. 2022. Fishery and Aquaculture Statistics. Global aquaculture production 1950-2020 (FishStatJ). In: FAO Fisheries and Aquaculture Division [online]. Rome. Updated 2022. www.fao.org/fishery/statistics/software/fishstatj/en") %>%
  mutate(year = as.numeric(str_remove_all(year, "x_")))
 
  

shrimp_prod <- aqua_prod %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
  filter(year %in% c(1996:2020)) %>%
  group_by(year) %>% 
  summarise(tonnes = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)

overall_increase <- shrimp_prod %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 659% increase

avg_annual_increase <- shrimp_prod %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 8.81% average yearly increase 


ggplot(shrimp_prod, aes(x = year, y = tonnes)) + 
  geom_line()


  
shrimp_fm <- fm_data %>%
  filter(phylum == "arthropoda") %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
    group_by(year) %>% 
  summarise(tonnes = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)



overall_increase <- shrimp_fm %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 441% increase

avg_annual_increase <- shrimp_fm %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 7.28% average yearly increase 



oyster_prod <- aqua_prod %>%
 # filter(str_detect(common_name, "oyster|Oyster")) %>%
  filter(year %in% c(1996:2020), iso3c == "CHN") %>%
  group_by(year) %>% 
  summarise(tonnes = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)

overall_increase <- oyster_prod %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 200% increase

avg_annual_increase <- oyster_prod %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 4.69% average yearly increase 



mollusc_time <- fm_data %>%
  filter(phylum == "mollusca", source_country_iso3c == "CHN") %>%
  filter(str_detect(common_name, "oyster")) %>%
  group_by(year) %>%
  summarise(product_t = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_type = "Molluscs") 


## look at finfish over time, see if the reduction in 2010 was peruvian anchoveta


finfish_time <- fm_data %>%
  filter(phylum == "chordata", common_name == "anchoveta(=peruvian anchovy)") %>%
  group_by(year, common_name) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup()  %>%
  filter(year %in% c(2009:2010))

# 17% decrease in peruvian anchoveta 2009 - 2010

finfish_time <- fm_data %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  filter(phylum == "chordata",
         owid_region == "South America") %>%
  group_by(year, common_name) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  filter(tonnes > 1000) %>%
  filter(year %in% c(2009:2010)) %>%
  arrange(common_name, year) %>%
  group_by(common_name) %>%
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100) # -38.2407252% decrease in South America, matches global decrease 


finfish_time <- fm_data %>%
  filter(phylum == "chordata") %>%
  group_by(year) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)
# 38.0034010% decrease all species globally

```



Trade flows:

```{r}

library(exploreARTIS)


  # Create a simplified trade flow visualization
  trade_flows <- fm_data %>%
    filter(year == 2020) %>%
    group_by(source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/sum(product_weight_t))

  plot_sankey(trade_flows %>% filter(fishmeal_type == "whole fish"), cols = c("phylum", "source_country_iso3c", "importer_iso3c"), prop_flow_cutoff = 0.03, value = "product_weight_t") 
  
    plot_sankey(trade_flows %>% filter(fishmeal_type == "trimmings"), cols = c("phylum", "source_country_iso3c", "importer_iso3c"), prop_flow_cutoff = 0.03, value = "product_weight_t") 
    
      plot_sankey(trade_flows %>% filter(fishmeal_type == "whole fish"), cols = c("phylum", "source_country_iso3c", "importer_iso3c"), prop_flow_cutoff = 0.03, value = "product_weight_t") 
  
    plot_sankey(trade_flows, cols = c("phylum", "fishmeal_type", "importer_iso3c"), prop_flow_cutoff = 0.025, value = "product_weight_t") 
  
  trade_flows_2 <- filter(trade_flows, exporter_iso3c != importer_iso3c)
  
  plot_map(trade_flows_2 %>% filter(fishmeal_type == "whole fish"), country_fill = "importer_iso3c", flow_arrows = TRUE, arrow_label = "Trade (product t)", fill_label = "Import (product t)", value = "product_weight_t")
  
    plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"), country_fill = "importer_iso3c", flow_arrows = TRUE, arrow_label = "Trade (product t)", fill_label = "Import (product t)", value = "product_weight_t")
  
    
      plot_map(trade_flows_2 %>% filter(fishmeal_type == "whole fish", phylum == "chordata"), country_fill = "importer_iso3c", flow_arrows = TRUE, arrow_label = "Trade (product t)", fill_label = "Import (product t)", value = "product_weight_t")
  
    plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings", phylum == "chordata"), country_fill = "importer_iso3c", flow_arrows = TRUE, arrow_label = "Trade (product t)", fill_label = "Import (product t)", value = "product_weight_t")
  
    
  trade_flows_3 <- fm_data %>%
    filter(year == 2020) %>%
    group_by(importer_iso3c = consumer_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) 
  
    trade_flows_3 <- fm_data %>%
    filter(year == 2020, source_country_iso3c != consumer_iso3c) %>%
    group_by(importer_iso3c = consumer_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) 
    
    
        
  trade_flows_4 <- fm_data %>%
    filter(year == 2020) %>%
    group_by(source_country_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) 

  
  
    trade_flows_4 <- fm_data %>%
    filter(year == 2020) %>%
    group_by(common_name, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) 
    
    
    
    
plot_bar(trade_flows_4,
        bar_group = "common_name",
        fill_type = "fishmeal_type", 
        value = "product_weight_t", 
        top_n = 15)

tonnes_2020 <- fm_data %>% 
  filter(year == 2020) %>%
  pull(product_weight_t) %>%
  sum()


  trade_flows <- fm_data %>%
    filter(year == 2020) %>%
    group_by(source_country_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/tonnes_2020)

  
# Summary
# Countries using the most trimmings fishmeal
## China (~1.5 million tonnes, 24% of global fishmeal), Indonesia (412k tonnes, 6.6% of global fishmeal), Vietnam (213k tonnes, 3.4% of global fishmeal), India (464k tonnes, 2.5% of global FM), Japan (364k tonnes, 1.9% global fishmeal), Taiwan(71k, 1.1%), Turkey (65k, 1%), Greece (55k, 0.09%) Norway (48k, 0.08%)
# Countries using the most whole fish fishmeal
## China (1.48 million tonnes, 23% of global FM), Indonesia (162k, 2.6%), Japan (149k, 2.4%), India (115k, 1.8%), Norway (112k, 1.8%) 
# Who imports the most trimmings or whole fish, does not include domestic production
# Trimmings
## China (472k tonnes, 7.6% of global FM), Indonesia (80k tonnes, 1.3%), Japan (78k tonnes, 1.25%)
# Whole fish
## China (902k tonnes, 14.5% of global FM), Japan (126k tonnes, 2%), Norway (87k tonnes, 1.4%), Turkey (83k tonnes, 1.3%)
# Who produces the most trimmings or whole fish
# Whole fish
## Peru (756k tonnes, 12%), China (604k tonnes, 10%), Chile (227k tonnes, 3.6%), Indonesia (131k tonnes, 2.1%), Denmark (117k tonnes, 1.9%)
# Trimmings
## China (1.04 million tonnes, 17%), Indonesia (345k tonnes, 5.5%), Vietnam (255k tonnes, 4.1%), India (165k tonnes, 2.6%), Thailand (114k tonnes, 1.8%)


```


Species summary 

```{r}
  
  # Species summary
  species_summary <- fm_data %>%
  filter(year == 2020) %>%
    group_by(sciname, common_name, source_country_iso3c, fishmeal_type) %>%
    summarise(
      total_product_weight = sum(product_weight_t, na.rm = TRUE)
    ) %>%
    arrange(desc(total_product_weight))

```


 
To figure out: 
 - How much trimmings fishmeal could be created if BAU? I.e., we keep whole fish production going, but just utilise fillet trimmings to full extent. Could this extra trimmings FM make up for losses in whole fish reduction? 
 - How much trimmings fishmeal could be created if we directed all whole fish production FM to human consumption instead? Could this extra trimmings make up for losses in whole fish reduction?
 - How much extra human food would be created if we stopped whole fish production? Does this extra human food match the production amounts of fed aquaculture? 


How much trimmings fishmeal could be created if BAU? I.e., we keep whole fish production going, but just utilise fillet trimmings to full extent. Could this extra trimmings FM make up for losses in whole fish reduction? 

```{r}

# If a species is filleted and used as trimmings, then we will ultimately need to subtract that from the total we calculate. 

# Look at fillet data, determine how much of each filleted species is waste, assume all of that waste is used for fishmeal. 

## what sort of liveweight conversions is she using for filleted species?
test <- fillet_artis %>%
  filter(year == 2020) %>%
  mutate(conversion = live_weight_t/product_weight_t) # seems like there are some species and region specific conversions here
## I think that we can just subtract the liveweight and product weight for each fillet, and that will give us the processing waste weight. Then we take the processing waste weight and apply the 2.97 conversion that ARTIS uses to convert to FM. Easy. Obviously this is just a first pass and very simple.

extra_trimmings <- fillet_artis %>%
  mutate(processing_waste_t = live_weight_t - product_weight_t) %>%
  dplyr::select(-product_weight_t, -live_weight_t, -consumer_iso3c, -hs6) %>% 
  group_by(year, source_country_iso3c, exporter_iso3c, sciname, habitat, method) %>%
  summarise(processing_waste_t = sum(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(trimmings_fm_t = processing_waste_t/2.975207, 
         fishmeal_type = "trimmings")

test <- extra_trimmings %>%
  filter(year %in% c(2009:2013)) %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname, habitat, method) %>%
  summarise(processing_waste_t = mean(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(trimmings_fm_t = processing_waste_t/2.975207)

sum(test$trimmings_fm_t) # 2611612 - 2.61 million tonnes; This is just additional fishmeal (probably, we will need to match to ARTIS fishmeal data and subtract any trimmings from that out). Newton and Jackson say There is ~2.365 million unused by-product tonnes of fishmeal on average from 2009-2013. So we are exceeding them by ~300k tonnes (without accounting for trimmings we already see in data...). If we account for what we already have in the ARTIS data, this number will come down. 


# from newton and jackson for TOTAL AMOUNT OF FISHMEAL:  "If all fish were processed and all the by-product collected it is estimated that globally there would be around 36 million tonnes of raw material available producing about 9.5 million tonnes of fishmeal and 1.5 million tonnes of fish oil."
  
fm_trim_df <- fm_data %>%
  filter(fishmeal_type == "trimmings") %>%
  group_by(year, source_country_iso3c, exporter_iso3c, sciname, habitat, method) %>%
  summarise(product_weight_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup()


extra_trimmings_final <- extra_trimmings %>%
  left_join(., fm_trim_df) %>%
  mutate(product_weight_t = ifelse(is.na(product_weight_t), 0, product_weight_t)) %>%
  mutate(unused_trimmings_t = trimmings_fm_t - product_weight_t) %>%
mutate(unused_trimmings_t = ifelse(unused_trimmings_t < 0, 0, unused_trimmings_t)) ## there are some negatives here... so we'll make these 0s; these are negatives because we might be overestimating the amount of trimmings from forage fisheries
  

test <- extra_trimmings_final %>%
  filter(year %in% c(2009:2013)) %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname, habitat, method) %>%
  summarise(unused_trimmings_t = mean(unused_trimmings_t, na.rm = TRUE)) %>%
  ungroup()

sum(test$unused_trimmings_t, na.rm = TRUE) # 2308605; ALMOST EXACTLY LOL; after accounting for what we already use


test_2020 <- extra_trimmings_final %>%
  filter(year == 2020)
sum(test_2020$unused_trimmings_t, na.rm = TRUE) # 1697655

wholefish_tonnes_2020 <- fm_data %>%
  filter(year == 2020, fishmeal_type == "whole fish") %>%
  pull(product_weight_t) %>%
  sum() # 2905354


test <- extra_trimmings %>%
  filter(year %in% c(2020)) %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname, habitat, method) %>%
  summarise(processing_waste_t = mean(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(trimmings_fm_t = processing_waste_t/2.975207)

sum(test$trimmings_fm_t)/2905354 # if we used fillet trimmings fully, that could cover ~2/3s of the demand

## IFFO reports that ~33% FM for the 2009-2013 average period is from trimmings
test2 <- fm_data %>%
  left_join(artis_taxa) %>%
 # filter(phylum == "chordata"|phylum == "arthropoda"& method == "aquaculture" |str_detect(common_name, "squid|octop")|sciname == "actinopterygii"|sciname == "animalia") %>%
  filter(year %in% c(2009:2013)) %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_weight_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(fishmeal_type) %>%
  summarise(product_weight_t = mean(product_weight_t, na.rm = TRUE)) %>%
  ungroup() # we get 0.3590324 ~36%, so pretty close. 


# If the reduction fisheries were instead re-allocated to human consumption, and their trimmings used for fish meal, AND fillet trimmings used fully, would this make up loss of whole fish-derived fishmeal? 

#### Look at only reductions fisheries SUITABLE for human consumption
#### Don't include any possible trash fish 
#### Will need to figure out %s of each fish species which are edible (look at allocation proportions?)
#### lets start easy with peruvian anchoveta, european pilchard, blue whiting, chilean jack mackerel


reduction_fisheries <- fm_data %>%
  filter(common_name %in% c("anchoveta(=peruvian anchovy)", "european pilchard(=sardine)", "blue whiting(=poutassou)", "chilean jack mackerel"),
         year == 2020) %>% 
  group_by(sciname, common_name, year) %>%
  summarise(live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup()
sum(reduction_fisheries$live_weight_t)/2.97


# from fishbase,  the W = aL^b
## for peruvian anchovy: W = 0.000457*L^3.13; average length at maturity is 12 cm

anchovy_weight = 0.00457*(12^3.13) # = 10.90821 grams
pilchard_weight = 0.00631*(14.8**3.08) # 25.37672 grams
blue_whiting_weight = 0.00417*(15**3.12) # 19.47784
chljackmack_weight = 0.01202*(40.5**2.93) # 616.2369
 
## now we have average weights for the fish live

## need to determine % that is edible. For anchoby, pilchard, blue whiting, the only edible part will be its body including bones since we will probably assume canning (not heads or tails). Chilean jack mackerel can be filleted I bet? 

# look at ARTIS fillet data and see if any of these are filleted. Maybe we can sus out the weight difference from that. 

fillet_test <- fillet_artis %>%
  left_join(artis_taxa) %>%
  filter(common_name %in% c("anchoveta(=peruvian anchovy)", "european pilchard(=sardine)", "blue whiting(=poutassou)", "chilean jack mackerel")) %>%
  mutate(prop_fillet = product_weight_t/live_weight_t) %>%
  group_by(common_name) %>%
  summarise(avg_prop_fillet = mean(prop_fillet)) %>%
  ungroup()


reduction_fisheries_fillet <- reduction_fisheries %>%
  left_join(fillet_test) %>%
  mutate(fillet_weight = avg_prop_fillet*live_weight_t) %>%
  mutate(live_weight_for_trimmings = live_weight_t - fillet_weight) %>%
  mutate(product_weight_trimmings = live_weight_for_trimmings/2.97)

 sum(reduction_fisheries_fillet$product_weight_trimmings) # [1] 960952.4 - so if we took all of the FM from those 4 main species and made it into fillets and used trimmings for fishmeal, we would end up with 961k tonnes of fish meal. This is compared to the 1396089 tonnes doing it normally. How do we make up the 435k tonnes missing? 
 
 
 
```



