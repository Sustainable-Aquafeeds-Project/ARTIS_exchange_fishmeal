---
title: "Explore scenario analysis"
output: html_document
date: "2024-11-25"
editor_options: 
  chunk_output_type: console
---

## Summary

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(qs)
library(scales)
library(viridis)
library(dplyr)
library(exploreARTIS)
library(patchwork)
library(ggsankey)
library(stringr)


source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

fillet_artis <- full_artis %>%
  filter(hs6 != 230120) %>%
  dplyr::select(-hs_version) %>% # don't need this
  rename(consumer_iso3c = importer_iso3c) # just to make things consistent

artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) %>% ## read in attribute table with common names
  mutate(phylum = case_when(
    common_name %in% c("mackerels, tunas, and bonitos", "salmons and trouts", "herrings", "cartilaginous fishes nei", "flounders", "african lungfishes", "toothfish", "carps, minnows, loaches, etc", "blue whitings") ~ "chordata",
    TRUE ~ phylum
  )) # fix phylum mistakes
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

fm_data <-   qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_gf_final.qs")) %>%
  left_join(artis_taxa)

```

Adjust fishmeal data to include production and blood losses for trimmings weight

 - [Cao et al 2015](https://www.science.org/doi/10.1126/science.1260149): "We assume a median production yield for whole raw fish of 40% and a 2% flesh loss due to spoilage and other technical reasons." 
 - [Stevens et al. 2017](https://www.sciencedirect.com/science/article/pii/S0308597X17305328?via%3Dihub) referring to Atlantic Salmon: "For example, BPs in the form of trimmings represent a 2% yield of the whole fish"
 - [Sandstrom et al. 2022](https://www.nature.com/articles/s43016-022-00589-6): "The amounts of potential fish by-products were estimated by multiplying the amounts of fish for human consumption from capture fisheries and aquaculture by the ratios processed75,76 and multiplying the processed quantities by the average ratio of 41.5% of fish consisting of by-products (such as trimmings)79, subtracting 2% blood that is not used in reduction and finally assuming 2% losses at the primary fish processing stage"; 41.5% and 2% blood loss is based on Atlantic salmon, and the 2% processing is from Cao et al.
 
Based on this, we will assume that for finfish and non-bilvalve molluscs (i.e. squids and octopus), a 2% blood loss and 2% processing loss, everything else (namely shrimp/prawns) just a 2% processing loss (since they don't have blood). We are currently using an ~34% yield (i.e. 34% of the liveweight fish ends up rendered down to fishmeal) (this is the yield from ARTIS)


```{r}
fm_data_adjusted <- fm_data %>%
      mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda") | phylum == "mollusca" & class == "cephalopoda") %>%
    mutate(trimmings = live_weight_t*trim_prop_gf,
         wholefish = live_weight_t*(1-trim_prop_gf)) %>%
  dplyr::select(-product_weight_t, -live_weight_t, -capture) %>%
  pivot_longer( 
    cols = c(trimmings, wholefish),
    names_to = "fishmeal_type",
    values_to = "live_weight_t"
  ) %>%
  mutate(live_weight_t =
           case_when(
             phylum == "arthropoda" & fishmeal_type == "trimmings" ~ live_weight_t*0.98,
             phylum %in% c("mollusca", "chordata") & fishmeal_type == "trimmings" ~ live_weight_t*0.96,
             TRUE ~ live_weight_t
           )) %>%
  mutate(product_weight_t = live_weight_t/2.975207)

qs::qsave(fm_data_adjusted, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_adjusted_final_21-07-2025.qs"))

test <- fm_data_adjusted %>%
  filter(year == 2020, 
         sciname == "engraulis ringens")

```

Save a file for top 20 contributing species per country for average years 2009-2013 (to match IFFO newton & jackson) and 2015-2019 (for latest years, excluding covid)

```{r}

  trade_flows_average <- fm_data_adjusted %>%
    filter(year %in% c(2009:2013)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = mean(product_weight_t, na.rm = TRUE),
            live_weight_t = mean(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup()
  
  sum(trade_flows_average$product_weight_t) # 5442000 makes sense
  
  
  top_species_by_country <- trade_flows_average %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>%
  ungroup() %>%
  right_join(trade_flows_average, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) 
  
  sum(top_species_by_country$product_weight_t) # 4952253 ; should be less and it is

  ## save
  qs::qsave(top_species_by_country, here("outputs/top_species_fm_2009_2013.qs"))
  
  
  ## now do the same for 2015-2019
  
  
    trade_flows_average <- fm_data_adjusted %>%
    filter(year %in% c(2015:2019)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = mean(product_weight_t, na.rm = TRUE),
            live_weight_t = mean(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup()
  
  sum(trade_flows_average$product_weight_t) # 5456924 makes sense
  
  
  top_species_by_country <- trade_flows_average %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>%
  ungroup() %>%
  right_join(trade_flows_average, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) 
  
  sum(top_species_by_country$product_weight_t) # 5000665 ; should be less and it is

  ## save
  qs::qsave(top_species_by_country, here("outputs/top_species_fm_2015_2019.qs"))
  
  
  
## Now lets save a 2009-2013 dataset WITH molluscs included and see what we get
  
trade_flows_average <-  fm_data %>%
      mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
    filter(phylum %in% c("chordata", "arthropoda", "mollusca")) %>%
    mutate(trimmings = live_weight_t*trim_prop_gf,
         wholefish = live_weight_t*(1-trim_prop_gf)) %>%
  dplyr::select(-product_weight_t, -live_weight_t, -capture) %>%
  pivot_longer( 
    cols = c(trimmings, wholefish),
    names_to = "fishmeal_type",
    values_to = "live_weight_t"
  ) %>%
  mutate(live_weight_t =
           case_when(
             phylum == "arthropoda" & fishmeal_type == "trimmings" ~ live_weight_t*0.98,
             phylum %in% c("mollusca", "chordata") & fishmeal_type == "trimmings" ~ live_weight_t*0.96,
             TRUE ~ live_weight_t
           )) %>%
  mutate(product_weight_t = live_weight_t/2.975207) %>%
       filter(year %in% c(2009:2013)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = mean(product_weight_t, na.rm = TRUE),
            live_weight_t = mean(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup()
  
  sum(trade_flows_average$product_weight_t) # 7486643 makes sense
  
  
  top_species_by_country <- trade_flows_average %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>%
  ungroup() %>%
  right_join(trade_flows_average, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) 
  
  sum(top_species_by_country$product_weight_t) # 6811738 

  ## save
  qs::qsave(top_species_by_country, here("outputs/top_species_fm_2009_2013_inc_molluscs.qs"))
```


Figure 1: 
Trends from 1996-2020 split by phylum; 
 - we don't read in the data we've saved before because we want to see the actual yearly change. 
 - NOTE: should i calculate a 5 year rolling average for every year? I.e., 2009 = 2005-2009 average, 2010 = 2006-2010 average, etc. 

```{r}

fm_data_top_spp <- fm_data_adjusted %>%
    group_by(year, source_country_iso3c, exporter_iso3c, importer_iso3c = consumer_iso3c, sciname, common_name, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    ungroup() %>%
  group_by(source_country_iso3c, sciname) %>% 
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  arrange(source_country_iso3c, desc(total_product_weight)) %>%
  group_by(source_country_iso3c) %>%
  slice_head(n = 20) %>% # take the top 20 specices for each source country (and year?)
  ungroup() %>%
  right_join(fm_data_adjusted, by = c("source_country_iso3c", "sciname")) %>%
    filter(!is.na(total_product_weight)) %>%
    left_join(artis_taxa) # this takes awhile to run

qs::qsave(fm_data_top_spp, here("outputs/top_species_fm_1996_2020.qs"))

test <- fm_data_top_spp %>%
  group_by(year, source_country_iso3c) %>%
  summarise(n_distinct(sciname)) %>%
  ungroup()

fm_data_top_spp %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum() # 5006092
fm_data %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum()
5006092/6158133 # 0.8129237; we retain ~81% of fishmeal reported in ARTIS by only keeping top 20 species.

all_spp_time <- fm_data_top_spp %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "All species")

finfish_time <- fm_data_top_spp %>%
  filter(phylum == "chordata") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Finfish") 

crust_time <- fm_data_top_spp %>%
  filter(phylum == "arthropoda") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Crustaceans") 

mollusc_time <- fm_data_top_spp %>%
  filter(phylum == "mollusca") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Cephalopoda")  %>%
  filter(product_t != 0)

overtime_all <- rbind(all_spp_time, finfish_time, crust_time, mollusc_time) %>%
  mutate(perc = scales::percent(round(prop, 2), accuracy = 1))

artis_palette(length(unique(overtime_all$fishmeal_type)))

ggplot(overtime_all, aes(x = year, y = product_t, color = fishmeal_type)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~data_type, scales = "free_x") + 
  labs(x = "Year", y = "Fishmeal product (tonnes)", color = "Fishmeal type") + 
    scale_color_manual(values = c("trimmings" = "#741A32", "wholefish" = "#114F59"), 
                     labels = c("Trimmings-derived", "Whole fish-derived")) + 
  scale_x_continuous(limits = c(1994.5, 2021.5), breaks = c(1996, 2002, 2008, 2014, 2020), 
                     labels = c(1996, 2002, 2008, 2014, 2020)) +
  theme(legend.position = "bottom") +
    geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "trimmings", data_type != "Cephalopoda"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "wholefish", data_type != "Cephalopoda"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "trimmings", data_type != "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "wholefish", data_type != "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0.2, hjust = 1, show.legend = FALSE, size = 3) +
        geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "trimmings", data_type == "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0, hjust = 1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 1996, fishmeal_type == "wholefish", data_type == "Crustaceans"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0.5, hjust = 1, show.legend = FALSE, size = 3)  + 
          geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "trimmings", data_type == "Cephalopoda"),
            aes(x = year, y = product_t, label = perc),
            vjust = -0.5, hjust = -0.1, show.legend = FALSE, size = 3) +
      geom_text(data = filter(overtime_all, year == 2020, fishmeal_type == "wholefish", data_type == "Cephalopoda"),
            aes(x = year, y = product_t, label = perc),
            vjust = 0.5, hjust = -0.1, show.legend = FALSE, size = 3) 

 


ggsave(here("outputs/figs/MS/Figure_1_time.png"), width = 180, height =180 , units = "mm", bg = "white", dpi =300)


```

Compare our total fishmeal values to what FAO reports

```{r}
comm_codes <- read.csv(here("data/FI_Trade_PP_2024.1.0/CL_FI_COMMODITY_ISSCFC.csv")) %>%
  clean_names()

countries_fao <- read.csv(here("data/FI_Trade_PP_2024.1.0/CL_FI_COUNTRY_GROUPS.csv")) %>%
  clean_names()

FAO_fm <- read.csv(here("data/FI_Trade_PP_2024.1.0/TRADE_PP_QUANTITY.csv")) %>%
  clean_names() %>%
  left_join(comm_codes, by = c("commodity_fao_code" = "code")) %>%
  left_join(countries_fao, by = c("country_un_code" = "un_code")) %>%
  filter(sit_cv4 == 81.42) %>%
  group_by(period) %>%
  summarise(tonnes_pw = sum(value, na.rm = TRUE)) %>%
  ungroup()

5006092/5320713 # 0.9408686; 94% - pretty good! 

```


## Figure 2. Production and trade flows

```{r}
top_species_by_country_2019 <- qs::qread(here("outputs/top_species_fm_2015_2019.qs"))
  
  sum(top_species_by_country_2019$product_weight_t) # 5071250; ok cool. Seems reasonable. FAO reports ~5.1 million tonnes for 2019 (figure 68 in FAO SOFIA, hard to tell the exact number)

   # Create a simplified trade flow visualization
  trade_flows <- top_species_by_country_2019 %>% 
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/sum(product_weight_t))
  
  sum(trade_flows$product_weight_t) # 5071250
  
    
## Ok let's try to make the sankey a bit prettier
    
# Setting up parameters based on user input-----------------------------------
  
  # Assign weight column to quantity
  quantity <- "product_weight_t"
    
    cols <- c("source_country_iso3c", "fishmeal_type", "importer_iso3c")

  # Summarizing data based on quantity variable selected
  links <- trade_flows %>%
    group_by(source_country_iso3c, fishmeal_type, importer_iso3c) %>% 
    summarize(total_q = sum(.data[[quantity]], na.rm = TRUE))

  
  # Rename specified columns to generic names for processing
  colnames(links) <- c(paste("col_", 1:length(cols), sep = ""), "total_q")
  cols <- colnames(links)[1:length(cols)]
  
  # Identify list of nodes by column by proportional flow cutoff
  node_names <- c()
  
  for(i in 1:length(cols)){
    # Identify nodes in the column falling below the threshold
    # i = 1 
    node_i <- links %>%
      rename(col_i = paste("col_", i, sep = "")) %>%
      group_by(col_i) %>%
      summarize(total_q = sum(total_q, na.rm=TRUE)) %>%
      ungroup() %>%
      mutate(total = sum(total_q, na.rm=TRUE)) %>%
      mutate(prop = total_q / total) %>%
      # label those below threshold as "Other" - otherwise keep name
      mutate(name_new = case_when(
        prop <= 0.03397748 ~ "Other", # this is the cutoff for including Chile on the left hand side
        TRUE ~ col_i
      ))
    
    # Create vector of nodes
    node_names_i <- node_i$name_new
    
    # Replace node names with "Other" when it falls below the threshold 
    # in links dataframe
    links <- links %>%
      rename(col_i = paste("col_", i, sep = "")) %>%
      mutate(col_i = case_when(
        col_i %in% node_names_i ~ col_i,
        TRUE ~ "Other"
      ))
    # rename working column with generic name perscribed above 
    colnames(links)[colnames(links) == "col_i"] <- paste("col_", i, sep = "")
    
    # vector of all node names
    node_names <- unique(c(node_names, node_names_i))
  }
  # vector of all node names across all columns of interest 
  node_names <- unique(node_names)
  
  # Creating dataframe from sankey----------------------------------------------
  # keep "Other" observation values if specified, remove if flase
  show.other = FALSE
  
  if(show.other == FALSE){
    node_names <- node_names[node_names != "Other"]
  }else{
    node_names <- node_names
  }
  
  sankey_df <- links %>%
    # Filtering data based on prop flow cutoff - use show.other value 
    filter_at(vars(cols), all_vars(. %in% node_names)) %>%
    ungroup() %>% 
    # rename("Phylum" = "col_1", 
    #        "Fishmeal type" = "col_2",
    #        "Consuming countries" = "col_3") %>%
        # rename( 
        #    "Fishmeal type" = "col_1",
        #    "Consuming countries" = "col_2")
    rename("Producing countries" = "col_1",
           "Fishmeal type" = "col_2",
           "Consuming countries" = "col_3") %>%
    mutate(`Fishmeal type` = str_to_sentence(`Fishmeal type`),
           `Producing countries` = countrycode(sourcevar = `Producing countries`, origin = "iso3c", destination = "country.name"),
           `Consuming countries` = countrycode(sourcevar = `Consuming countries`, origin = "iso3c", destination = "country.name")) %>%
    filter(!is.na(`Producing countries`))

  
    # col_1 = "phylum"
  # col_2 = "fishmeal_type"
  # col_3 = "importer_iso3c"
  
  sankey_df <- sankey_df %>%
    # Transforming into ggsankey format (x, node, next_x, next_node)
     # ggsankey::make_long(c("Phylum", "Fishmeal type", "Consuming countries"), value = total_q) 
       #  ggsankey::make_long(c("Fishmeal type", "Consuming countries"), value = total_q) 
            ggsankey::make_long(c("Producing countries", "Fishmeal type", "Consuming countries"), value = total_q) 



  
  num_nodes <- length(unique(c(sankey_df$node,sankey_df$next_node)))
  
  # Visualizing sankey diagram--------------------------------------------------

# Save the Sankey plot as object A
plot_a <- sankey_df %>%
    ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node
               )) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_label(size = 3, color = "black", fill = "gray") +
    theme_sankey(base_size = 10) +
    scale_fill_manual(values = artis_palette(num_nodes)) + 
    labs(x = NULL, title = "", 
         subtitle = "A") +
    theme(
      legend.position = "none",
      axis.text.x = element_text(color = "black", size = 10),
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
    )  + 
    scale_x_discrete(position = "bottom") 

ggsave(plot = plot_a, filename = here("outputs/figs/MS/figure_2a.png"), 
       width = 180, 
       height = 100,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Save the whole fish map as plot B
trade_flows_2 <- filter(top_species_by_country, exporter_iso3c != importer_iso3c)

plot_b <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "wholefish"), 
                   country_fill = "importer_iso3c", 
                   flow_arrows = TRUE, 
                   arrow_label = "Exports (million t)", 
                   fill_label = "Imports (million t)", 
                   value = "product_weight_t",
                   n_flows = 5) + 
    labs(subtitle = "B", caption = "Whole fish fishmeal") +
      theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(),            # Remove any rectangular elements
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")                            
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

test <- trade_flows_2 %>% filter(fishmeal_type == "wholefish") %>% group_by(importer_iso3c, exporter_iso3c) %>% summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>% ungroup()

test %>% filter(importer_iso3c == "CHN") %>% pull(tonnes) %>% sum()/sum(test$tonnes) # 0.5078128; ~50% of imports go to China. The scale on the plot makes it seem more like 80%? It's because the scale is out of 1 million. So that is millions of tonnes, not a proportion.


ggsave(plot = plot_b, filename = here("outputs/figs/MS/figure_2b.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the trimmings map as plot C
plot_c <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "importer_iso3c", 
                   flow_arrows = TRUE, 
                   arrow_label = "Exports (million t)", 
                   fill_label = "Imports (million t)", 
                   value = "product_weight_t", 
                   n_flows = 5) +
    labs(subtitle = "C", caption = "Trimmings fishmeal") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(),               # Remove any rectangular elements
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

ggsave(plot = plot_c, filename = here("outputs/figs/MS/figure_2c.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the fishmeal production map as plot D
plot_d1 <- plot_map(top_species_by_country %>% filter(fishmeal_type == "wholefish"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t"
                  )  

plot_d2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "wholefish"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_d2$layer[[2]]

arrow_scale <- plot_d2$scales$scales[[
  which(sapply(plot_d2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_d <- plot_d1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "D",
       caption = "Whole fish fishmeal", 
       color = "Exports (million t)",
       fill = "Production (million t)") +
  theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   # Remove any rectangular elements
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

ggsave(plot = plot_d, filename = here("outputs/figs/MS/figure_2d.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Save the fishmeal production map as plot E
plot_e1 <- plot_map(top_species_by_country %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t" 
                  ) 

plot_e2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_e2$layer[[2]]

arrow_scale <- plot_e2$scales$scales[[
  which(sapply(plot_e2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_e <- plot_e1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "E",
       caption = "Trimmings fishmeal", 
       color = "Exports (million t)", 
       fill = "Production (million t)") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   # Remove any rectangular elements
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )



ggsave(plot = plot_e, filename = here("outputs/figs/MS/figure_2e.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Combine plots using patchwork
# Then combine them with patchwork
combined_plot <- plot_a / (plot_b + plot_c) / (plot_d + plot_e) +
  # Adjust layout to give more space to maps
  plot_layout(
    heights = c(0.5, 1, 1),  # Heights for Sankey, middle maps, and bottom maps
    widths = c(1, 1)        # Equal widths for the maps
  ) &
  # Ensure consistent theme across all plots
  theme(
    plot.margin = margin(5, 5, 5, 5),
    plot.subtitle = element_text(size = 10, hjust = 0.1, color = "black")
  )
# Save the combined plot
ggsave(here("outputs/figs/MS/figure_2_combined.png"), 
       combined_plot,
       width = 320,      # Maximum width for good map visibility
       height = 300,     # Increased height for better map detail
       units = "mm", 
       bg = "white", 
       dpi = 300)
  
    
    
```

Figure 3. Species level bar chart 

```{r}
  
  
    trade_flows_4 <- top_species_by_country_2019 %>%
    group_by(common_name, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
  mutate(common_name = 
           case_when( 
             common_name == "anchoveta(=peruvian anchovy)" ~ "peruvian anchoveta",
             common_name == "european pilchard(=sardine)" ~ "european pilchard",
             common_name == "blue whiting(=poutassou)" ~ "blue whiting",
             TRUE ~ common_name
           )) %>%
  mutate(common_name = str_to_sentence(common_name)) %>%
  mutate(fill_name = ifelse(fishmeal_type == "wholefish", "Whole fish-derived", "Trimmings-derived"))
    
    
    
    
plot_bar(trade_flows_4,
        bar_group = "common_name",
        fill_type = "fill_name", 
        value = "product_weight_t", 
        top_n = 20)

ggsave(here("outputs/figs/MS/figure_3.png"),width = 250, height =100.92 , units = "mm", bg = "white")

```

## Trade flows and production stats for manuscript 

Explore trade flows and production statistics 

```{r}

total_tonnes <- top_species_by_country_2019 %>% 
  pull(product_weight_t) %>%
  sum()


  trade_flows_production <- top_species_by_country_2019 %>%
    group_by(source_country_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)

  
trade_flows_consumption <- top_species_by_country_2019 %>%
    group_by(importer_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)

trade_flows_imports <- top_species_by_country_2019 %>%
  filter(source_country_iso3c != importer_iso3c) %>%
    group_by(importer_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)


trade_flows_exports <- top_species_by_country_2019 %>%
  filter(source_country_iso3c != importer_iso3c) %>%
    group_by(exporter_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)


# aquaculture production data from FAO
aqua_country <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/CL_FI_COUNTRY_GROUPS.csv") %>%
  clean_names() %>%
  dplyr::select(country_un_code = un_code, iso3c = iso3_code)
aqua_spp <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/CL_FI_SPECIES_GROUPS.csv") %>%
  clean_names() %>%
  dplyr::select(x3a_code, common_name = name_en, isscaap_group_en, major_group, scientific_name)

aqua_prod <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/Aquaculture_Quantity.csv") %>%
  clean_names() %>%
  left_join(aqua_country) %>%
  filter(iso3c != "") %>%
  left_join(aqua_spp, by = c("species_alpha_3_code" = "x3a_code")) %>%
  dplyr::select(iso3c, year = period, common_name, scientific_name, isscaap_group_en, major_group, tonnes_lw = value)


```

Lets look at China numbers 

```{r}
##  China production and consumption
### Total
(chn_cons <- trade_flows_consumption %>% filter(importer_iso3c == "CHN") %>% pull(product_weight_t) %>% sum()) # 2201697
chn_cons/total_tonnes # 0.4402808

### Trimmings vs whole 
trade_flows_consumption %>% filter(importer_iso3c == "CHN") %>% group_by(fishmeal_type) %>% summarise(product = sum(product_weight_t)) %>% mutate(prop = product/2201697)

# A tibble: 2 × 3
#   fishmeal_type  product  prop
#   <chr>            <dbl> <dbl>
# 1 trimmings     1129837. 0.513
# 2 wholefish     1071860. 0.487

trade_flows_production %>% filter(source_country_iso3c == "CHN") %>% group_by(fishmeal_type) %>% summarise(product = sum(product_weight_t)) %>% mutate(prop = product/total_tonnes)

# A tibble: 2 × 3
#   fishmeal_type product   prop
#   <chr>           <dbl>  <dbl>
# 1 trimmings     822426. 0.164 
# 2 wholefish     199604. 0.0399

trade_flows_imports %>% filter(importer_iso3c == "CHN") %>% group_by(fishmeal_type) %>% summarise(product = sum(product_weight_t)) %>% mutate(prop = product/total_tonnes)

# A tibble: 2 × 3
#   fishmeal_type product   prop
#   <chr>           <dbl>  <dbl>
# 1 trimmings     312384. 0.0625
# 2 wholefish     885263. 0.177 

# what does china export? 
trade_flows_exports %>% filter(exporter_iso3c == "CHN") %>% group_by(fishmeal_type) %>% summarise(product = sum(product_weight_t)) %>% mutate(prop = product/total_tonnes)

# # A tibble: 2 × 3
#   fishmeal_type product     prop
#   <chr>           <dbl>    <dbl>
# 1 trimmings       3842. 0.000768
# 2 wholefish       2869. 0.000574

## why does peru produce so much trimmings?
peru <- trade_flows_average %>% filter(source_country_iso3c == "PER")


## lets look at how much aquaculture china produces vs how much live weight they use for feed

# get fed aquaculture production in China
chn_aquaculture_finfish_shrimp <- aqua_prod %>%
  filter(year %in% c(2015:2019),
         iso3c == "CHN") %>%
  filter(!(isscaap_group_en %in% c("Brown seaweeds", "Red seaweeds", "Green seaweeds", "Miscellaneous aquatic plants"))) %>% # filter out any algae/seaweeds
      group_by(iso3c, scientific_name, common_name, major_group) %>%
    summarise(
            live_weight_t = mean(tonnes_lw, na.rm = TRUE)
    ) %>%
    ungroup()

sum(chn_aquaculture_finfish_shrimp$live_weight_t) # 45322007

## Majluf et al. 2024 reports that 40% (19 million tonnes) of chinese aquaculture is fed in 2020: 
45322007*0.4 # 18128803 ~ 18 million tonnes for 2015-2019

top_species_by_country_2019 <- qs::qread(here("outputs/top_species_fm_2015_2019.qs")) 

top_species_by_country_2019 %>% filter(importer_iso3c == "CHN") %>%
  pull(live_weight_t) %>% sum() # 6550504

top_species_by_country_2019 %>% filter(importer_iso3c == "CHN") %>%
  pull(product_weight_t) %>% sum() # 2201697

18128803/6550504 # 2.767543 pretty efficient... 

```

```{r}
## look at imports vs production: 
domestic_production <- top_species_by_country_2019 %>%
  filter(source_country_iso3c == importer_iso3c) %>%
    group_by(source_country_iso3c, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/total_tonnes)

imports_prod <- trade_flows_production %>%
  dplyr::select(iso3c = source_country_iso3c, fishmeal_type, production_product = product_weight_t) %>%
  left_join(trade_flows_imports %>%
  dplyr::select(iso3c = importer_iso3c, fishmeal_type, imported_product = product_weight_t)) %>%
  group_by(iso3c) %>%
  summarise(total_production = sum(production_product, na.rm = TRUE), 
            total_imports = sum(imported_product, na.rm = TRUE)) %>%
  mutate(ratio = total_imports/total_production)


```

Species summary 

```{r}
  
  # Species summary
  species_summary <- top_species_by_country_2019 %>%
    group_by(sciname, common_name, source_country_iso3c, fishmeal_type) %>%
    summarise(
      total_product_weight = sum(product_weight_t, na.rm = TRUE)
    ) %>%
    arrange(desc(total_product_weight))

  species_summary_spp <- top_species_by_country %>%
    group_by(sciname, common_name, fishmeal_type) %>%
    summarise(
      total_product_weight = sum(product_weight_t, na.rm = TRUE)
    ) %>%
    arrange(desc(total_product_weight))

species_summary %>% filter(fishmeal_type == "whole fish", sciname == "engraulis ringens") %>% pull(total_product_weight) %>% sum()

species_summary %>% filter(fishmeal_type == "whole fish", sciname == "micromesistius poutassou") %>% pull(total_product_weight) %>% sum()



```

```{r}
trade_flows_consumption_spp <- top_species_by_country_2019 %>%
    group_by(importer_iso3c, fishmeal_type, common_name) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup()


```

To explore: 
 - look into countries that show a preference for trimmings-based FM importing; i.e., who is importing more trimmings than the global share and who is importing less? Otherwise, it makes sense that the top countries will mirror top fishmeal importers. 

 - look at EU as a whole for trimmings production
 
```{r}

```


## Compare to Newton & Jackson 2013

 - Look at 2009-2013 numbers so it is comparable

```{r}
## Let's  compare to Newton and Jackson from IFFO and see if our numbers generally match

#The database includes fish, crustaceans and cephalopod molluscs but not mammals, other molluscs, reptiles, amphibians or plants as it is assumed that there are no usable by-products, or that they are not readily directed to fishmeal/ fish oil production. All of the usable supply is referred to as seafood henceforth, whether marine or freshwater. 

#The most up-to-date seafood production volume data for the last 5 years (2009-2013), taken from FAO FishStat, was averaged for each country for all species from capture and aquaculture. This was ranked to find the top twenty production species for each region for each of capture fisheries and aquaculture.  

top_species_by_country_2013 <- qs::qread(here("outputs/top_species_fm_2009_2013.qs"))
  

  test <- top_species_by_country_2013 %>% group_by(source_country_iso3c) %>% summarise(n_distinct(sciname)) # seems to have worked
  
  ## Newton and Jackson report ~4.639 million tonnes. Provided I followed the methodology then I should see something similar: 
  
  sum(top_species_by_country_2013$product_weight_t) # 4952253; we get ~4.9 million tonnes. They say that the "official IFFO figure is 4.8 million tonnes. So we are within an acceptable range! What does FAO report for 2013? 4.95 million tonnes
  
  test <- FAO_fm %>%
    filter(period == 2013) %>%
    pull(tonnes_pw) %>%
    sum() # 4945056
  
  ## ok lets look at trimmings vs whole fish amounts: Newton and jackson report 3.131 million tonnes from whole fish and 1.508 million tonnes from trimmings. We see that they are actually nearly equal? 
  
  top_species_by_country_2013 %>% filter(fishmeal_type == "wholefish") %>% pull(product_weight_t) %>% sum() # 2532418 whole fish
  top_species_by_country_2013 %>% filter(fishmeal_type == "trimmings") %>% pull(product_weight_t) %>% sum() # 2419835 trimmings


  ## lets look at just the chordata and cepholopods 
top_species_by_country_2013 %>% filter(fishmeal_type == "trimmings", phylum == "chordata"|class == "cephalopoda") %>% pull(product_weight_t) %>% sum() # 1390942 from trimmings 

top_species_by_country_2013 %>% filter(fishmeal_type == "wholefish", phylum == "chordata"|phylum == "cephalopoda") %>% pull(product_weight_t) %>% sum() # 2438085 from whole fish. Ok this is closer to what IFFO reports. Just less fishmeal overall - which is fine. 

top_species_by_country_2013 %>% filter(phylum == "chordata"|class == "cephalopoda") %>% pull(product_weight_t) %>% sum() # 3829028 total products without shrimps/prawns


## OK: Results are very similar in the total amount of fishmeal produced compared to IFFO. But when looking at % breakdowns of trimmings vs whole fish, accounting for the same species and methods (arthropoda + chordata, 2009-2013 average). Not sure why this is the case? 
# For example: Newton and Jackson reports says they include crustaceans, squids/octopus, and finfish. If I apply the same methodology:
    # We get ~4.9 million tonnes compared to their 4.6 million tonnes total. This is in the range of uncertainty that is acceptable (they report official IFFO estimates of 4.8 million tonnes fishmeal)
    # We get ~2.5 million tonnes from whole fish vs their 3.1 million tonnes whole fish
    # We get ~2.4 million tonnes trimmings vs their 1.5 million tonnes trimmings.
    # So we are over estimating amount to trimmings compared to IFFO.
# HOWEVER, if we exclude any shrimp/prawn meal:
    # We get 3.8 million tonnes total vs their 4.6 million tonnes total. 
    # We get 2.4 million tonnes whole fish vs their 3.1 million tonnes whole fish
    # We get 1.4 million tonnes trimmings vs their 1.5 million tonnes trimmings
    # So excluding shrimp/prawn meal, we underestimate the total and whole fish meal, but are spot on with trimmings fishmeal. 	
## I wonder if it is because they include molluscs (oysters, clams, etc) and we don't? Presumably those would be mostly whole fish.

top_species_by_country_inc_mollusc <- qread(here("outputs/top_species_fm_2009_2013_inc_molluscs.qs")) %>%
        mutate(fishmeal_type = ifelse(isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Mussels", "Oysters", "Scallops, pectens")| isscaap %in% c("Multiple ISSCAAP groups") & phylum == "mollusca", "wholefish", fishmeal_type ))

  ## lets look at just the chordata and cepholopods 
top_species_by_country_inc_mollusc %>% filter(fishmeal_type == "trimmings", phylum %in% c("chordata", "mollusca")) %>% pull(product_weight_t) %>% sum() # 1328225 from trimmings 

top_species_by_country_inc_mollusc %>% filter(fishmeal_type == "wholefish", phylum %in% c("chordata", "mollusca")) %>% pull(product_weight_t) %>% sum() # 4366261 from whole fish. Ok this is closer to what IFFO reports. Just less fishmeal overall - which is fine. 

top_species_by_country_inc_mollusc %>% filter(phylum %in% c("chordata", "mollusca")) %>% pull(product_weight_t) %>% sum() # 5694486 total products without shrimps/prawns
## ok so now we get 1.3 trimmings and 4.3 whole fish. Lines up a bit better this way. Maybe this is what they did? Regardless, we're not presenting this info in the MS...


region_order <- c("Europe", "Asia (exc China)", "China", "Africa", "South America", "North America", "Oceania", "Other nei", "Totals")


by_continent <- top_species_by_country_2013 %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  mutate(region = case_when(source_country_iso3c == "CHN" ~ "China",
                            owid_region == "Asia" & source_country_iso3c != "CHN" ~ "Asia (exc China)", 
                            is.na(owid_region) ~ "Other nei", 
                            TRUE ~ owid_region)) %>%
  group_by(region, fishmeal_type) %>%
  summarise(product_weight_t =  sum(product_weight_t, na.rm = TRUE)/1000) %>%
  ungroup() %>%
  pivot_wider(names_from = fishmeal_type, values_from = product_weight_t) %>%
  dplyr::select(region, whole_fish = `wholefish`, trimmings)


totals_row <- by_continent %>%
  summarise(region = "Totals",
            across(where(is.numeric), sum, na.rm = TRUE))



 by_continent <- bind_rows(by_continent, totals_row) %>%
  mutate(total =  whole_fish + trimmings) %>%
  mutate(perc_trim = trimmings/total*100) %>%
    mutate(region = factor(region, levels = region_order)) %>%
    arrange(region)
 
```
 
 
## Run high-level scenario of FM replacement with trimmings/divert forage fish to human consumption

To figure out: 
 - How much trimmings fishmeal could be created if BAU? I.e., we keep whole fish production going, but just utilise fillet trimmings to full extent. Could this extra trimmings FM make up for losses in whole fish reduction? 
 - How much trimmings fishmeal could be created if we directed all whole fish production FM to human consumption instead? Could this extra trimmings make up for losses in whole fish reduction?
 - How much extra human food would be created if we stopped whole fish production? Does this extra human food match the production amounts of fed aquaculture? 


How much trimmings fishmeal could be created if BAU? I.e., we keep whole fish production going, but just utilise fillet trimmings to full extent. Could this extra trimmings FM make up for losses in whole fish reduction? 

```{r}
# If a species is filleted and used as trimmings, then we will ultimately need to subtract that from the total we calculate. 

# Look at fillet data, determine how much of each filleted species is waste, assume all of that waste is used for fishmeal. 
extra_trimmings <- fillet_artis %>%
  left_join(artis_taxa) %>%
      mutate(phylum = case_when(is.na(phylum) & sciname %in% c("lampetra fluviatilis", "petromyzontidae", "petromyzon marinus") ~ "chordata",
                              is.na(phylum) & sciname == "animalia" ~ "animalia",
                            TRUE ~ phylum)) %>% 
  mutate(processing_waste_t = live_weight_t - product_weight_t) %>%
  dplyr::select(-product_weight_t, -live_weight_t, -consumer_iso3c, -hs6) %>% 
  group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(processing_waste_t = sum(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    #trimmings_fm_t = processing_waste_t/2.975207, 
    processing_waste_t = processing_waste_t*0.96, # assuming 2% blood loss weight and 2% losses at primary fish processing stage
         fishmeal_type = "trimmings")

fillet_trim_2013 <- extra_trimmings %>%
  filter(year %in% c(2009:2013)) %>%
      group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
    summarise(
      processing_waste_t = sum(processing_waste_t, na.rm = TRUE)
    ) %>%
    ungroup() %>%
        group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
    summarise(
      processing_waste_t = mean(processing_waste_t, na.rm = TRUE)) %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(processing_waste_t = mean(processing_waste_t, na.rm = TRUE)) %>%
  ungroup() %>%
    mutate(trimmings_fm_t = processing_waste_t/2.975207, 
         fishmeal_type = "trimmings")

sum(fillet_trim_2013$trimmings_fm_t) # 2475850 - 2.48 million tonnes; This is just additional fishmeal. Newton and Jackson say There is ~2.365 million unused by-product tonnes of fishmeal on average from 2009-2013. So we are exceeding them by ~200k tonnes. However, we need to subtract out the trimmings that we already include.
  
## do i need to use the top species data set i created? No since this is for yearly volumes.

fm_trim_df <- fm_data_adjusted %>%
    group_by(year, source_country_iso3c, exporter_iso3c, sciname, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
      live_weight_t = sum(live_weight_t)
    ) %>%
  ungroup() %>% 
  filter(fishmeal_type == "trimmings")


extra_trimmings_final <- extra_trimmings %>%
  left_join(., fm_trim_df) %>%
  mutate(product_weight_t = ifelse(is.na(product_weight_t), 0, product_weight_t)) %>%
    mutate(live_weight_t = ifelse(is.na(live_weight_t), 0, live_weight_t)) %>%
  mutate(unused_trimmings_t_lw = processing_waste_t - live_weight_t) %>%
mutate(unused_trimmings_t_lw = ifelse(unused_trimmings_t_lw < 0, 0, unused_trimmings_t_lw)) ## there are some negatives here... so we'll make these 0s; these are negatives because we might be overestimating the amount of trimmings from forage fisheries. But we can't have negative fishmeal so we'll just filter it out. 
  

extra_trimmings_2013 <- extra_trimmings_final %>%
  filter(year %in% c(2009:2013)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = sum(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = mean(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(unused_trimmings_t = unused_trimmings_t_lw/2.975)

  
sum(extra_trimmings_2013$unused_trimmings_t, na.rm = TRUE) # 2085131; pretty close; after accounting for what we already use

```

## Current day (2015 - 2019) scenarios 

```{r}
############## Look at 2015-2019 period now

extra_trimmings_2019 <- extra_trimmings_final %>% 
  filter(year %in% c(2015:2019)) %>%
    group_by(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = sum(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c, exporter_iso3c, sciname) %>%
  summarise(unused_trimmings_t_lw = mean(unused_trimmings_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(unused_trimmings_t = unused_trimmings_t_lw/2.975)

sum(extra_trimmings_2019$unused_trimmings_t, na.rm = TRUE) # 1810373

top_species_by_country_2019 %>% filter(fishmeal_type == "wholefish") %>% pull(product_weight_t) %>% sum() # 2245116

sum(extra_trimmings_2019$unused_trimmings_t, na.rm = TRUE)/2245116 # if we used fillet trimmings fully, that could cover ~81% of the demand


# If the reduction fisheries were instead re-allocated to human consumption, and their trimmings used for fish meal, AND fillet trimmings used fully, would this make up loss of whole fish-derived fishmeal? 

#### Look at only reductions fisheries SUITABLE for human consumption?
#### Will need to figure out %s of each fish species which are edible. We can figure this out by looking at the fillet data ARTIS provides.

fillet_conversion <- fillet_artis %>%
  filter(year %in% c(2015:2019)) %>%
  group_by(source_country_iso3c, sciname, year) %>%
  summarise(product_weight_t = sum(product_weight_t),
            live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>% 
    group_by(source_country_iso3c, sciname) %>%
  summarise(product_weight_t = sum(product_weight_t),
            live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>% 
  mutate(conversion_fillet_mean = live_weight_t/product_weight_t)  %>%
  dplyr::select(-product_weight_t, -live_weight_t)


top_species_by_country_2019 <- qs::qread(here("outputs/top_species_fm_2015_2019.qs"))

# this is the fishmeal that would be made from trimmings from redirecting forage fish to human consumption
extra_fillet_fishmeal <- top_species_by_country_2019 %>%
  left_join(fillet_conversion) %>%
  filter(phylum == "chordata") %>% # only chordata have fillets reported, so we will only gapfill any missing ones
  group_by(sciname) %>%
  mutate(global_spp_conversion_mean = mean(conversion_fillet_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(global_conversion = mean(conversion_fillet_mean, na.rm = TRUE)) %>% # get overall global mean in case still missing
  mutate(conversion_fillet_final = ifelse(is.na(conversion_fillet_mean), global_spp_conversion_mean, conversion_fillet_mean)) %>%
    mutate(conversion_fillet_final = ifelse(is.na(conversion_fillet_final), global_conversion, conversion_fillet_final)) %>%
  dplyr::select(1:10, conversion_fillet_final) %>%
  filter(fishmeal_type != "trimmings") %>% # we only care about extra fm we could create from whole fish 
  mutate(fillet_weight = live_weight_t/conversion_fillet_final) %>%
  mutate(live_weight_for_extra_fm = (live_weight_t - fillet_weight)*0.96) %>% # i think we subtract out 4% from blood and processing loss here at the live weight section. Since the processing is at the primary fish processing stage (so liveweight stage). Hence the 0.96 multiplication
  mutate(extra_fm_weight = live_weight_for_extra_fm/2.975207)

sum(extra_fillet_fishmeal$extra_fm_weight) # 1372394 tonnes of fishmeal if we redirected all whole fish FM to human consumption

sum(extra_fillet_fishmeal$extra_fm_weight) + sum(extra_trimmings_2019$unused_trimmings_t, na.rm = TRUE) # 3182767 total fishmeal from utilising fillets trimmings and redirecting forage fish to fillets and trimmings 

top_species_by_country_2019 %>% filter(fishmeal_type == "wholefish") %>% pull(product_weight_t) %>% sum() # 2245116 # whole fish production

3182767-2245116 # 937651 # produces nearly 1 million more tonnes of fishmeal than what we currently do for whole fish

sum(extra_fillet_fishmeal$fillet_weight) # 1935069 extra fillet tonnes

fillet_artis %>% filter(year %in% c(2015:2019)) %>% group_by(year) %>% summarise(total_tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  pull(total_tonnes) %>% mean() # 3859622

1935069/3859622 # 0.5013623

# so if we fully utilised trimmings from fillets AND we redirected finfish whole fish fishmeal to human consumption, and used those trimmings for fishmeal, we could produce 3182767 tonnes of fish meal. This is 3182767 - 2245116 = 937651 more tonnes than is currently demanded of whole fish derived fish meal! Would also produce 1935069 tonnes of fillets for human consumption (half of current fillet supply).


## lets try doing a full accounting now. We want unused trimmings (minus those already accounted for), trimmings produced from redirection to human consumption, and trimmings already produced

## how much fishmeal from non chordata wholefish? 
non_finfish_fm <- top_species_by_country_2019 %>% 
  filter(phylum != "chordata", fishmeal_type == "wholefish", product_weight_t > 0)
sum(non_finfish_fm$product_weight_t) # 165140.7

## fishmeal from trimmings already produced? 
top_species_by_country_2019 %>% filter(fishmeal_type == "trimmings") %>% pull(product_weight_t) %>% sum() # 2755549

# unused trimmings = 1810373
# redirected whole fish fillet trimmings = 1372394

1372394 + 1810373 + 2755549 + 165140.7 # 6103457 NEW TOTAL

sum(top_species_by_country_2019$product_weight_t) # 5000665

6103457 - 5000665 # WOULD BE PRODUCING 1102792 more tonnes than before
  
## what about if we fully utilised trimmings from shrimp/prawn aquaculture production? This assumes that all shrimp would be de-headed, de-shelled, and de-tailed. 
# should we include capture production of shrimp too? 

aqua_prod <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/Aquaculture_Quantity.csv") %>%
  clean_names() %>%
  left_join(aqua_country) %>%
  filter(iso3c != "") %>%
  left_join(aqua_spp, by = c("species_alpha_3_code" = "x3a_code")) %>%
  dplyr::select(iso3c, year = period, common_name, scientific_name, isscaap_group_en, major_group, tonnes_lw = value)

shrimp_aqua_prod <- aqua_prod %>%
  filter(major_group == "CRUSTACEA") %>%
  filter(isscaap_group_en == "Shrimps, prawns") %>%
  filter(year %in% c(2015:2019),
         tonnes_lw > 0) %>%
  dplyr::select(source_country_iso3c = iso3c, common_name, year, tonnes_lw) %>%
  mutate(fishmeal_type = "trimmings") %>%
  mutate(common_name = tolower(common_name))

## we also need to get capture production values for shrimps/prawns
capture_country <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/capture_production_2024/CL_FI_COUNTRY_GROUPS.csv") %>%
  clean_names() %>%
  dplyr::select(country_un_code = un_code, iso3c = iso3_code)

capture_spp <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/capture_production_2024/CL_FI_SPECIES_GROUPS.csv") %>%
  clean_names() %>%
  dplyr::select(x3a_code, common_name = name_en, isscaap_group_en, major_group, scientific_name)

capture_prod <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/capture_production_2024/Capture_Quantity.csv") %>%
  clean_names() %>%
  left_join(capture_country) %>%
  filter(iso3c != "") %>%
  left_join(capture_spp, by = c("species_alpha_3_code" = "x3a_code")) %>%
  dplyr::select(iso3c, year = period, common_name, scientific_name, isscaap_group_en, major_group, tonnes_lw = value)

shrimp_capture_prod <- capture_prod %>%
  filter(major_group == "CRUSTACEA") %>%
  filter(isscaap_group_en == "Shrimps, prawns") %>%
  filter(year %in% c(2015:2019),
         tonnes_lw > 0) %>%
  dplyr::select(source_country_iso3c = iso3c, common_name, year, tonnes_lw) %>%
  mutate(fishmeal_type = "trimmings") %>%
  mutate(common_name = tolower(common_name))

all_shrimp_prod_fao <- rbind(shrimp_capture_prod, shrimp_aqua_prod) %>%
    group_by(source_country_iso3c, common_name, year, fishmeal_type)  %>%
    summarise(tonnes_lw = sum(tonnes_lw, na.rm = TRUE)) %>%
  ungroup()


fm_data_adjusted <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_adjusted_final_21-07-2025.qs"))


fm_trim_df <- fm_data_adjusted %>%
    group_by(year, source_country_iso3c, common_name, fishmeal_type) %>%
    summarise(
      live_weight_t = sum(live_weight_t)
    ) %>%
  ungroup() %>% 
  filter(fishmeal_type == "trimmings")


extra_shrimp_trim <- all_shrimp_prod_fao %>%
  left_join(., fm_trim_df) %>%
    mutate(live_weight_t = ifelse(is.na(live_weight_t), 0, live_weight_t)) %>%
  mutate(unused_t_lw = tonnes_lw - live_weight_t) %>%
mutate(unused_t_lw = ifelse(unused_t_lw < 0, 0, unused_t_lw)) ## there are some negatives here... so we'll make these 0s; these are negatives because we might be overestimating the amount of trimmings from forage fisheries. But we can't have negative fishmeal so we'll just filter it out. 
  
## FAO says that yield of raw meat is ~45%; we'll apply this for now https://www.fao.org/4/x5931e/x5931e01.htm
## so trimmings yield would be 55% of the live weight

extra_shrimp_trim_2019 <- extra_shrimp_trim %>%
  filter(year %in% c(2015:2019)) %>%
    group_by(year, source_country_iso3c, common_name) %>%
  summarise(unused_t_lw = sum(unused_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c, common_name) %>%
  summarise(unused_t_lw = mean(unused_t_lw, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(unused_trimmings_t_lw = unused_t_lw*0.55*0.98) %>% # 55% yield of trimmings from the live weight and 2% loss from processing
  mutate(unused_trimmings_pw_t = unused_trimmings_t_lw/2.975) # conversion factor of ~34% (really should be around 25%?)

sum(extra_shrimp_trim_2019$unused_trimmings_pw_t) # 999370

1863203 + 999370 + 1387774 + 2755549 + 165141 # 7171037 NEW TOTAL


7171037 - 5000665 # WOULD BE PRODUCING 2170372 more tonnes than before

## so our potential production is ~2.5 million tonnes less than other estimates.

# I think they are including ALL capture production and of finfish in their estimates, whereas we are just including whole fish redirected and fillets fully used. Let's a take a look a finfish from capture and aquaculutre production and calculate using their methodologies 

finfish_capture <- capture_prod %>%
  filter(major_group %in% c("PISCES")) %>%
  mutate(fm_byproduct = tonnes_lw*.415*0.98*0.98*0.2) %>% # this is the conversion to FM used in sandstrom et al. 
  filter(year %in% 2015:2019) %>%
  group_by(year, iso3c, common_name) %>%
  summarise(fm_byproduct = sum(fm_byproduct, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(iso3c, common_name) %>%
  summarise(fm_byproduct = mean(fm_byproduct, na.rm = TRUE)) %>%
  ungroup() 


finfish_aquaculture <- aqua_prod %>%
 filter(major_group %in% c("PISCES")) %>%
  mutate(fm_byproduct = tonnes_lw*.415*0.98*0.98*0.2) %>% # this is the conversion to FM used in sandstrom et al. 
  filter(year %in% 2015:2019) %>%
  group_by(year, iso3c, common_name) %>%
  summarise(fm_byproduct = sum(fm_byproduct, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(iso3c, common_name) %>%
  summarise(fm_byproduct = mean(fm_byproduct, na.rm = TRUE)) %>%
  ungroup() 


sum(finfish_capture$fm_byproduct) + sum(finfish_aquaculture$fm_byproduct) # 10603450
# ok if we subtract their estimate (1.9 million tonnes):
10603450 - 1900000 # 8703450 # low end
10603450 - 1400000 # 9203450 # high end

# ok so the discrepancy is likely that they are using ALL finfish capture and aquaculture production whereas we just look at what is plausible (i.e. unused fillets and redirection of whole fish species to fillets)

# if we do it, then we get 
10654228 - 2755549 # 7898679 # subtract out our estimate of trimmings and we should get ~7.9 million EXTRA tonnes of fm
# so that means using the same methods we would get ~10.6 million tonnes. This probably makes sense given that we have a higher estimate of trimmings derived fishmeal than previously reported.

# what if we at just finfish trimmings meal? 
top_species_by_country_2019 %>% filter(phylum == "chordata", fishmeal_type == "trimmings") %>% pull(product_weight_t) %>% sum() # c 


10654228 - 1193495 # 9460733; looking at only finfish, we get ~9.4 million tonnes. 
```

Now we should combine all of the new trimmings fishmeal data, and see what regions could benefit the most

```{r}

extra_shrimp_trimmings <- extra_shrimp_trim_2019 %>%
  dplyr::select(source_country_iso3c, common_name, live_weight_t = unused_trimmings_t_lw, product_weight_t = unused_trimmings_pw_t) %>%
  mutate(extra_fillet_t = 0)

extra_fillet_forage_trimmings <- extra_fillet_fishmeal %>% 
  dplyr::select(source_country_iso3c, common_name, live_weight_t = live_weight_for_extra_fm, product_weight_t = extra_fm_weight, extra_fillet_t = fillet_weight)

unused_fillet_trimmings <- extra_trimmings_2019 %>%
  left_join(artis_taxa) %>% 
  dplyr::select(source_country_iso3c, common_name, live_weight_t = unused_trimmings_t_lw, product_weight_t = unused_trimmings_t) %>%
  mutate(extra_fillet_t = 0)


all_extra_trimmings_scen <- rbind(extra_shrimp_trimmings, extra_fillet_forage_trimmings, unused_fillet_trimmings) %>%
  dplyr::group_by(source_country_iso3c, common_name) %>%
  summarise(live_weight_t = sum(live_weight_t, na.rm = TRUE),
            product_weight_t = sum(product_weight_t, na.rm = TRUE),
            extra_fillet_t = sum(extra_fillet_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(fishmeal_type = "trimmings")

## add in current fillet sums per country?

```


Notes on shrimp meal: 
 - From Edwards VNM working paper: "According to Williams (2000), the Nha Trang Seafoods Factory F18 processed 70–80% of all processed fish in Khanh Hoa province, producing 1500 t of by-products. Of this, 50% was sun-dried and used to make fish meal, 30% was used to make fish sauce and 20% was for direct human food. Intensive shrimp production of 2000 t produced 1000 t of wet waste that led to 300 t of dried shrimp head meal, which was used by feed mills."
     - This means 50% yield of live weight and then from that a 30% yield of shrimp meal 
  

Does the increase in shrimp meal correlate with shrimp aquaculture increase?

Did oyster aquaculture production ever recover after 2013 in China? 

How much fed-fish aquaculture does China produce? 

```{r}
 
shrimp_prod <- aqua_prod %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
  filter(year %in% c(1996:2020)) %>%
  group_by(year) %>% 
  summarise(tonnes = sum(tonnes_lw, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)

overall_increase <- shrimp_prod %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 659% increase

avg_annual_increase <- shrimp_prod %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 8.81% average yearly increase 


ggplot(shrimp_prod, aes(x = year, y = tonnes)) + 
  geom_line()


  
shrimp_fm <- fm_data_top_spp %>%
  filter(phylum == "arthropoda") %>%
  filter(str_detect(common_name, "shrimp|prawn")) %>%
    group_by(year) %>% 
  summarise(tonnes = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)



overall_increase <- shrimp_fm %>%
  summarise(
    pct_increase = ((last(tonnes) - first(tonnes)) / first(tonnes)) * 100
  ) # 488% increase

avg_annual_increase <- shrimp_fm %>%
  summarise(
    cagr = ((last(tonnes) / first(tonnes))^(1 / (last(year) - first(year))) - 1) * 100
  ) # 7.66% average yearly increase 

## look at finfish over time, see if the reduction in 2010 was peruvian anchoveta


finfish_time <- fm_data %>%
  filter(phylum == "chordata", common_name == "anchoveta(=peruvian anchovy)") %>%
  group_by(year, common_name) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup()  %>%
  filter(year %in% c(2009:2010))

# 17% decrease in peruvian anchoveta 2009 - 2010

finfish_time <- fm_data %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  filter(phylum == "chordata",
         owid_region == "South America") %>%
  group_by(year, common_name) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  filter(tonnes > 1000) %>%
  filter(year %in% c(2009:2010)) %>%
  arrange(common_name, year) %>%
  group_by(common_name) %>%
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100) # -38.2407252% decrease in South America, matches global decrease 


finfish_time <- fm_data %>%
  filter(phylum == "chordata") %>%
  group_by(year) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
    arrange(year) %>%  # Ensure data is sorted by year
  mutate(pct_change = (tonnes - lag(tonnes)) / lag(tonnes) * 100)
# 38.0034010% decrease all species globally


all_aquaculture_fed <- aqua_prod %>%
  filter(year %in% c(2015:2019),
         !(isscaap_group_en %in% c("Freshwater molluscs", "Abalones, winkles, conchs", "Oysters", "Mussels", "Scallops, pectens",                "Clams, cockles, arkshells", "Miscellaneous marine molluscs", "Sea-urchins and other echinoderms", "Miscellaneous aquatic invertebrates", "Pearls, mother-of-pearl, shells", "Brown seaweeds", "Red seaweeds", "Green seaweeds", "Miscellaneous aquatic plants"))  ) %>%
    filter(!str_detect(common_name, "Carp|carp"), # filter out carp since they are omnivores
           major_group != "AMPHIBIA, REPTILIA", 
         !(scientific_name %in% c("Carassius spp", "Cyprinidae", "Labeo rohita")),
         common_name != "Catla",) %>%
 # distinct(common_name, scientific_name, isscaap_group_en, major_group)
      group_by(iso3c, scientific_name, common_name, major_group) %>%
    summarise(
            live_weight_t = sum(tonnes_lw, na.rm = TRUE)

    ) %>%
    ungroup() %>%
      group_by(iso3c, scientific_name, common_name, major_group) %>%
    summarise(
            live_weight_t = mean(live_weight_t, na.rm = TRUE)
    ) %>%
    ungroup() %>%
  filter(live_weight_t > 0)

iso3c_aqua_fed <- all_aquaculture_fed %>%
  group_by(iso3c) %>%
  summarise(live_weight_t_farmed = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup()

iso3c_fm_used <- top_species_by_country_2019 %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t_fm = sum(live_weight_t, na.rm = TRUE)) %>%
  ungroup()

eff_iso3c <- iso3c_aqua_fed %>%
  left_join(iso3c_fm_used, by = c("iso3c" = "importer_iso3c")) %>%
  filter(!is.na(live_weight_t_fm)) %>%
  mutate(efficiency = live_weight_t_farmed/live_weight_t_fm)


ggplot(eff_iso3c, aes(x = live_weight_t_fm, y = live_weight_t_farmed, label = iso3c)) + 
  geom_point() +
  geom_abline() +
  geom_label()

summary(eff_iso3c)

library(rnaturalearth)
world <- ne_countries(scale = "medium", returnclass = "sf")


# Ensure ISO3C is uppercase for matching
eff_iso3c <- eff_iso3c %>% mutate(iso3c = toupper(iso3c))

# Merge data with world map
world_data <- world %>% left_join(eff_iso3c, by = c("iso_a3" = "iso3c"))

# Create individual maps
p1 <- ggplot(world_data) +
  geom_sf(aes(fill = efficiency), color = "grey20", size = 0.1) +
  scale_fill_viridis_c(option = "viridis", na.value = "grey80") +
  theme_minimal() +
  ggtitle("Efficiency")

p2 <- ggplot(world_data) +
  geom_sf(aes(fill = live_weight_t_fm), color = "grey20", size = 0.1) +
  scale_fill_viridis_c(option = "viridis", na.value = "grey80") +
  theme_minimal() +
  ggtitle("Live Weight from Fishmeal")

p3 <- ggplot(world_data) +
  geom_sf(aes(fill = live_weight_t_farmed), color = "grey20", size = 0.1) +
  scale_fill_viridis_c(option = "viridis", na.value = "grey80") +
  theme_minimal() +
  ggtitle("Live Weight Farmed")

# Combine all plots with patchwork
p1 / p2 / p3  # Arranges them vertically

```

Save SI Tables

```{r}
SI_Table_2 <- read.csv(here("int/material_origins_ALL.csv")) %>%
  dplyr::select(common_name, sciname, `Species name from report/literature` = feed_report_spp_name, source_country_name = country, source_country_iso3c = iso3c, wholefish, trimmings, `Proportion of production which is trimmings derived` = trim_prop, `Capture production?` = capture, `Possible trash fish?` = trash_fish, Source = data_source_feed) %>%
  mutate(Source = case_when(
    Source == "skretting" ~ "Skretting 2022", 
    Source == "cargill" ~ "Cargill 2023", 
    Source == "biomar" ~ "Biomar 2023", 
    TRUE ~ Source
  ))

write.csv(SI_Table_2, here("outputs/SI/SI_Table_2.csv"), row.names = FALSE)

SI_Table_3 <- read.csv(here("outputs/all_fmfo_material_origins_reports.csv")) %>%
  rename(source_country_iso3c = iso3c)

write.csv(SI_Table_3, here("outputs/SI/SI_Table_3.csv"), row.names = FALSE)

total_2019 <- fm_data_adjusted %>%
  filter(year == 2019) %>%
  pull(product_weight_t) %>%
  sum()

si_table_4 <- fm_data_adjusted %>%
  filter(year == 2019) %>%
  group_by(`Gapfilling assumption` = method_trim_gf) %>%
  summarise(`Product accounted for (as percentage of ARTIS total, 2019)` = round((sum(product_weight_t, na.rm = TRUE)/total_2019)*100, 2),
            `Number of distinct species` = n_distinct(sciname),
            `Number of distinct countries` = n_distinct(source_country_iso3c)) %>%
  filter(!(`Gapfilling assumption` %in% c("wild caught salmon trimmings", "barnacle"))) %>%
  mutate(Source = 
           case_when(
             `Gapfilling assumption` %in% c("Asian trash fish assumption") ~ "Majluf et al. 2024",
             `Gapfilling assumption` %in% c("Assuming trimmings because production method is aquaculture") ~ "Bachis 2024; Skretting 2022; Xu & Ming 2018; Ytrestøyl et al. 2015, Penarubia et al. 2023",
             `Gapfilling assumption` %in% c("Assuming trimmings because these are shrimp or prawn") ~ "Bachis 2024; Hertrampf et al. 2000",
             `Gapfilling assumption` %in% c("Average trimmings proportion of genus from literature and reports") ~ "See SI Tables 2-3",
             `Gapfilling assumption` %in% c("Average trimmings proportion of source country and species from literature and reports") ~ "See SI Tables 2-3",
             `Gapfilling assumption` %in% c("Average trimmings proportion of species from literature and reports") ~ "See SI Tables 2-3",
             `Gapfilling assumption` %in% c("Average trimmings proportion per country from known data") ~ "See SI Tables 2-3",
             `Gapfilling assumption` %in% c("gapfilled whole fish because average price is lower than 3-year average whole fish price") ~ "Melnychuk et al. 2017",
             `Gapfilling assumption` %in% c("Lobster, crab, or abalone trimmings") ~ "Bachis 2024; Hertrampf et al. 2000",
             `Gapfilling assumption` %in% c("none") ~ "See SI Tables 2-3",
             `Gapfilling assumption` %in% c("squid, cuttlefish, or octopus trimmings") ~ "Bachis 2024; Hertrampf et al. 2000",
             `Gapfilling assumption` %in% c("Used fillet data to determine proportion of fishmeal which is trimmings") ~ "Gephart et al. 2024"
           ))

write.csv(si_table_4, here("outputs/SI/SI_Table_4.csv"), row.names = FALSE)

```

