---
title: "Establish trimmings origins"
output: html_document
date: "2024-07-24"
---

## Summary

Create a dataset which describes for every country and FAO fishing area the species which contribute (or don't) to trimmings fishmeal, based on feed sustainability reports from [BioMar](https://www.biomar.com/our-promise/sustainability-report) and [Skretting](https://www.skretting.com/en-au/sustainability/sustainability-reporting/footprint-report-salmon-feed-2022/use-of-marine-raw-materials/), and the [IFFO](https://www.iffo.com/product) 

 - look up species and country (or FAO area) listed in biomar/skretting/IFFO reports in the FAO capture production data
 - Filter for production being >0 in the last 5 years of data
 - take distinct of species, country, FAO area
 - Fill in the rest of the info (e.g., render (yes/no), trimmings (yes/no), capture (yes/no), and data source info
 - Join into one dataset
 
 Example: 
 
  - Biomar reports Atlantic Herring in FAO Fishing Area 27 as being used in trimmings AND render fisheries
  - Filter the FAO FishStat capture production data for atlantic herring and FAO fishing area 27
  - Filter for there actually being production in that country/fishing area
  - Fill in columns for render (i.e., is this used for render FM), trimmings (i.e., is this used for trimmings FM), capture (i.e., does this FM come from capture production), and then datasource info (from biomar, skrettying, etc.)
    - sciname = Clupea harengus, common_name = Atlantic herring, render = yes, trimmings = yes, capture = yes, datasource_feed = biomar, datasource_fao_area_country = FishStat capture, feed_report_spp_name = Atlantic Herring
 
 
**Do the above for each species and area listed in the biomar, skretting, and IFFO reports**


**NOTE:** Consider filtering the ARTIS database for country origins rather than the FAO capture database. 

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(taxize)

artis_aus <- read.csv(here("data/artis_request_clawson.csv"))

```


Read in FAO fisheries capture data

```{r}
fao_fish <- read.csv(file.path("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/global_capture_production_1950-2020.csv")) %>%
  clean_names()

```

Create empty dataframe which has columns: `sciname`, `common_name`, `fao_fishing_area`, `country`, `iso3c`, `render`, `trimmings`, `capture` , `data_source_feed`, `data_source_fao_area_country`, `feed_report_spp_name`

```{r}
fm_origins_df <- data.frame(sciname = NA, 
                         common_name = NA,
                         fao_fishing_area = NA, 
                         country = NA, 
                         iso3c = NA, 
                         wholefish = NA, 
                         trimmings = NA, 
                         trim_prop = NA,
                         capture = NA, 
                         data_source_feed = NA,
                         data_source_fao_area_country = NA,
                         feed_report_spp_name = NA)

```


Start working through species listed in BioMar sustainability report. 

```{r}

biomar_trimmings <- read.csv(here("data/Trimmings info - biomar.csv")) %>%
  clean_names() %>%
  filter(marine_protein_share != "0.00%") ## filter out any species/regions that do not do fish meal


head(biomar_trimmings, 1)
## biomar Atlantic Herring  27; trimming % = 78%

sci = as.character(comm2sci(com = "Atlantic herring"))

biomar_herring <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Atlantic herring")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         sciname = sci, 
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.78, 
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Atlantic Herring") # check to see these are filled in

fm_origins_df <- rbind(fm_origins_df, biomar_herring) %>%
  filter(!is.na(fao_fishing_area))

head(biomar_trimmings, 2)
## biomar Peruvian Anchoveta	87; trim prop = 0.15

# sci = as.character(comm2sci(com = "Peruvian anchoveta")) # nothing...
sci = "Engraulis ringens"

biomar_peru_anchovy <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 87) %>%
  filter(str_detect(asfis_species_name, "Anchoveta")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         sciname = sci, 
         wholefish = "yes",
         trimmings = "yes", 
         trim_prop = 0.15,
         capture = "yes",
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Peruvian Anchoveta") # check to see these are filled in

fm_origins_df <- rbind(fm_origins_df, biomar_peru_anchovy)


head(biomar_trimmings, 3)
## biomar Blue Whiting	27; trim_prop = 0.02

# sci = as.character(comm2sci(com = "Blue whiting")) ## nothing
sci = "Micromesistius poutassou"

biomar_whiting <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Blue whiting")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         sciname = sci, 
         wholefish = "yes",
         trimmings = "yes", 
         trim_prop = 0.02,
         capture = "yes",
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Blue Whiting") # check to see these are filled in

fm_origins_df <- rbind(fm_origins_df, biomar_whiting)


head(biomar_trimmings, 4)
## biomar Capelin	27; trim_prop = 0.6

# sci = as.character(comm2sci(com = "Capelin", db = "worms")) # nothing
sci <- "Mallotus villosus"


biomar_capelin <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Capelin|capelin")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         sciname = sci, 
         wholefish = "yes",
         trimmings = "yes", 
         trim_prop = 0.6,
         capture = "yes",
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Capelin") # check to see these are filled in

fm_origins_df <- rbind(fm_origins_df, biomar_capelin)

head(biomar_trimmings, 5)
## biomar Tuna Spp.	87, 57; trim_prop = 1

# sci = comm2sci(com = "Capelin") 

biomar_tuna <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 87 | fao_major_fishing_area_code == 57) %>%
  filter(str_detect(asfis_species_name, "Tuna|tuna")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Tuna Spp.") # check to see these are all filled in

comm_names_list <- unique(biomar_tuna$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname))

biomar_tuna <- biomar_tuna %>%
  left_join(., com_sci_df, by = "common_name")


fm_origins_df <- rbind(fm_origins_df, biomar_tuna)

head(biomar_trimmings, 6)
## biomar Pacific Mackerel Spp.	87, 77, 71; prop_trim = 0.97: because there are mackerel species which have "pacific" in their names, I'll filter for pacific in the name as well below

biomar_p_mack <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 87 | fao_major_fishing_area_code == 77| fao_major_fishing_area_code == 71) %>%
  filter(str_detect(asfis_species_name, "Pacific|pacific")) %>%
    filter(str_detect(asfis_species_name, "Mackerel|mackerel")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.97,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Pacific Mackerel Spp.") # check to see these are all filled in

comm_names_list <- unique(biomar_p_mack$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname)) %>%
  mutate(sciname = ifelse(common_name == "Pacific chub mackerel", "Scomber japonicus", sciname)) # fix this one since it's missing

biomar_p_mack <- biomar_p_mack %>%
  left_join(., com_sci_df, by = "common_name")


fm_origins_df <- rbind(fm_origins_df, biomar_p_mack)


head(biomar_trimmings, 8) ## skipping row 7, since it is "Wild Seafood By-Products, which we're not sure of what spp that could be.
## biomar Atlantic Sardine	27, 34, 37, 87; trim_prop =0.8; assuming this could mean any sardine species in the atlantic...
 

biomar_a_sardine <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27 | fao_major_fishing_area_code == 34 | fao_major_fishing_area_code == 37 | fao_major_fishing_area_code == 87) %>%
  filter(str_detect(asfis_species_name, "Sardine|sardine")) %>%
  filter(!str_detect(asfis_species_name, "Pacific|pacific")) %>% ## filter this out since it has its own row in the biomar data
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.8,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Atlantic Sardine") # check to see these are all filled in

comm_names_list <- unique(biomar_a_sardine$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name, db = "worms"))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname)) %>%
  mutate(sciname = ifelse(common_name == "European pilchard(=Sardine)", "Sardina pilchardus", sciname)) # fix this one since it is missing

biomar_a_sardine <- biomar_a_sardine %>%
  left_join(., com_sci_df, by = "common_name")


fm_origins_df <- rbind(fm_origins_df, biomar_a_sardine)


head(biomar_trimmings, 9) 
## biomar Atlantic Mackerel Spp. 27, 34; trim_prop = 0.77; assuming this could mean any mackerel species that has "atlantic" in its name, since there are species with that (e.g., atlantic mackerel, atlantic chub mackerel)
 

biomar_a_mack <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27 | fao_major_fishing_area_code == 34) %>%
  filter(str_detect(asfis_species_name, "Mackerel|mackerel")) %>%
  filter(!str_detect(asfis_species_name, "Pacific|pacific")) %>% ## filter this out since it has its own row in the biomar data
    filter(str_detect(asfis_species_name, "Atlantic|atlantic")) %>% 
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.77,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Atlantic Mackerel Spp.") # check to see these are all filled in

comm_names_list <- unique(biomar_a_mack$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname)) 

biomar_a_mack <- biomar_a_mack %>%
  left_join(., com_sci_df, by = "common_name")
 ## will need to fix "channel islands" at the end. Will just have to split this into GGY and JEY 

fm_origins_df <- rbind(fm_origins_df, biomar_a_mack)

head(biomar_trimmings, 10) 
## biomar Antarctic Krill 48 
 

biomar_krill <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 48) %>%
  filter(str_detect(asfis_species_name, "Antarctic Krill|Antarctic krill")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Antarctic Krill") # check to see these are all filled in

comm_names_list <- unique(biomar_krill$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", "Euphausia superba", sciname)) 

biomar_krill <- biomar_krill %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_krill)


head(biomar_trimmings, 12) # skipping 11, as we will do farmed seafood trimmings separately 
## biomar Anchovy 47, 77, 37, 27, 34, 87, 61 # we will take any anchovy species in these areas
 

biomar_anch <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 47 | fao_major_fishing_area_code == 77 | fao_major_fishing_area_code == 37 | fao_major_fishing_area_code == 27 | fao_major_fishing_area_code == 34 | fao_major_fishing_area_code == 87 | fao_major_fishing_area_code == 61) %>%
  filter(str_detect(asfis_species_name, "Anchovy|anchovy|anchoveta|Anchoveta|Anchovies|anchovies")) %>%
    filter(asfis_species_name != "Anchoveta(=Peruvian anchovy)") %>% # make sure not this one as it is already done
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.11,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Anchovy") # check to see these are all filled in

comm_names_list <- unique(biomar_anch$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname)) %>%
  mutate(sciname = ifelse(common_name == "Californian anchovy", "Engraulis mordax", sciname)) %>%
  mutate(sciname = ifelse(common_name == "Southern African anchovy", "Engraulis capensis", sciname)) # fix the couple that are missing
 

biomar_anch <- biomar_anch %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_anch)


head(biomar_trimmings, 13) # skipping 11, as we will do farmed seafood trimmings separately 
## biomar Atlantic cod 27 
 

biomar_a_cod <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Atlantic cod|Atlantic Cod")) %>%
    filter(asfis_species_name != "North Atlantic codling") %>% # make sure not this one as it is already done
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Atlantic Cod") # check to see these are all filled in

comm_names_list <- unique(biomar_a_cod$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname)) 
 

biomar_a_cod <- biomar_a_cod %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_a_cod)




head(biomar_trimmings, 14) 
## biomar Araucanian Herring 87
 

biomar_a_herring <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 87) %>%
  filter(str_detect(asfis_species_name, "Araucanian Herring|Araucanian herring")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Araucanian Herring") # check to see these are all filled in

comm_names_list <- unique(biomar_a_herring$common_name)

com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", "Strangomera bentincki", sciname))  # comm2sci didn't pick it up
 

biomar_a_herring <- biomar_a_herring %>%
  left_join(., com_sci_df, by = "common_name")


fm_origins_df <- rbind(fm_origins_df, biomar_a_herring)


head(biomar_trimmings, 15) 
## biomar Sardine 51: assume any sardine species in this area except "atlantic sardine" and "pacific sardine" since those are already/will be done separately
 

biomar_sardine <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 51) %>%
  filter(str_detect(asfis_species_name, "Sardine|sardine")) %>%
    filter(!str_detect(asfis_species_name, "Pacific|pacific")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.15,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Sardine")  %>%# check to see these are all filled in
  mutate(iso3c = ifelse(is.na(iso3c), "EAZ", iso3c)) # fill in missing zanzibar iso3c

comm_names_list <- unique(biomar_sardine$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname))  # comm2sci didn't pick it up
 

biomar_sardine <- biomar_sardine %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_sardine)


head(biomar_trimmings, 16) 
## biomar Sprat 27
 

biomar_sprat <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Sprat|sprat")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 0.2,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Sprat") # check to see these are all filled in

comm_names_list <- unique(biomar_sprat$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname))  # comm2sci didn't pick it up
 

biomar_sprat <- biomar_sprat %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_sprat)



head(biomar_trimmings, 17) 
## biomar Pacific Sardine 77, 81, 61, 87 ; treat it same way we do atlantic sardine
 

biomar_p_sardine <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 77 | fao_major_fishing_area_code == 81 | fao_major_fishing_area_code == 61 | fao_major_fishing_area_code == 87) %>%
  filter(str_detect(asfis_species_name, "Sardine|sardine")) %>%
    filter(str_detect(asfis_species_name, "Pacific|pacific")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Pacific Sardine") # check to see these are all filled in

comm_names_list <- unique(biomar_p_sardine$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", "Sardinops sagax", sciname))  # comm2sci didn't pick it up
 

biomar_p_sardine <- biomar_p_sardine %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_p_sardine)


head(biomar_trimmings, 18) 
## biomar Sandeel 27 
 

biomar_sandeel <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Sandeel|sandeel")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Sandeel") # check to see these are all filled in

comm_names_list <- unique(biomar_sandeel$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname))  # comm2sci didn't pick it up
 

biomar_sandeel <- biomar_sandeel %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_sandeel)



head(biomar_trimmings, 19) 
## biomar Menhaden 87, 61 
 

biomar_menhaden <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 87 | fao_major_fishing_area_code == 61) %>%
  filter(str_detect(asfis_species_name, "Menhaden|menhaden")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         trim_prop = 0,
         capture = "yes",
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Menhaden") # check to see these are all filled in

comm_names_list <- unique(biomar_menhaden$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname))  # comm2sci didn't pick it up
 

biomar_menhaden <- biomar_menhaden %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_menhaden)


## the last row of biomar report is "Other" so we will skip that

## based on feedback from rich, I'll also include species that biomar use for fish oil

biomar_trimmings <- read.csv(here("data/Trimmings info - biomar.csv")) %>%
  clean_names() %>%
  filter(marine_protein_share == "0.00%") ## filter out any species/regions that do not do fish meal



## biomar Alaska Pollock 67
 

biomar_pollock <- fao_fish %>% 
    filter(fao_major_fishing_area_code == 67) %>%
  filter(str_detect(asfis_species_name, "Alaska pollock|Alaska Pollock")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         trim_prop = 1,
         capture = "yes",
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Alaska Pollock") # check to see these are all filled in

comm_names_list <- unique(biomar_pollock$common_name)
com_sci_df <- data.frame(common_name = comm_names_list) %>%
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", "Gadus chalcogrammus", sciname))  # comm2sci didn't pick it up
 

biomar_pollock <- biomar_pollock %>%
  left_join(., com_sci_df, by = "common_name")

fm_origins_df <- rbind(fm_origins_df, biomar_pollock)

## we'll leave out sardinella bc it is already represented in the fish meal portion and we don't want duplicates

```

Now do the species in the biomar report that were aquaculture, E.g., "Farmed Seafood By-Products". We will assume all of these are Atlantic salmon and will use the FAO aquaculture production dataset for this instead of capture production dataset. 


```{r}
## read in aquaculture data from fao fishstat
fao_aqua <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/global_aquaculture_production_1950_2020.csv") %>%
  clean_names()

# biomar Farmed Seafood By-Products 87, 27; will assume it is all Atlantic salmon

biomar_farmed_trim <- fao_aqua %>%
    filter(fao_major_fishing_area_code == 87 | fao_major_fishing_area_code == 27) %>%
  filter(str_detect(asfis_species_name, "Atlantic salmon|Atlantic Salmon")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0 ) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "no",
         trim_prop = 1,
         data_source_feed = "biomar",
         data_source_fao_area_country = "FishStat aquaculture", 
         feed_report_spp_name = "Farmed Seafood By-Products")  %>% # check to see these are all filled in
  mutate(sciname = "Salmo salar")

fm_origins_df <- rbind(fm_origins_df, biomar_farmed_trim)

```


Now let's do the species from Skretting sustainability report

  
```{r}

skretting_spp <- read.csv(here("data/Trimmings info - skretting_origin_fish.csv")) %>%
  clean_names() %>% 
  filter(x_total_fishmeal != "")


head(skretting_spp, 1) # already have peruvian anchoveta listed as render through biomar, so skipping

head(skretting_spp, 2) # already have antarctic krill listed as render through biomar, so skipping

head(skretting_spp, 3) # Albacore tuna; American Samoa; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_albacore_asm <- fao_fish %>%
  filter(country_name == "American Samoa") %>%
  filter(str_detect(asfis_species_name, "Albacore|albacore")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes",
         trim_prop = 1,
         capture = "yes",
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Albacore tuna") %>% # check to see these are all filled in
  mutate(sciname = "Thunnus alalunga")


fm_origins_df <- rbind(fm_origins_df, skretting_albacore_asm)


head(skretting_spp, 4) # Skipjack tuna, American Samoa; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_skipjack_asm <- fao_fish %>%
  filter(country_name == "American Samoa") %>%
  filter(str_detect(asfis_species_name, "Skipjack|skipjack")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Skipjack tuna") %>% # check to see these are all filled in
  mutate(sciname = "Katsuwonus pelamis")

fm_origins_df <- rbind(fm_origins_df, skretting_skipjack_asm)

head(skretting_spp, 5) # Yellowfin tuna, American Samoa; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_yellowfin_asm <- fao_fish %>%
  filter(country_name == "American Samoa") %>%
  filter(str_detect(asfis_species_name, "Yellowfin tuna|yellowfin tuna|Yellowfin Tuna")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Yellowfin tuna") %>% # check to see these are all filled in
  mutate(sciname = "Thunnus albacares")

fm_origins_df <- rbind(fm_origins_df, skretting_yellowfin_asm)

head(skretting_spp, 6) # Albacore, Mauritius; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_albacore_mus <- fao_fish %>%
  filter(country_name == "Mauritius") %>%
  filter(str_detect(asfis_species_name, "Albacore|albacore")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Albacore") %>% # check to see these are all filled in
  mutate(sciname = "Thunnus alalunga")

fm_origins_df <- rbind(fm_origins_df, skretting_albacore_mus)


head(skretting_spp, 7) # Bigeye Tuna, Mauritius; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_bigeye_mus <- fao_fish %>%
  filter(country_name == "Mauritius") %>%
  filter(str_detect(asfis_species_name, "Bigeye Tuna|Bigeye tuna")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Bigeye Tuna") %>% # check to see these are all filled in
  mutate(sciname = "Thunnus obesus")

fm_origins_df <- rbind(fm_origins_df, skretting_bigeye_mus)


head(skretting_spp, 8) # Skipjack tuna, Mauritius; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_skipjack_mus <- fao_fish %>%
  filter(country_name == "Mauritius") %>%
  filter(str_detect(asfis_species_name, "Skipjack Tuna|Skipjack tuna")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Skipjack tuna") %>% # check to see these are all filled in
  mutate(sciname = "Thunnus pelamis")

fm_origins_df <- rbind(fm_origins_df, skretting_skipjack_mus)

head(skretting_spp, 9) # Yellowfin tuna, Mauritius; we already have tuna spp in biomar, however, we do not have it for american samoa, so we will keep these
# we will keep any FAO area that shows up for this

skretting_yellowfin_mus <- fao_fish %>%
  filter(country_name == "Mauritius") %>%
  filter(str_detect(asfis_species_name, "Yellowfin tuna|Yellowfin Tuna")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Yellowfin tuna") %>% # check to see these are all filled in
  mutate(sciname = "Thunnus albacares")

fm_origins_df <- rbind(fm_origins_df, skretting_yellowfin_mus)

head(skretting_spp, 10) # Gemfish, New Zealand; 
# we will keep any FAO area that shows up for this

skretting_gemfish_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Gemfish|gemfish")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Gemfish") %>% # check to see these are all filled in
  mutate(sciname = "Rexea solandri")

fm_origins_df <- rbind(fm_origins_df, skretting_gemfish_nzl)

head(skretting_spp, 11) # Southern Hake, New Zealand; 
# we will keep any FAO area that shows up for this

skretting_hake_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Southern hake|southern hake|Southern Hake")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Southern Hake") %>% # check to see these are all filled in
  mutate(sciname = "Merluccius australis")

fm_origins_df <- rbind(fm_origins_df, skretting_hake_nzl)


head(skretting_spp, 12) # Hoki, New Zealand; "Hoki" doesn't exist in FAO data, but it is the same as blue grenadier, so we will use that
# we will keep any FAO area that shows up for this

skretting_hoki_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Blue grenadier|blue grenadier")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Hoki") %>% # check to see these are all filled in
  mutate(sciname = "Macruronus novaezelandiae")

fm_origins_df <- rbind(fm_origins_df, skretting_hoki_nzl)



head(skretting_spp, 13) # Javelinfish, New Zealand; "Javelinfish" doesn't exist in FAO data, but it is the same as Thorntooth grenadier, so we will use that
# we will keep any FAO area that shows up for this

skretting_javi_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Thorntooth grenadier|thorntooth grenadier")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Javelinfish") %>% # check to see these are all filled in
  mutate(sciname = "Lepidorhynchus denticulatus")

fm_origins_df <- rbind(fm_origins_df, skretting_javi_nzl)


head(skretting_spp, 14) # New Zealand ling, New Zealand; "New Zealand ling" doesn't exist in FAO data, but it is the same as Pink cusk-eel, so we will use that
# we will keep any FAO area that shows up for this

skretting_ling_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Pink cusk-eel")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "New Zealand ling") %>% # check to see these are all filled in
  mutate(sciname = "Genypterus blacodes")

fm_origins_df <- rbind(fm_origins_df, skretting_ling_nzl)




head(skretting_spp, 15) # Rattail, New Zealand; 
# we will keep any FAO area that shows up for this

skretting_rat_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Rattail|rattail")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Rattail") %>% # check to see these are all filled in
  mutate(sciname = as.character(comm2sci(com = common_name))) %>%
  mutate(sciname = ifelse(sciname == "character(0)", NA, sciname))

fm_origins_df <- rbind(fm_origins_df, skretting_rat_nzl)



head(skretting_spp, 16) # Hake, South Africa; specifically "Merluccius australis", which is Southern hake
# we will keep any FAO area that shows up for this

skretting_hake_zaf <- fao_fish %>%
  filter(country_name == "South Africa") %>%
  filter(str_detect(asfis_species_name, "Southern Hake|Southern hake")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "no",
         trimmings = "yes", 
         capture = "yes",
         trim_prop = 1,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Hake") %>% # check to see these are all filled in
  mutate(sciname = "Merluccius australis")

fm_origins_df <- rbind(fm_origins_df, skretting_hake_zaf)

## now lets do the species and countries that skretting specifically list as wholefish render

skretting_spp <- read.csv(here("data/Trimmings info - skretting_origin_fish.csv")) %>%
  clean_names() %>% 
  filter(x_total_fishmeal == "")

head(skretting_spp, 1) # Blue Mackerel, Scomber australasiucus, Australia
# we will keep any FAO area that shows up for this

skretting_b_mack_aus <- fao_fish %>%
  filter(country_name == "Australia") %>%
  filter(str_detect(asfis_species_name, "Blue Mackerel|Blue mackerel")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Blue Mackerel") %>% # check to see these are all filled in
  mutate(sciname = "Scomber australasiucus") 

fm_origins_df <- rbind(fm_origins_df, skretting_b_mack_aus)



head(skretting_spp, 2) # Jackmackerel, Trachurus declivis, Australia
# we will keep any FAO area that shows up for this

skretting_j_mack_aus <- fao_fish %>%
  filter(country_name == "Australia") %>%
  filter(str_detect(asfis_species_name, "Jackmackerel|Jack mackerel|jack mackerel")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Jackmackerel") %>% # check to see these are all filled in
  mutate(sciname = "Trachurus declivis")

fm_origins_df <- rbind(fm_origins_df, skretting_j_mack_aus)


head(skretting_spp, 3) # Red Bait, Emmelichthys nitidus, Australia
# Nothing showing up for this, so skipping

head(skretting_spp, 4) # Araucanian herring, 	Strangomera bentincki, Chile; already present in biomar data, skipping

head(skretting_spp, 5) # Jackmackerel, 	Trachurus murphyi, Chile

skretting_jmack_chl <- fao_fish %>%
  filter(country_name == "Chile") %>%
  filter(str_detect(asfis_species_name, "Jackmackerel|Jack mackerel|jack mackerel")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Jackmackerel") %>% # check to see these are all filled in
  mutate(sciname = "Trachurus murphyi")

fm_origins_df <- rbind(fm_origins_df, skretting_jmack_chl)



head(skretting_spp, 6) # Mote Sculpin, 	Normanichthys crockeri, Chile

skretting_sculp_chl <- fao_fish %>%
  filter(country_name == "Chile") %>%
  filter(str_detect(asfis_species_name, "Mote Sculpin|Mote sculpin")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Mote Sculpin") %>% # check to see these are all filled in
  mutate(sciname = "Normanichthys crockeri") 

fm_origins_df <- rbind(fm_origins_df, skretting_sculp_chl)


head(skretting_spp, 7) # Peruvian anchoveta, Chile; already in biomar data, skipping


head(skretting_spp, 8) # Starry Butterfish, Stromateus stellatus, Chile

skretting_butter_chl <- fao_fish %>%
  filter(country_name == "Chile") %>%
  filter(str_detect(asfis_species_name, "Starry Butterfish|Starry butterfish|butter|Butterfish")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Starry Butterfish") %>% # check to see these are all filled in
  mutate(sciname = "Stromateus stellatus") 

fm_origins_df <- rbind(fm_origins_df, skretting_butter_chl)


head(skretting_spp, 9) # Anchovy, 	Stolephorus chinensis, China; this specific species doesn't exist in the fisheries data, skipping

head(skretting_spp, 10) # 	Japanese Anchovy, 	Engraulis japonicus, China

skretting_janch_chn <- fao_fish %>%
  filter(country_name == "China") %>%
  filter(str_detect(asfis_species_name, "Japanese Anchovy|Japanese anchovy")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Japanese Anchovy") %>% # check to see these are all filled in
  mutate(sciname = "Engraulis japonicus") 

fm_origins_df <- rbind(fm_origins_df, skretting_janch_chn)


head(skretting_spp, 11) # Sardine, Sardinella longiceps, India; already exists in biomar data, skipping


head(skretting_spp, 12) # Sardine, Sardinella aurita, Mexico

skretting_sard_mex <- fao_fish %>%
  filter(country_name == "Mexico") %>%
  filter(str_detect(asfis_species_name, "Round sardinella")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Sardine") %>% # check to see these are all filled in
  mutate(sciname = "Sardinella aurita") ## well theres no production listed... so i guess we leave it out! Gonna keep the code here for posterity 

fm_origins_df <- rbind(fm_origins_df, skretting_sard_mex)


head(skretting_spp, 13) # other; skipping

head(skretting_spp, 14) # Spiny dogfish; Squalus acanthias; NZL 


skretting_dog_nzl <- fao_fish %>%
  filter(country_name == "New Zealand") %>%
  filter(str_detect(asfis_species_name, "Spiny dogfish|Picked dogfish")) %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
    distinct(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name) %>% 
  dplyr::select(common_name = asfis_species_name, fao_fishing_area = fao_major_fishing_area_code, country = country_name) %>%
  mutate(iso3c = countrycode(sourcevar = country, destination = "iso3c", origin = "country.name"),
         wholefish = "yes",
         trimmings = "no", 
         capture = "yes",
         trim_prop = 0,
         data_source_feed = "skretting",
         data_source_fao_area_country = "FishStat capture", 
         feed_report_spp_name = "Spiny dogfish") %>% # check to see these are all filled in
  mutate(sciname = "Squalus acanthias") 

fm_origins_df <- rbind(fm_origins_df, skretting_dog_nzl)

```


Clean the data:

 - Split "Channel Islands" into GGY and JEY; 2 separate rows 
 - remove any duplicates 
 - fix missing scientific names of higher level taxon names
 
 
```{r}
channel_islands_df <- fm_origins_df %>%
  filter(country == "Channel Islands") %>%
  mutate(iso3c = "GGY, JEY") %>%
  separate_rows(iso3c, sep = ",")


fm_origins_df_fin <- fm_origins_df %>%
  filter(country != "Channel Islands") %>%
  rbind(., channel_islands_df) %>%
  distinct() %>%
    mutate(sciname = ifelse(common_name == "Ridge scaled rattail", "Macrourus carinatus", sciname)) # fix this one

## filter artis data for one word scinames

artis_family_names <- artis_aus %>% 
    filter(str_count(sciname, "\\S+") == 1) %>%
  pull(sciname) %>%
  unique() %>%
  data.frame()

trim_family_names <- fm_origins_df_fin %>%
  filter(is.na(sciname))

## add scinames to the larger taxanomic family names that are listed in the ARTIS database. We should have no NAs in sciname now
fm_origins_df_names <- fm_origins_df_fin %>%
  mutate(sciname = ifelse(common_name == "Sardinellas nei", "sardinella", sciname),
         sciname = ifelse(common_name %in% c("Tuna-like fishes nei", "Tunas nei"), "thunnus", sciname),
         sciname = ifelse(common_name %in% c("Frigate and bullet tunas"), "auxis", sciname),
         sciname = ifelse(common_name %in% c("Grenadiers, rattails nei"), "macrouridae", sciname),
         sciname = ifelse(common_name %in% c("Herrings, sardines nei"), "clupeidae,clupea,clupeiformes", sciname),
         sciname = ifelse(common_name %in% c("Sandeels(=Sandlances) nei"), "ammodytes", sciname),
         sciname = ifelse(common_name %in% c("Stolephorus anchovies nei"), "stolephorus", sciname),
         sciname = ifelse(common_name %in% c("Anchovies, etc. nei"), "engraulidae,engraulis", sciname)) %>%
    separate_rows(sciname, sep = ",") %>%
  mutate(country = ifelse(country == "Other nei", "unknown", country),
         iso3c = ifelse(country == "unknown", "unknown", iso3c)) %>%
  mutate(sciname = tolower(sciname))

# engraulidae, engraulis

test <- fm_origins_df_names %>%
  filter(str_detect(sciname, ","))

trim_family_names <- fm_origins_df_names %>%
  filter(is.na(sciname))


write.csv(fm_origins_df_names, here("int/fishmeal_origins_biomar_skretting.csv"), row.names = FALSE)

```
 

Testing: Join to artis data for australia


```{r}
fm_origins_df_fin <- read.csv(here("int/fishmeal_origins_biomar_skretting.csv"))

artis_aus_trimmings <- artis_aus %>%
  left_join(fm_origins_df_fin, by = c("sciname", "source_country_iso3c" = "iso3c")) %>%
 # mutate(wholefish = ifelse(is.na(fao_fishing_area), "yes", wholefish)) %>% # if it is not in the trimmings data from feed reports, then it can be from wholefish fisheries
  mutate(wholefish = ifelse(sciname == "salmo salar", "no", wholefish),
         trimmings = ifelse(sciname == "salmo salar", "yes", trimmings)) %>%  # make all salmo salar trimmings no matter what? 
  mutate(trimmings = ifelse(method == "aquaculture", "yes", trimmings), # make any aquaculture method trimmings no matter what? 
         wholefish = ifelse(method == "aquaculture", "no", wholefish)) %>%
  mutate(capture = ifelse(method == "capture", "yes", capture)) %>%
  mutate(capture = ifelse(method == "aquaculture", "no", capture)) %>%
  mutate(trimmings = ifelse(str_detect(sciname, "thunnus"), "yes", trimmings),
         wholefish = ifelse(str_detect(sciname, "thunnus"), "no", wholefish)) 
# %>% # make any tuna catch method trimmings no matter what?
  # mutate(trim_liveweight = trim_prop*live_weight_t,
    #     trim_product = trim_prop*product_weight_t)


test <- artis_aus_trimmings %>%
  filter(str_count(sciname, "\\S+") == 1)
  
  
test <- artis_aus_trimmings %>%
  filter(year == 2020) %>% 
  filter(is.na(wholefish) & is.na(trimmings))

sum(test$product_weight_t) # 9880.987
sum(test$live_weight_t) # 29397.98

artis_aus_trimmings %>% 
  filter(year == 2020) %>%
  pull(product_weight_t) %>%
  sum() # 37542.96

artis_aus_trimmings %>% 
  filter(year == 2020) %>%
  pull(live_weight_t) %>%
  sum() # 111698.1


9880.987/37542.96 # 0.2631915 product
29397.98/111698.1 # 0.2631914 liveweight


## need to know:
## prop of spp that we consider trimmings only that are in our data that there was info for

## trimmings only
test <- artis_aus_trimmings %>%
  filter(year == 2020) %>% 
  filter(wholefish == "no" & trimmings == "yes")

sum(test$product_weight_t) # 8836.265
sum(test$live_weight_t) # 26289.71


8836.265/37542.96 # 0.2353641 product
26289.71/111698.1 # 0.235364 liveweight


test <- artis_aus_trimmings %>%
  filter(year == 2020) %>% 
  filter(wholefish == "yes" & trimmings == "yes")

sum(test$product_weight_t) # 15955.14
sum(test$live_weight_t) # 47469.85



15955.14/37542.96 # 0.4249835 product
47469.85/111698.1 # 0.4249835 liveweight


## only wholefish

test <- artis_aus_trimmings %>%
  filter(year == 2020) %>% 
  filter(wholefish == "yes" & trimmings == "no")

sum(test$product_weight_t) # 2870.567
sum(test$live_weight_t) # 8540.53



2870.567/37542.96 # 0.07646086 product
8540.53/111698.1 # 0.07646084 liveweight

## need to figure out larger taxanomic family name joining... for example, Sardinella nei in our data vs. "sardinella" in artis data
# /mnt/rdsi/raw_data/sea-around-us/ex-vessel-prices/outputFMFO2021-03-12.csv

## use price data to inform trimmings spp; for example, nobody will be catching snapper for wholefish rendering into FM.. if the fish is above a certain $$ ====> trimmings.. there is price data on rdsi specifically for FMFO.. Establish this cutoff price based on yearly prices. Can also incorporate fishmeal prices.. e.g. they wont render spp that exceed value of FM 
 # - join ts of FM to price data


prices <- read.csv("/mnt/rdsi/raw_data/sea-around-us/ex-vessel-prices/outputFMFO2021-03-12.csv")
taxa <- read.csv("/mnt/rdsi/raw_data/sea-around-us/ex-vessel-prices/taxa.csv")

prices_taxa <- prices %>% 
  left_join(., taxa, by = "TaxonKey") %>%
  mutate(TaxonName = tolower(TaxonName))


test_prices <- test %>%
  dplyr::select(sciname) %>%
  distinct(sciname) %>%
  left_join(prices_taxa, by = c("sciname" = "TaxonName")) %>%
  filter(!str_detect(CommonName, "Lobster|lobster|prawn|Prawn|crab|Crab|shrimp|Shrimp"))

```


