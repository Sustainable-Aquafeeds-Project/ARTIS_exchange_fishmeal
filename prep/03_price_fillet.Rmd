---
title: "Establish trimmings origins"
output: html_document
date: "2024-08-01"
---

## Summary


## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(taxize)
library(qs)

source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

fm_artis <- full_artis %>% 
  filter(hs6 == 230120)

fillet_artis <- full_artis %>%
  filter(hs6 != 230120)


artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) ## read in attribute table with common names


```

Testing: Join ARTIS data to biomar and skretting information. Provide summary stats for how much info is missing. 


```{r}
fm_origins_df_fin <- read.csv(here("outputs/all_fmfo_material_origins_reports.csv"))


ggplot(fm_origins_df_fin) +
  geom_histogram(aes(trim_prop)) +
  theme_bw() +
  labs(x = "Proportion of fishmeal derived from trimmings", 
       y = "Distinct species and source country count")

artis_trimmings_all <- fm_artis %>%
  left_join(artis_taxa) %>%
  left_join(fm_origins_df_fin, by = c("sciname", "source_country_iso3c" = "iso3c", "common_name")) 

artis_trimmings_info <- artis_trimmings_all %>% 
  filter(!is.na(trimmings)) %>%
  mutate(method_gf = NA,
         trimmings_gf = trimmings,
         wholefish_gf = wholefish,
         trim_prop_gf = trim_prop) %>%
  mutate(trimmings_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", "yes", trimmings_gf),
         wholefish_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", "no", wholefish_gf),
        trim_prop_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", 1, trim_prop_gf)) # fix the mexico yellowfin tuna instance

# test <- artis_trimmings_info %>% filter(is.na(wholefish)) # ok perfect, both empty
# test <- artis_trimmings_info %>% filter(is.na(trim_prop))

artis_trimmings_missing <- artis_trimmings_all %>% 
  filter(is.na(trimmings))

# nrow(artis_trimmings_missing) + nrow(artis_trimmings_missing) == nrow(artis_trimmings_all) # TRUE

# test <- artis_trimmings_missing %>% filter(!is.na(wholefish))
# test <- artis_trimmings_missing %>% filter(!is.na(trim_prop)) # perfect empty

artis_trimmings_gf <- artis_trimmings_missing %>% 
  mutate(trimmings_gf = 
           case_when(
             method == "aquaculture" ~ "yes",
             family == "salmonidae" ~ "yes",
             sciname == "salmoninae" ~ "yes",
             str_detect(family, "scombridae") ~ "yes",
             TRUE ~ trimmings
           ),
         wholefish_gf = 
           case_when(
             method == "aquaculture" ~ "no",
             family == "salmonidae" ~ "no",
             sciname == "salmoninae" ~ "no",
             str_detect(family, "scombridae") ~ "no",
             TRUE ~ wholefish
           ),
        trim_prop_gf = 
           case_when(
             method == "aquaculture" ~ 1, # assume aquaculture is all trimmings, unless feed reports suggest otherwise
             family == "salmonidae" ~ 1, # assume salmon is all trimmings
             sciname == "salmoninae" ~ 1, # assume salmon is all trimmings
             str_detect(family, "scombridae") ~ 1, # assume tuna is all trimmings
             TRUE ~ trim_prop
           ),
        method_gf = 
           case_when(
             method == "aquaculture" ~ "aquaculture", # assume aquaculture is all trimmings
             family == "salmonidae" ~ "salmon", # assume salmon is all trimmings
             sciname == "salmoninae" ~ "salmon", # assume salmon is all trimmings
             str_detect(family, "scombridae") ~ "tuna", # assume tuna is all trimmings
             TRUE ~ NA
           )
         ) %>%
  mutate(capture = 
           case_when(
             method == "capture" ~ "yes",
             method == "aquaculture" ~ "no",
             TRUE ~ capture
           )) %>%
  distinct()



## rbind back together after prelimnary gapfilling

artis_trimmings_all_gf <- artis_trimmings_info %>%
  rbind(., artis_trimmings_gf) %>%
  distinct() %>%
  dplyr::select(-wholefish, -trimmings, -trim_prop) %>%
mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing

# test <- artis_trimmings_all_gf %>% 
#   filter(!is.na(trimmings_gf) & is.na(wholefish_gf))
# 
# test <- artis_trimmings_all_gf %>% 
#   filter(is.na(trimmings_gf) & !is.na(wholefish_gf))
# 
# test <- artis_trimmings_all_gf %>% 
#   filter(family == "scombridae")
# 
# 
# test <- artis_trimmings_all_gf %>% 
#   filter(method == "aquaculture") %>%
#   filter(genus == "thunnus")

## ok looks like all gapfilling went good

test <- artis_trimmings_all_gf %>% filter(is.na(common_name)) ## 0 ok this is good! 

## lets save this to RDSI

write.csv(artis_trimmings_all_gf, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_not_gf.csv"), row.names = TRUE)

```

Data checking and exploration

```{r}

artis_trimmings_all_gf <- read.csv(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_not_gf.csv"))

### lets do some exploration on what is missing! 

## do some data checks for 2020 

artis_2020 <- artis_trimmings_all_gf %>% 
  filter(year == 2020)

## Species and countries that we have NO info on if it is trimmings or wholefish reduction
test1 <- artis_2020 %>%
  filter(is.na(wholefish_gf) & is.na(trimmings_gf))


sum(test1$product_weight_t) # 662046.4
sum(test1$live_weight_t) # 1969725

total_product_weight <- artis_2020 %>% 
  pull(product_weight_t) %>%
  sum() # 3494636

total_live_weight <- artis_2020 %>% 
  pull(live_weight_t) %>%
  sum() # 10397265


662046.4/total_product_weight # 0.1894464 product
1969725/total_live_weight # 0.1894464 liveweight

## ok about 19% of FM production in 2020, we have no info for! 



## trimmings only species
test2 <- artis_2020 %>%
  filter(wholefish_gf == "no" & trimmings_gf == "yes") 

sum(test2$trim_product) # 772568.7
sum(test2$trim_liveweight) # 2298552


772568.7/total_product_weight # 0.2210728 product
2298552/total_live_weight # 0.2210728 liveweight
## ok, ~22% we know for sure are used EXCLUSIVELY for trimmings... 

## lets take out crustaceans from that estimate to see

# https://www.feedipedia.org/node/202#:~:text=Shrimp%20meal%20or%20shrimp%20waste,made%20of%20fresh%20water%20shrimps.
# "Shrimp meal or shrimp waste meal is the undecomposed ground dried waste of shrimp. There are several types of shrimp meal on the market depending on the kind of raw material used. It can contain whole shrimps and/or shrimp parts such as the heads or shells. Shrimp meal may also be made of fresh water shrimps. Shrimp meal is a by-product of the shrimp industry. Approximately 70% of total shrimp landings become waste, so there is a tremendous tonnage of shrimp waste produced. A portion of the crude protein that is contained in shrimp meal is in the form of chitin, which is not readily digestible (GÃ¶hl, 1982)."

## so it seems like shrimp could be "wholefish" or "trimmings". Need to do some research on this...

# https://www.researchgate.net/publication/375923791_Potential_industrial_and_nutritional_applications_of_shrimp_by-products_a_review#:~:text=The%20main%20by%2Dproducts%20include,%2C%20and%20anti%2Doxidant%20properties.
## This suggests that shrimp byproducts from processing make up 40-60% of the whole shrimp.. so seems likely that most fishmeal from shrimp would be from trimmings?

# https://www.globalseafood.org/advocate/shrimp-processing-byproducts-find-many-uses/ ; this suggests the same thing and specifically says the byproducts are used to make feeds

# test <- artis_2020 %>%
#   filter(wholefish_gf == "no" & trimmings_gf == "yes") %>%
#   filter(phylum != "arthropoda")
# 
# sum(test$trim_product) # 526517.9
# sum(test$trim_liveweight) # 1566500
# 
# 
# 526517.9/total_product_weight # 0.1506646 product
# 1566500/total_live_weight # 0.1506646 live weight


## species that can be wholefish OR trimmings

test3 <- artis_2020 %>%
  filter(wholefish_gf == "yes" & trimmings_gf == "yes") 
# %>%
  # mutate(check = wholefish_product + trim_product) %>%
  # filter(check != product_weight_t) %>%
  # dplyr::select(check, product_weight_t) %>%
  # mutate(diff = check - product_weight_t) # ok all rounding error

sum(test3$trim_product) # 568264.3 # trimmings
sum(test3$trim_liveweight) # 1690704 # trimmings



568264.3/total_product_weight # 0.1626104 product trimmings 
1690704/total_live_weight # 0.1626105 liveweight trimmings


sum(test3$wholefish_product) # 1411996
sum(test3$wholefish_liveweight) # 4200980

1411996/total_product_weight # 0.4040466 product wholefish 
4200980/total_live_weight # 0.4040466 liveweight wholefish


## so now we are estimating ~38% of FM comes from trimmings, not including any of the missing species we have. IFFO reports 37% trimmings fishmeal for 2023
## without crustaceans included in that it is ~31%


## species and areas we know for sure are only wholefish

test4 <- artis_2020 %>%
  filter(wholefish_gf == "yes" & trimmings_gf == "no")

sum(test4$wholefish_product) # 79760.55
sum(test4$wholefish_liveweight) # 237304.1

# unique(test4$common_name)
#  [1] "pacific menhaden"          "antarctic krill"           "araucanian herring"        "south american pilchard"  
#  [5] "norway pout"               "boarfish"                  "sandeels(=sandlances) nei" "yellowfin tuna"           
#  [9] "sardinellas nei"           "small sandeel"             "saithe(=pollock)"          "gulf menhaden"   

79760.55/total_product_weight # 0.02282371 product
237304.1/total_live_weight # 0.0228237 liveweight
## we know for sure wholefish is ~2% + 34% = 36%

## so if we believe IFFO, then most of the remaining 19% should be mostly wholefish rendered? These numbers seem high for trimmings! 


0.02282371+0.4040466+0.1626104+0.2210728+0.1894464 # 0.99999999 - YAY

test <- artis_2020 %>%
  filter(trimmings_gf == "no" & wholefish_gf == "no")

## scenarios:
# trimmings NA and wholefish NA - done
# trimmings no and wholefish yes - done
# trimmings yes and wholefish no - done
# trimmings yes and wholefish yes - done
# trimmings no and wholefish no - done (there are none)


all_test <- rbind(test1, test2, test3, test4)

testing <- artis_2020 %>%
  group_by(trimmings_gf, wholefish_gf) %>% 
  summarise(trim_product = sum(trim_product),
            wholefish_product = sum(wholefish_product)
            ) %>%
  mutate(prop_trim = trim_product/total_product_weight,
         prop_wholefish = wholefish_product/total_product_weight)


## make cirlce chart showing this 


no_info_df <- artis_2020 %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- artis_2020 %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c("#FF9999", "#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )


```


Right now we're matching based on iso3c AND sciname. We could gapfill by taxa first and then use price data. However, this would assume that trimmings inclusion is the same regardless of origin. 

Let's try that gapfilling on sciname, regardless of origin, with the average proportion inclusion. And if it is a yes once, then we assume it is a yes everywhere.

For example, we will get an average trim_prop value for species, regardless of origin, and fill in the species. Should we do a weighted average on product weight? Yes. 

```{r}

sciname_averages <- artis_trimmings_all_gf %>%
  filter(!is.na(trimmings_gf)) %>%
  group_by(sciname, common_name) %>%
  summarise(trim_prop_avg = weighted.mean(trim_prop_gf, product_weight_t)) %>%
  ungroup()

spp_level_gapfill <- artis_trimmings_all_gf %>%
  filter(is.na(trimmings_gf) & is.na(wholefish_gf)) %>%
  left_join(sciname_averages) %>%
  mutate(trim_prop_gf = ifelse(!is.na(trim_prop_avg), trim_prop_avg, trim_prop_gf),
         method_gf = ifelse(!is.na(trim_prop_avg), "species", method_gf)) %>%
  mutate(trimmings_gf = case_when(
    trim_prop_gf == 1 ~ "yes",
    trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "no"
  ),
  wholefish_gf = case_when(
    trim_prop_gf == 1 ~ "no",
        trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "yes"
  )) %>%
  dplyr::select(-trim_prop_avg) %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing

## now join with un-gapfilled data

full_artis_spp_gf <- artis_trimmings_all_gf %>%
  filter(!is.na(wholefish_product)) %>%
  rbind(., spp_level_gapfill)

nrow(full_artis_spp_gf) == nrow(artis_trimmings_all_gf) # TRUE - perfect



## make cirlce chart showing this 


no_info_df <- full_artis_spp_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- full_artis_spp_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c("#FF9999", "#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Gapfilled with species averages") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )

```


Right now we're matching based on iso3c AND sciname. In the last chunk we gapfilled by species.

INSTEAD of that, let's try that gapfilling on source_iso3c, regardless of species, with the average proportion inclusion.

For example, we will get an average trim_prop value for iso3c, regardless of species, and fill in the values.

```{r}

iso3c_averages <- artis_trimmings_all_gf %>%
  filter(!is.na(trimmings_gf)) %>%
  group_by(source_country_iso3c) %>%
  summarise(trim_prop_avg = weighted.mean(trim_prop_gf, product_weight_t)) %>%
  ungroup()

iso3c_level_gapfill <- artis_trimmings_all_gf %>%
  filter(is.na(trimmings_gf) & is.na(wholefish_gf)) %>%
  left_join(iso3c_averages) %>%
  mutate(trim_prop_gf = ifelse(!is.na(trim_prop_avg), trim_prop_avg, trim_prop_gf),
         method_gf = ifelse(!is.na(trim_prop_avg), "species", method_gf)) %>%
  mutate(trimmings_gf = case_when(
    trim_prop_gf == 1 ~ "yes",
    trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "no"
  ),
  wholefish_gf = case_when(
    trim_prop_gf == 1 ~ "no",
        trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "yes"
  )) %>%
  dplyr::select(-trim_prop_avg) %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing

## now join with un-gapfilled data

full_artis_iso3c_gf <- artis_trimmings_all_gf %>%
  filter(!is.na(wholefish_product)) %>%
  rbind(., iso3c_level_gapfill)

nrow(full_artis_iso3c_gf) == nrow(artis_trimmings_all_gf) # TRUE - perfect



## make cirlce chart showing this 


no_info_df <- full_artis_iso3c_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- full_artis_iso3c_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c("#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Gapfilled with source country averages") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )

```

Ok, now lets gapfill the species level gapfill dataset with iso3c averages. So the gapfill flow is like this: 

 - species level first
 - iso3c level second
 
 
```{r}

iso3c_averages <- artis_trimmings_all_gf %>%
  filter(!is.na(trimmings_gf)) %>%
  group_by(source_country_iso3c) %>%
  summarise(trim_prop_avg = weighted.mean(trim_prop_gf, product_weight_t)) %>%
  ungroup()

iso3c_spp_level_gapfill <- full_artis_spp_gf %>%
  filter(is.na(trimmings_gf) & is.na(wholefish_gf)) %>%
  left_join(iso3c_averages) %>%
  mutate(trim_prop_gf = ifelse(!is.na(trim_prop_avg), trim_prop_avg, trim_prop_gf),
         method_gf = ifelse(!is.na(trim_prop_avg), "species", method_gf)) %>%
  mutate(trimmings_gf = case_when(
    trim_prop_gf == 1 ~ "yes",
    trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "no"
  ),
  wholefish_gf = case_when(
    trim_prop_gf == 1 ~ "no",
        trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "yes"
  )) %>%
  dplyr::select(-trim_prop_avg) %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing

## now join with un-gapfilled data

full_artis_spp_iso3c_gf <- full_artis_spp_gf %>%
  filter(!is.na(wholefish_product)) %>%
  rbind(., iso3c_spp_level_gapfill)

nrow(full_artis_spp_iso3c_gf) == nrow(artis_trimmings_all_gf) # TRUE - perfect


## make cirlce chart showing this 


no_info_df <- full_artis_spp_iso3c_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- full_artis_spp_iso3c_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c( "#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Gapfilled by species and then source country averages") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )


```
Ok, so the above great and all, but I don't think it necessarily reflects reality. Using price data in conjunction with fillets is probably a better way to gapfill... then if we still need to gapfill after that, we can use species and/or country level averages

Let's pull species which report fillets. We could do a number of things:

 - For our missing info: any species that is filleted, assume it is ALL trimmings (except salmon/tuna/aquaculture). Any species which is NOT filleted is considered ALL whole fish (probably not right, as shrimp/prawns are probably "trimmed").


```{r}

fillet_data <- fillet_artis %>% 
  distinct(year, source_country_iso3c, exporter_iso3c, importer_iso3c, sciname) %>%
  mutate(filleted = "yes")


simple_fillet_gf <- artis_trimmings_all_gf %>%
  left_join(fillet_data) %>%
  mutate(
  trimmings_gf = case_when(
    filleted == "yes" & is.na(trimmings_gf) ~ "yes",
    is.na(filleted) & is.na(trimmings_gf) ~ "no",
    TRUE ~ trimmings_gf
  ), 
  wholefish_gf = case_when(
    filleted == "yes" & is.na(wholefish_gf) ~ "no",
    is.na(filleted) & is.na(wholefish_gf) ~ "yes",
    TRUE ~ wholefish_gf
  )
  ) %>%
  mutate(trim_prop_gf = case_when(
    wholefish_gf == "yes" & trimmings_gf == "no" & is.na(trim_prop_gf) ~ 0,
    wholefish_gf == "no" & trimmings_gf == "yes" & is.na(trim_prop_gf) ~ 1,
    TRUE ~ trim_prop_gf
  )) %>%
    mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) 

test <- simple_fillet_gf %>%
  filter(is.na(trim_prop_gf)) # ok makes sense 


## make cirlce chart showing this 


no_info_df <- simple_fillet_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- simple_fillet_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c( "#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Gapfilled by filleted species") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )

```


Any species that is filleted, assume these are all species which are "trimmings only" (for species that don't already have info). Join with price data with comprehensive trimmings info, and get an average price for trimmings species (any species in data with info and trimmings == yes). Any species below that price will be considered all whole fish fish meal, UNLESS it is a filleted species (since we're assuming those are ALL trimmings). 

```{r}
## use price data to inform trimmings spp; for example, nobody will be catching snapper for wholefish rendering into FM.. if the fish is above a certain $$ ====> trimmings.. there is price data on rdsi specifically for FMFO.. Establish this cutoff price based on yearly prices. Can also incorporate fishmeal prices.. e.g. they wont render spp that exceed value of FM 
 # - join ts of FM to price data

prices <- read.csv("/mnt/rdsi/raw_data/sea-around-us/ex-vessel-prices/outputFMFO2021-03-12.csv")
taxa <- read.csv("/mnt/rdsi/raw_data/sea-around-us/ex-vessel-prices/taxa.csv")

entity <- read.csv("/mnt/rdsi/raw_data/sea-around-us/ex-vessel-prices/fishing_entity.csv") %>%
  dplyr::select(-X) %>%
  mutate(iso3c = countrycode(sourcevar = name, origin = "country.name", destination = "iso3c"))

prices_taxa <- prices %>% 
  left_join(., taxa, by = "TaxonKey") %>%
    clean_names() %>%
  left_join(., entity, by = "fishing_entity_id") %>%
  mutate(sciname = tolower(taxon_name),
         common_name = tolower(common_name)) %>%
  dplyr::select(year, source_country_iso3c = iso3c, sciname, iso3c, year, price2010usd_mean, price2010usd_ci) %>%
  filter(!is.na(source_country_iso3c)) 
#%>% # filter out territories for now
 # left_join(artis_taxa)

## gapfill the fillets first 
fillet_gf <- artis_trimmings_all_gf %>%
  left_join(fillet_data) %>%
  mutate(
  trimmings_gf = case_when(
    filleted == "yes" & is.na(trimmings_gf) ~ "yes",
    TRUE ~ trimmings_gf
  ), 
  wholefish_gf = case_when(
    filleted == "yes" & is.na(wholefish_gf) ~ "no",
    TRUE ~ wholefish_gf
  )
  ) %>%
  mutate(trim_prop_gf = case_when(
    wholefish_gf == "no" & trimmings_gf == "yes" & is.na(trim_prop_gf) ~ 1,
    TRUE ~ trim_prop_gf
  ))


avg_trim_prices <- artis_trimmings_all_gf %>%
  filter(!is.na(trimmings_gf)) %>%
  left_join(prices_taxa) %>%
  group_by(sciname) %>%
  mutate(avg_usd_sciname = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>% ## missing ~15% of prices
  group_by(genus) %>%
    mutate(avg_usd_genus = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>% # missing ~6%
  group_by(family) %>%
  mutate(avg_usd_family = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>%
    group_by(order) %>%
  mutate(avg_usd_order = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>%
      group_by(class) %>%
  mutate(avg_usd_class = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(phylum) %>%
  mutate(avg_usd_phylum = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(kingdom) %>%
    mutate(avg_usd_kingdom = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(avg_usd_gf = ifelse(is.na(price2010usd_mean), avg_usd_sciname, price2010usd_mean)) %>%
  mutate(avg_usd_gf = ifelse(is.na(avg_usd_gf), avg_usd_genus, avg_usd_gf)) %>%
  mutate(avg_usd_gf = ifelse(is.na(avg_usd_gf), avg_usd_family, avg_usd_gf)) %>%
  mutate(avg_usd_gf = ifelse(is.na(avg_usd_gf), avg_usd_order, avg_usd_gf)) %>%
  mutate(avg_usd_gf = ifelse(is.na(avg_usd_gf), avg_usd_class, avg_usd_gf)) %>%
    mutate(avg_usd_gf = ifelse(is.na(avg_usd_gf), avg_usd_phylum, avg_usd_gf)) %>%
    mutate(avg_usd_gf = ifelse(is.na(avg_usd_gf), avg_usd_kingdom, avg_usd_gf)) %>%
  filter(trim_prop_gf == 1) %>%
  group_by(year, source_country_iso3c) %>%
  summarise(avg_year_iso3c_prices = mean(avg_usd_gf, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(source_country_iso3c) %>%
  mutate(avg_iso3c_price = mean(avg_year_iso3c_prices, na.rm = TRUE)) %>%
  ungroup()


global_avg_price <- 339.8605


fillet_price_empty_gf <- fillet_gf %>%
  filter(is.na(filleted)) %>%
  filter(is.na(trimmings_gf)) %>%
  left_join(avg_trim_prices) %>%
  mutate(global_avg_price = 339.8605) %>%
  left_join(prices_taxa) %>%
  mutate(trim_prop_gf = ifelse(price2010usd_mean < avg_year_iso3c_prices, 0, trim_prop_gf)) %>%
    mutate(trim_prop_gf = ifelse(price2010usd_mean < avg_iso3c_price & is.na(trim_prop_gf), 0, trim_prop_gf)) %>%
      mutate(trim_prop_gf = ifelse(price2010usd_mean < global_avg_price & is.na(trim_prop_gf), 0, trim_prop_gf)) %>%
  dplyr::select(colnames(fillet_gf))

summary(fillet_price_empty_gf)


fillet_price_all_gf <- fillet_gf %>%
  filter(!is.na(trim_prop_gf)) %>%
  rbind(., fillet_price_empty_gf) %>%
  distinct() %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) 

nrow(fillet_price_all_gf) == nrow(fillet_gf) # perfect
nrow(fillet_price_all_gf) == nrow(artis_trimmings_all_gf) # perfect

## make cirlce chart showing this 


no_info_df <- fillet_price_all_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- fillet_price_all_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c("#FF9999", "#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Gapfilled with fillet and price data") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )

```


Now add species average gapfilling to the above


```{r}
sciname_averages <- artis_trimmings_all_gf %>%
  filter(!is.na(trimmings_gf)) %>%
  group_by(sciname, common_name) %>%
  summarise(trim_prop_avg = weighted.mean(trim_prop_gf, product_weight_t)) %>%
  ungroup()

spp_level_gapfill <- fillet_price_all_gf %>%
  filter(is.na(trim_prop_gf)) %>%
  left_join(sciname_averages) %>%
  mutate(trim_prop_gf = ifelse(!is.na(trim_prop_avg), trim_prop_avg, trim_prop_gf),
         method_gf = ifelse(!is.na(trim_prop_avg), "species", method_gf)) %>%
  mutate(trimmings_gf = case_when(
    trim_prop_gf == 1 ~ "yes",
    trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "no"
  ),
  wholefish_gf = case_when(
    trim_prop_gf == 1 ~ "no",
        trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "yes"
  )) %>%
  dplyr::select(-trim_prop_avg) %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing

## now join with un-gapfilled data

full_artis_spp_gf <- fillet_price_all_gf %>%
  filter(!is.na(trim_prop_gf)) %>%
  rbind(., spp_level_gapfill)


## make cirlce chart showing this 


no_info_df <- full_artis_spp_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- full_artis_spp_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c("#FF9999", "#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Whole fish and by-products, gapfilled with fillet and price data, then species averages") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )


```

Now add country averages to the above

```{r}
iso3c_averages <- artis_trimmings_all_gf %>%
  filter(!is.na(trimmings_gf)) %>%
  group_by(source_country_iso3c) %>%
  summarise(trim_prop_avg = weighted.mean(trim_prop_gf, product_weight_t)) %>%
  ungroup()

iso3c_level_gapfill <- full_artis_spp_gf %>%
  filter(is.na(trim_prop_gf)) %>%
  left_join(iso3c_averages) %>%
  mutate(trim_prop_gf = ifelse(!is.na(trim_prop_avg), trim_prop_avg, trim_prop_gf),
         method_gf = ifelse(!is.na(trim_prop_avg), "species", method_gf)) %>%
  mutate(trimmings_gf = case_when(
    trim_prop_gf == 1 ~ "yes",
    trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "no"
  ),
  wholefish_gf = case_when(
    trim_prop_gf == 1 ~ "no",
        trim_prop_gf > 0 & trim_prop_gf < 1 ~ "yes",
    trim_prop_gf == 0 ~ "yes"
  )) %>%
  dplyr::select(-trim_prop_avg) %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing

## now join with un-gapfilled data

full_artis_iso3c_gf <- full_artis_spp_gf %>%
  filter(!is.na(trim_prop_gf)) %>%
  rbind(., iso3c_level_gapfill)

nrow(full_artis_iso3c_gf) == nrow(artis_trimmings_all_gf) # TRUE - perfect



## make cirlce chart showing this 


no_info_df <- full_artis_iso3c_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

circle_plot_df <- full_artis_iso3c_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type)) %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop)


# Plot the donut chart
ggplot(circle_plot_df, aes(x = 2, y = prop, fill = fishmeal_type)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(y = ypos, label = label), color = "black") +
 scale_fill_manual(values = c("#FFCC99", "#99CCFF")) +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Fishmeal Type",
       title = "World's fishmeal in 2020",
       subtitle = "Gapfilled with fillet and price data, \nthen species and iso3c averages") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12)
  )


```

Let's take a look at the distribution of the "not sure" category in our data

 - by continent
 - by species taxa grouping


```{r}

artis_trimmings <- read.csv(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_not_gf.csv"))
colnames(artis_trimmings)

unknown_fm <- artis_trimmings %>% 
  filter(year == 2020) %>%
  filter(is.na(trimmings_gf) & is.na(wholefish_gf)) %>%
  dplyr::select(-X)

unique(unknown_fm$source_country_iso3c)
length(unique(unknown_fm$sciname))

test <- unknown_fm %>% 
  group_by(source_country_iso3c, sciname) %>%
  summarise(live_weight_t = sum(live_weight_t, na.rm = TRUE),
            product_weight_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup()


## test out plotting family

# Summarize the total product_weight_t for each family
family_summary <- unknown_fm %>%
  group_by(class) %>%
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE)) %>%
  filter(total_product_weight > 0)  # Filter out families with no weight

# Group smaller families into "Other"
# threshold <- 0.01 * sum(family_summary$total_product_weight)  # 1% threshold
# family_summary <- family_summary %>%
#   mutate(family = ifelse(total_product_weight < threshold, "Other", family)) %>%
#   group_by(family) %>%
#   summarise(total_product_weight = sum(total_product_weight))

# Create the pie chart
ggplot(family_summary, aes(x = "", y = total_product_weight, fill = class)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  labs(title = "Fish meal with missing information",
       x = NULL, y = NULL) +
  theme_void() +
  theme(legend.position = "right")

test <- unknown_fm %>% filter(is.na(class))

test <- unknown_fm %>% filter(class == "actinopterygii") %>%
  group_by(sciname) %>% 
  summarise(product_w = sum(product_weight_t)) %>%
  ungroup() %>%
  mutate(prop = product_w/363945.9)

## try isscaap category


# Summarize the total product_weight_t for each family
family_summary <- unknown_fm %>%
  group_by(isscaap) %>%
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE)) %>%
  filter(total_product_weight > 0)  # Filter out families with no weight

# Create the pie chart
ggplot(family_summary, aes(x = "", y = total_product_weight, fill = isscaap)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  labs(title = "Fish meal with missing information",
       x = NULL, y = NULL) +
  theme_void() +
  theme(legend.position = "right")

test <- unknown_fm %>% filter(str_detect(common_name, "prawn|shrimp"))

## now try continent 

countries <- read.csv(here("data/countries.csv"))

unknown_fm_countries <- unknown_fm %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c"))



# Summarize the total product_weight_t for each family
summary <- unknown_fm_countries %>%
  group_by(owid_region) %>%
  summarise(total_product_weight = sum(product_weight_t, na.rm = TRUE)) %>%
  filter(total_product_weight > 0) %>%  # Filter out families with no weight
  mutate(owid_region = ifelse(is.na(owid_region), "Unknown", owid_region))

# Create the pie chart
ggplot(summary, aes(x = "", y = total_product_weight, fill = owid_region)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  labs(fill = "Continent",
       x = NULL, y = NULL) +
  theme_void() +
  theme(legend.position = "right")

test <- unknown_fm_countries %>% filter(is.na(owid_region))
unique(test$source_country_iso3c) # all unknown

```

