---
title: "Establish trimmings origins for Havfisk"
output: html_document
date: "2024-07-24"
---


```{r setup}

knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(janitor)
library(countrycode)
library(taxize)
library(qs)
library(stringi)
library(strex)
library(dplyr)
library(purrr)

source(here("R/directories.R"))


artis_version <- "old"

if(artis_version == "new"){
  
artis_taxa <- read.csv(file.path(artis_dir, "ARTIS_1.1.0_FAO_2025_08_02/attribute-tables/sciname_metadata.csv")) %>%
  clean_names() %>%
  dplyr::select(-aquarium, -fresh01, -brack01, -saltwater01)

fm_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_2025_08_12.qs")) %>%
  dplyr::select(year, source_country_iso3c, exporter_iso3c, consumer_iso3c, sciname, habitat, method, product_weight_t, live_weight_t) %>%
  mutate(exporter_iso3c = ifelse(source_country_iso3c == consumer_iso3c & is.na(exporter_iso3c), source_country_iso3c, exporter_iso3c))

}else{
  
  fm_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_2024_09_19.qs")) %>%
      mutate(hs6 = 230120,
         dom_source = ifelse(dom_source == "", consumption_type, dom_source)) %>%
  dplyr::select(year, source_country_iso3c, exporter_iso3c, consumer_iso3c, dom_source, hs6, sciname, habitat, method, product_weight_t, live_weight_t = consumption_t_capped) %>%
  mutate(exporter_iso3c = ifelse(source_country_iso3c == consumer_iso3c, source_country_iso3c, exporter_iso3c))
  
  artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) ## read in attribute table with common names
  
}


test <- fm_artis %>%
  filter(sciname == "salmo salar") # new version doesn't have any salmon fishmeal... 

```

### Data Sources

Shea et al. 2025
https://www.science.org/doi/10.1126/sciadv.adr6921
Spatial distribution of fishmeal and fish oil factories around the globe

## Summary

Their supplementary material provides a csv (located at `data/shea_et_al_FMFO/adr6921_Suppl_Excel_v2.csv`) that describes the raw material (often with a species label), if it is by products or whole fish, and country of the fish meal factory. We will grab the country and species and use this in our database. 

Step 1: Tidy the  data

```{r}

raw_df <- read.csv(here("data/shea_et_al_FMFO/adr6921_Suppl_Excel_v2.csv")) %>%
filter(!is.na(factory_id)) %>%
  mutate(country = stri_replace_all_fixed(country, "\u00A0", " ")) 
raw_df$country <- iconv(raw_df$country, from = "", to = "UTF-8", sub = "")


tidy_df <- raw_df %>%
  distinct(factory_id, country, material_type, common_name = comm_name, sciname = sci_name) %>%
  filter(!is.na(material_type)|material_type != "") %>%
  mutate(aquaculture = ifelse(str_detect(material_type, "aquaculture"), "yes", "no"),
         wholefish = ifelse(str_detect(material_type, "whole"), "yes", "no"),
         trimmings = ifelse(str_detect(material_type, "by-products"), "yes", "no"), 
         data_source_feed = "Shea et al. 2025", 
         data_source_fao_area_country = NA, 
         feed_report_spp_name = tolower(common_name),
         trash_fish = "no",
         capture = ifelse(aquaculture == "yes", "no", "yes")) %>%
  dplyr::select(-material_type) %>%
  mutate(country = ifelse(country == "El<a0>Salvador", "El Salvador", country)) %>%
  mutate(sciname = tolower(sciname),
         common_name = tolower(common_name),
         source_country_iso3c = countrycode(sourcevar = country, origin = "country.name", destination = "iso3c")) %>% # add sardinella for GMB??
  add_row(factory_id = 114, country = "Gambia", common_name = "sardinellas nei", sciname = "sardinella", aquaculture = "no", wholefish = "yes", trimmings = "no", data_source_feed = "Shea et al. 2025", data_source_fao_area_country = NA, feed_report_spp_name = "Round sardinella", trash_fish = "No", capture = "yes", source_country_iso3c = "GMB") %>% # known from OOSC presentations
    add_row(factory_id = 115, country = "Gambia", common_name = "sardinellas nei", sciname = "sardinella", aquaculture = "no", wholefish = "yes", trimmings = "no", data_source_feed = "Shea et al. 2025", data_source_fao_area_country = NA, feed_report_spp_name = "Round sardinella", trash_fish = "No", capture = "yes", source_country_iso3c = "GMB") %>%
    add_row(factory_id = 116, country = "Gambia", common_name = "sardinellas nei", sciname = "sardinella", aquaculture = "no", wholefish = "yes", trimmings = "no", data_source_feed = "Shea et al. 2025", data_source_fao_area_country = NA, feed_report_spp_name = "Round sardinella", trash_fish = "No", capture = "yes", source_country_iso3c = "GMB") %>%
  mutate(sciname = ifelse(common_name == "araucanian herring", "strangomera bentincki", sciname)) # fix error in the dataset
  
```


Step 2: Gapfill any rows which have a common name and do not have a scientific name. For example, Argentina just says "shrimp"

Rules: 
 - If there is no scientific name but there is a common name, we will match to any common names in the ARTIS FM data, the FAO fisheries database, and the FAO Aquaculture database that have that common name string in it. For example, Chile reports "salmon" as the common name. In this case, we str_detect the artis FM database (and FAO data) for "salmon" and filter for CHL, and assume that that "salmon" row in the Shea database matches to any salmon reported in Chile in those data. Then we rejoin to the tidy shea database by the original common name ("salmon"). If the species are not reported in the ARTIS FM data then we will repeat the process, but with the FAO fisheries data (this isn't really necessary but for posterity sake we do it).
 
```{r}
missing_sciname_df <- tidy_df %>%
  filter(is.na(sciname) & !is.na(common_name)) %>%
  distinct() 

# ok lets fix the rows with sciname == NA where we can by cross referencing the common name with ARTIS data, and if none in the ARTIS data, we will grab the species from the FAO fisheries data

fao_fisheries_df <- read.csv(file.path("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/global_capture_production_1950-2020.csv")) %>%
  clean_names() %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
      dplyr::select(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name, x_2015, x_2016, x_2017, x_2018, x_2019, x_2020)

fao_aqua_df <- read.csv(file.path("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/global_aquaculture_production_1950_2020.csv")) %>%
  clean_names() %>%
  filter(x_2015 >0 |x_2016 >0 |x_2017 >0 |x_2018 >0 |x_2019 >0 |x_2020 >0) %>%
      dplyr::select(country_name, asfis_species_name, asfis_species_name_1, fao_major_fishing_area_code, fao_major_fishing_area_name, unit_name, x_2015, x_2016, x_2017, x_2018, x_2019, x_2020)

fm_artis_check <- fm_artis %>%
  group_by(source_country_iso3c, sciname, method) %>%
  summarise(product_weight_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>% 
  left_join(artis_taxa)

# Argentina 
# original common_name == "shrimp", capture production
test_arg <- fm_artis_check %>%
  filter(source_country_iso3c == "ARG", str_detect(common_name, "shrimp|Shrimp")) # ok they report none.. ? What about in fisheries data? 

fix_arg <- fao_fisheries_df %>%
  filter(country_name == "Argentina", str_detect(asfis_species_name, "shrimp|Shrimp")|str_detect(asfis_species_name_1, "shrimp")) %>%
  mutate(source_country_iso3c = "ARG", 
         common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = "shrimp") %>%
  left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country = country_name, sciname, feed_report_spp_name, common_name) %>%
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
              filter(country == "Argentina"), by = c("country", "feed_report_spp_name" = "common_name", "source_country_iso3c")) %>%
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
        mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
  dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Chile
# krill - capture
# salmon - aquaculture
fix_chl_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "CHL", str_detect(common_name, "krill|salmon")) %>%
  mutate(feed_report_spp_name = ifelse(str_detect(common_name, "krill"), "krill", "salmon"),
         country = "Chile") %>%
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_chl_capture <- fao_fisheries_df %>%
  filter(country_name == "Chile", str_detect(asfis_species_name, "krill")) %>%
  mutate(feed_report_spp_name = "krill",
         source_country_iso3c = "CHL",
         common_name = tolower(asfis_species_name)) %>%
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)


fix_chl_aquaculture <- fao_aqua_df %>%
  filter(country_name == "Chile", str_detect(asfis_species_name, "salmon|Salmon")) %>%
  mutate(feed_report_spp_name = "salmon",
         source_country_iso3c = "CHL",
         common_name = tolower(asfis_species_name)) %>%
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)

fix_chl <- rbind(fix_chl_fm, fix_chl_capture, fix_chl_aquaculture) %>%
full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Chile"), by = c("country", "feed_report_spp_name" = "common_name", "source_country_iso3c")) %>%
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
        mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Ecuador 
# tuna - capture

fix_ecu_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "ECU", str_detect(common_name, "tuna|Tuna")) %>%
  mutate(feed_report_spp_name = "tuna",
         country = "Ecuador") %>%
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_ecu_capture <- fao_fisheries_df %>%
  filter(country_name == "Ecuador", str_detect(asfis_species_name, "tuna|Tuna")) %>%
  mutate(feed_report_spp_name = "tuna",
         source_country_iso3c = "ECU",
         common_name = tolower(asfis_species_name)) %>%
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)

fix_ecu <- rbind(fix_ecu_fm, fix_ecu_capture) %>%
full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Chile"), by = c("country", "feed_report_spp_name" = "common_name", "source_country_iso3c")) %>%
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
        mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 



# India
# catfish - capture
# ribbonfish - capture
# anchovy - capture
# tuna - capture

fix_ind_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "IND") %>%
         filter(str_detect(common_name, "catfish|ribbon|anchov|tuna")) %>%
  mutate(feed_report_spp_name = case_when(str_detect(common_name, "catfish") ~ "catfish",
                                          str_detect(common_name, "tuna") ~ "tuna",
                                          str_detect(common_name, "ribbon") ~ "ribbonfishes",
                                          str_detect(common_name, "anchov") ~ "anchovy",
         TRUE ~ NA), 
         country = "India") %>%
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name) 

fix_ind_capture <- fao_fisheries_df %>%
  filter(country_name == "India", str_detect(asfis_species_name, "catfish|ribbon|anchov|tuna")) %>%
  mutate(source_country_iso3c = "IND", common_name = tolower(asfis_species_name)) %>%
mutate(feed_report_spp_name = case_when(str_detect(common_name, "catfish") ~ "catfish",
                                          str_detect(common_name, "tuna") ~ "tuna",
                                          str_detect(common_name, "ribbon") ~ "ribbonfishes",
                                          str_detect(common_name, "anchov") ~ "anchovy",
         TRUE ~ NA)) %>% 
         left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country = country_name, sciname, feed_report_spp_name, common_name) 


fix_ind <- fix_ind_fm %>%
  rbind(., fix_ind_capture) %>%
  distinct() %>%
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "India"), by = c("country", "feed_report_spp_name" = "common_name", "source_country_iso3c")) %>%
  mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
        mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::distinct(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Indonesia 
# tuna - capture
# sardine - capture

fix_idn_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "IDN") %>%
         filter(str_detect(common_name, "sardine|tuna")) %>%
  mutate(feed_report_spp_name = case_when(str_detect(common_name, "sardine") ~ "sardine",
                                          str_detect(common_name, "tuna") ~ "tuna",
         TRUE ~ NA), 
         country = "Indonesia") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)
   
  
fix_idn_capture <- fao_fisheries_df %>%
  filter(country_name == "Indonesia", str_detect(asfis_species_name, "sardine|tuna")) %>%
  mutate(source_country_iso3c = "IDN", common_name = tolower(asfis_species_name)) %>%
mutate(feed_report_spp_name = case_when(str_detect(common_name, "sardine") ~ "sardine",
                                          str_detect(common_name, "tuna") ~ "tuna",
         TRUE ~ NA)) %>% 
         left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country = country_name, sciname, feed_report_spp_name, common_name) 

  
  fix_idn <- rbind(fix_idn_fm, fix_idn_capture) %>%
   full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Indonesia"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
  distinct() %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Iran
# sardine - capture

fix_irn_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "IRN") %>%
         filter(str_detect(common_name, "sardine")) %>%
  mutate(feed_report_spp_name = "sardine", 
         country = "Iran") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)  # none

fix_irn_capture <- fao_fisheries_df %>%
  filter(country_name == "Iran (Islamic Rep. of)", str_detect(asfis_species_name, "sardine|Sardine")|str_detect(asfis_species_name_1, "sardine|Sardine")) %>%
  mutate(source_country_iso3c = "IRN", 
         common_name = tolower(asfis_species_name)) %>%
mutate(feed_report_spp_name = "sardine") %>% 
         left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country = country_name, sciname, feed_report_spp_name, common_name) %>%
  mutate(country = "Iran")


  fix_irn <- fix_irn_capture %>%
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Iran"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
  distinct() %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Ireland - all capture
# anchovy
# anglerfish 
# hake 
# crab 
# norwegian lobster 
# haddock 

irl_missing <- tidy_df %>%
  filter(country == "Ireland", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_irl_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "IRL") %>%
         filter(str_detect(common_name, str_c(c(irl_missing, "anchov", "norway lobster"), collapse = "|"))) %>%
  mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_name <- irl_missing[str_detect(cn, irl_missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1])  # or handle differently if multiple matches
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(feed_report_spp_name = ifelse(common_name == "norway lobster", "norwegian lobster", feed_report_spp_name)) %>% # need to fix the norwegian lobster name
  mutate(country = "Ireland") %>% 
  left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)


fix_irl_capture <- fao_fisheries_df %>%
  filter(country_name == "Ireland") %>%
         filter(str_detect(asfis_species_name, str_c(c(irl_missing, "anchov", "norway lobster"), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_name <- irl_missing[str_detect(cn, irl_missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1])  # or handle differently if multiple matches
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(feed_report_spp_name = ifelse(common_name == "norway lobster", "norwegian lobster", feed_report_spp_name)) %>% # need to fix the norwegian lobster name
  mutate(source_country_iso3c = "IRL") %>% 
  left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)


    fix_irl <- rbind(fix_irl_capture, fix_irl_fm) %>%
      full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Ireland"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# KOR: squid - capture
kor_missing <- tidy_df %>%
  filter(country == "South Korea", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_kor_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "KOR") %>%
         filter(str_detect(common_name, str_c(kor_missing, collapse = "|"))) %>%
  mutate(feed_report_spp_name = "squid", 
         country = "South Korea") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_kor_capture <- fao_fisheries_df %>%
  filter(country_name == "Korea, Republic of") %>%
  filter(str_detect(asfis_species_name, str_c(c(kor_missing), collapse = "|"))) %>%
    mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = "squid") %>%
  mutate(source_country_iso3c = "KOR",
         country_name = "South Korea") %>% 
  left_join(artis_taxa) %>%
  dplyr::select(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)

fix_kor <- rbind(fix_kor_fm, fix_kor_capture) %>%     
   full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "South Korea"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Malaysia - all capture
# tuna 
# mackerel 
# sardine
# anchovy

missing <- tidy_df %>%
  filter(country == "Malaysia", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_mys_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "MYS") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
    mutate(feed_report_spp_name = ifelse(common_name == "stolephorus anchovies nei", "anchovy", feed_report_spp_name)) %>% # need to fix anchovy name
  mutate(country = "Malaysia") %>% 
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)


fix_mys_capture <- fao_fisheries_df %>%
  filter(country_name == "Malaysia") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1])  # or handle differently if multiple matches
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "MYS") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  
  
  fix_mys <- rbind(fix_mys_fm, fix_mys_capture) %>%
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Malaysia"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 
  

# New Zealand 
# tuna - capture

missing <- tidy_df %>%
  filter(country == "New Zealand", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_nzl_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "NZL") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "New Zealand") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)


fix_nzl_capture <- fao_fisheries_df %>%
  filter(country_name == "New Zealand") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1])  # or handle differently if multiple matches
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "NZL") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  
  
fix_nzl <- rbind(fix_nzl_fm, fix_nzl_capture) %>%
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "New Zealand"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Norway 
# krill - "antarctic krill" = "euphausia superba" - capture

missing <- tidy_df %>%
  filter(country == "Norway", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_nor_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "NOR") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Norway") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name) 


fix_nor_capture <- fao_fisheries_df %>%
  filter(country_name == "Norway") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "NOR") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  


  fix_nor <- rbind(fix_nor_fm, fix_nor_capture) %>% 
      full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Norway"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Oman
# tuna - capture
missing <- tidy_df %>%
  filter(country == "Oman", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_omn_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "OMN") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Oman") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)


fix_omn_capture <- fao_fisheries_df %>%
  filter(country_name == "Oman") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "OMN") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

    fix_omn <- rbind(fix_omn_fm, fix_omn_capture) %>% 
      full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Oman"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Papua New Guinea 
# tuna - capture

missing <- tidy_df %>%
  filter(country == "Papua New Guinea", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_png_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "PNG") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Papua New Guinea") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)



fix_png_capture <- fao_fisheries_df %>%
  filter(country_name == "Papua New Guinea") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "PNG") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

    
fix_png <- rbind(fix_png_capture, fix_png_fm) %>% 
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Papua New Guinea"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Poland
# tuna 
missing <- tidy_df %>%
  filter(country == "Poland", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_pol_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "POL") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Poland") %>% 
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)



fix_pol_capture <- fao_fisheries_df %>%
  filter(country_name == "Poland") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "POL") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name) 

fix_pol <- rbind(fix_pol_fm, fix_pol_capture) %>%  
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Poland"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 



# Seychelles
# tuna - capture
missing <- tidy_df %>%
  filter(country == "Seychelles", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_syc_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "SYC") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Seychelles") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_syc_capture <- fao_fisheries_df %>%
  filter(country_name == "Seychelles") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "SYC") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

    fix_syc <- rbind(fix_syc_fm, fix_syc_capture) %>% 
      full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Seychelles"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Spain - all capture
# tuna 
# shrimp
# salmon 
# anchovy 
# sardine

missing <- tidy_df %>%
  filter(country == "Spain", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_esp_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "ESP") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(feed_report_spp_name = ifelse(str_detect(common_name, "anchov"), "anchovy", feed_report_spp_name)) %>%
  mutate(country = "Spain") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_esp_capture <- fao_fisheries_df %>%
  filter(country_name == "Spain") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "ESP") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  


fix_esp <- rbind(fix_esp_fm, fix_esp_capture) %>%    
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Spain"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Taiwan - all capture
# salmon; no salmon reported for taiwan catch
# cod; none reported in catch 
# tuna 
# shark
# sardine; none reported

missing <- tidy_df %>%
  filter(country == "Taiwan", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_twn_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "TWN") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Taiwan") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name) 


fix_twn_capture <- fao_fisheries_df %>%
  filter(country_name == "Taiwan") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "TWN") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

fix_twn <- rbind(fix_twn_fm, fix_twn_capture) %>%
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Taiwan"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Thailand
# tuna - capture
missing <- tidy_df %>%
  filter(country == "Thailand", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_tha_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "THA") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Thailand") %>% 
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_tha_capture <- fao_fisheries_df %>%
  filter(country_name == "Thailand") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "THA") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

fix_tha <- rbind(fix_tha_fm, fix_tha_capture) %>%
    full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Thailand"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 

# Turkey - capture
# tuna 
# sardine
missing <- tidy_df %>%
  filter(country == "Turkey", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_tur_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "TUR") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Turkey") %>% 
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_tur_capture <- fao_fisheries_df %>%
  filter(country_name == "Turkey") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "TUR") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

fix_tur <- rbind(fix_tur_fm, fix_tur_capture) %>%    
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Turkey"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# United Kingdom
# tuna - capture
missing <- tidy_df %>%
  filter(country == "United Kingdom", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_gbr_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "GBR") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "United Kingdom") %>% 
  dplyr::select(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_gbr_capture <- fao_fisheries_df %>%
  filter(country_name == "United Kingdom") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "GBR") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

fix_gbr <- rbind(fix_gbr_fm, fix_gbr_capture) %>%    
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "United Kingdom"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# United States of America - capture
# salmon 
# halibut

missing <- tidy_df %>%
  filter(country == "United States of America", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

fix_usa_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "USA") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "United States of America") %>% 
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)
    

fix_usa_capture <- fao_fisheries_df %>%
  filter(country_name == "United States of America") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "USA") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

fix_usa <- rbind(fix_usa_fm, fix_usa_capture) %>%
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "United States of America"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


# Costa Rica 
# shrimp 
# fish
# ok for Costa Rica we'll do something a little bit different, since they just list "fish". We'll apply the method normally for shrimp. But for fish, if we look directly on that producers website, they do list specific species: https://pmtcr.com/english/fish.htm 

# Mahi-mahi
# Blue marlin
# Striped marlin
# Grouper
# Sailfish
# Snapper
# Swordfish
# Blacktip shark
# Thresher shark
# Tuna

missing <- tidy_df %>%
  filter(country == "Costa Rica", 
         is.na(sciname) & !is.na(common_name)) %>%
  pull(common_name) %>%
  unique()

missing <- c("shrimp")

fix_cri_shrimp_1 <- fm_artis_check %>%
  filter(source_country_iso3c == "CRI") %>%
         filter(str_detect(common_name, str_c(missing, collapse = "|"))) %>%
 mutate(feed_report_spp_name = map_chr(tolower(common_name), function(cn) {
    match_found <- missing[str_detect(cn, fixed(missing))]
    
    if (length(match_found) == 1) {
      return(match_found)
    } else if (length(match_found) > 1) {
      return(match_found[1])  # If multiple matches, keep the first
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(country = "Costa Rica") %>% 
  dplyr::distinct(source_country_iso3c, country, sciname, common_name, feed_report_spp_name)

fix_cri_shrimp_2 <- fao_fisheries_df %>%
  filter(country_name == "Costa Rica") %>%
         filter(str_detect(asfis_species_name, str_c(c(missing), collapse = "|"))) %>%
  mutate(common_name = tolower(asfis_species_name)) %>%
  mutate(feed_report_spp_name = map_chr(tolower(asfis_species_name), function(cn) {
    match_name <- missing[str_detect(cn, missing)]
    if (length(match_name) == 1) {
      return(match_name)
    } else if (length(match_name) > 1) {
      return(match_name[1]) 
    } else {
      return(NA_character_)
    }
  })) %>%
  mutate(source_country_iso3c = "CRI") %>% 
  left_join(artis_taxa) %>%
  dplyr::distinct(source_country_iso3c, country = country_name, sciname, common_name, feed_report_spp_name)  

fix_cri_1 <- rbind(fix_cri_shrimp_1, fix_cri_shrimp_2) %>%    
  full_join(tidy_df %>%
              dplyr::select(-feed_report_spp_name) %>%
                filter(country == "Costa Rica"), by = c("country", "source_country_iso3c", "feed_report_spp_name" = "common_name")) %>% 
    mutate(common_name = ifelse(is.na(common_name), feed_report_spp_name, common_name)) %>%
      mutate(sciname = ifelse(is.na(sciname.x) & !is.na(sciname.y), sciname.y, sciname.x)) %>%
  dplyr::select(-sciname.y, -sciname.x) %>%
    dplyr::select(factory_id, source_country_iso3c, country, common_name, feed_report_spp_name, aquaculture, wholefish, trimmings, data_source_feed, data_source_fao_area_country, trash_fish, capture, sciname) 


cri_fm <- fm_artis_check %>%
  filter(source_country_iso3c == "CRI", phylum == "chordata")

# Mahi-mahi, Blue marlin, Striped marlin, Grouper, Sailfish, Snapper, Swordfish, Blacktip shark, Thresher shark, Tuna

costa_rica_rows <- tibble::tibble(
  country = rep("Costa Rica", 14),
  common_name = c(
    "common dolphinfish", "striped marlin", "Groupers, seabasses nei",
    "marlins,sailfishes,etc. nei", "indo-pacific sailfish", "snappers, jobfishes nei", "spotted rose snapper", "swordfish",
    "blacktip shark", "thresher", "bigeye tuna", "skipjack tuna", "tuna-like fishes nei", "yellowfin tuna"
  ),
  sciname = c(
    "coryphaena hippurus", "kajikia audax", "serranidae",
    "istiophoridae", "istiophorus platypterus", "lutjanidae", "lutjanus guttatus", "xiphias gladius",
    "carcharhinus limbatus", "alopias vulpinus", "thunnus obesus", "katsuwonus pelamis", "perciformes", "thunnus albacares"
  )
) %>%
  mutate(aquaculture = "no",
         wholefish = "no",
         trimmings = "yes", 
         data_source_feed = "Shea et al. 2025",
         data_source_fao_area_country = NA,
         feed_report_spp_name = "fish",
         trash_fish = "no",
         capture = "yes", source_country_iso3c = "CRI") %>%
  mutate(factory_id = 80)

fix_cri  <- rbind(fix_cri_1, costa_rica_rows)


fix_sciname_df <- rbind(fix_arg, fix_chl, fix_cri, fix_ecu, fix_esp, fix_gbr, fix_idn, fix_ind, fix_irl, fix_irn, fix_kor, fix_mys, fix_omn, fix_png, fix_pol, fix_syc, fix_tha, fix_tur, fix_twn, fix_usa, fix_nor, fix_nzl)


fixed_iso <- unique(fix_sciname_df$source_country_iso3c)

tidy_df_fix <- tidy_df %>% 
  filter(!(source_country_iso3c %in% fixed_iso)) %>%
  rbind(., fix_sciname_df) # want to retain repeats here because this will affect the trim_prop estimates


rm(list = c("fix_arg", "fix_chl", "fix_cri", "fix_ecu", "fix_esp",
            "fix_gbr", "fix_idn", "fix_ind", "fix_irl", "fix_irn",
            "fix_kor", "fix_mys", "fix_omn", "fix_png", "fix_pol",
            "fix_syc", "fix_tha", "fix_tur", "fix_twn", "fix_usa", "fix_nor", "fix_nzl", "fix_cri_1"))

rm(list = c("fix_arg_fm", "fix_chl_fm", "fix_cri_fm", "fix_ecu_fm", "fix_esp_fm",
            "fix_gbr_fm", "fix_idn_fm", "fix_ind_fm", "fix_irl_fm", "fix_irn_fm",
            "fix_kor_fm", "fix_mys_fm", "fix_omn_fm", "fix_png_fm", "fix_pol_fm",
            "fix_syc_fm", "fix_tha_fm", "fix_tur_fm", "fix_twn_fm", "fix_usa_fm", 
            "fix_nor_fm", "fix_nzl_fm", "fix_cri_shrimp_1"))

rm(list = c("fix_arg_capture", "fix_chl_capture", "fix_cri_capture", "fix_ecu_capture", "fix_esp_capture",
            "fix_gbr_capture", "fix_idn_capture", "fix_ind_capture", "fix_irl_capture", "fix_irn_capture",
            "fix_kor_capture", "fix_mys_capture", "fix_omn_capture", "fix_png_capture", "fix_pol_capture",
            "fix_syc_capture", "fix_tha_capture", "fix_tur_capture", "fix_twn_capture", "fix_usa_capture", 
            "fix_nor_capture", "fix_nzl_capture", "fix_cri_shrimp_2", "fix_chl_aquaculture"))


```

 Step 3: 

 - If the Shea data only has a genus listed (e.g., "sardinella spp."), we will match to ANY species within that genus and country in the ARTIS database. For example, Ecuador reports "larimus spp.", in this case, we will filter the ARTIS database for any "larimus" genus and assume this row in the Shea database is true for all larimus species. If we don't have a genus reported, but instead have a family, then match to the family, and then if not genus or family, match to the order. 
 
 
```{r}
one_word_spp <- tidy_df %>%
  filter(!grepl("\\s", sciname), 
         !is.na(sciname)) %>%
  pull(sciname) %>%
  unique() # Filters for rows where the column does NOT contain any whitespace## filter for any rows which have "spp."

genus_df <- tidy_df %>%
  filter(str_detect(sciname, "spp.")|sciname %in% one_word_spp) %>%
  mutate(sciname = str_trim(str_replace_all(sciname, "spp.", ""))) %>%
  distinct(sciname, common_name) %>%
  left_join(artis_taxa, by = "sciname") %>%
  mutate(genus = ifelse(sciname == "larimus", "larimus", genus)) %>%
  mutate(genus = ifelse(sciname == "opisthonema", "opisthonema", genus)) %>%
  mutate(genus = ifelse(sciname == "amblygaster", "amblygaster", genus)) %>%
  mutate(genus = ifelse(sciname == "oligoplites", "oligoplites", genus)) %>%
  mutate(genus = ifelse(sciname == "urophycis", "urophycis", genus))


# match by genus, then if missing genus by family, if missing genus and family, by order 
rows_to_match <- tidy_df %>%
    filter(str_detect(sciname, "spp.")|sciname %in% one_word_spp) %>%
  mutate(sciname = str_trim(str_replace_all(sciname, "spp.", ""))) %>%
  left_join(genus_df, by = c("sciname", "common_name" = "common_name.x")) %>%
  mutate(row_id = row_number())

# Function for matching one Shea row
match_row <- function(row) {
  # test_row <- rows_to_match %>% slice(1)
  # row = test_row
  
  country <- row$source_country_iso3c
  genus_i <- row$genus
  family_i <- row$family
  order_i <- row$order
  spp_name <- row$sciname
  country_name <- row$country  # Assuming you have this column

  # Filter ARTIS to relevant country
  artis_subset <- fm_artis_check %>%
    filter(source_country_iso3c == country)

  # Try genus match first
  match <- artis_subset %>%
    filter(genus == genus_i)

  match_level <- "genus"

  # If no genus match, try family
  if (nrow(match) == 0 && !is.na(family)) {
    match <- artis_subset %>% filter(family == family_i)
    match_level <- "family"
  }

  # If no family match, try order
  if (nrow(match) == 0 && !is.na(order)) {
    match <- artis_subset %>% filter(order == order_i)
    match_level <- "order"
  }

  # If still no match, return NULL
  if (nrow(match) == 0) return(NULL)
  
  join_var <- match_level

  # Add Shea row info to matched rows
  match %>%
    mutate(country = country_name,
           # feed_report_spp_name = spp_name,
           match_level = match_level) %>%
    left_join(row, 
           by = c("country", 
                   "source_country_iso3c", 
                   setNames("sciname", match_level))) %>%
      rename(common_name = common_name.x) %>%
    select(colnames(tidy_df_fix)) %>%
    distinct()
}

# Apply to all Shea rows
matched_all <- rows_to_match %>%
  split(.$row_id) %>%
  map_dfr(~ match_row(.x)) %>%
  dplyr::select(colnames(tidy_df_fix))

fix_can_tuna <- matched_all %>%
  filter(source_country_iso3c == "CAN", 
         is.na(factory_id)) %>%
  mutate(trimmings = "yes",
         wholefish = "no",
         capture = "yes",
         trash_fish = "no",
         aquaculture = "no",
         data_source_feed = "Shea et al. 2025", 
         factory_id = 24,
         feed_report_spp_name = "auxis") %>%
  dplyr::select(colnames(matched_all))

matched_all_fix <- matched_all %>%
  filter(!is.na(aquaculture)) %>%
  rbind(., fix_can_tuna)
  
  ## ok cool, this worked. There are some where there just isn't a match. E.g. Canada and opisthonema (thread herring)).

```

 
Step 4: rbind all together and save 

```{r}
filter_out <- tidy_df %>%
    filter(str_detect(sciname, "spp.")|sciname %in% one_word_spp) 

tidy_df_fix_2 <- tidy_df_fix %>% 
  anti_join(., filter_out) %>%
  rbind(matched_all_fix)

if(artis_version == "new"){
  write.csv(tidy_df_fix_2, here("data/shea_et_al_FMFO/fmfo_tidy_v1.1.csv"), row.names = FALSE)
  
}else{

write.csv(tidy_df_fix_2, here("data/shea_et_al_FMFO/fmfo_tidy_v0.1.csv"), row.names = FALSE)
}

```

 
 Step 6: Calculate trimmings proportions based on the proportion of each species row that reports whole fish vs trimmings. 

```{r}
# Script to calculate the proportion of a species derived from trimmings
# for each unique combination of country and species

# Read the CSV file
if(artis_version == "new"){

data <- read_csv(here("data/shea_et_al_FMFO/fmfo_tidy_v0.1.csv"))
}else{
  data <- read_csv(here("data/shea_et_al_FMFO/fmfo_tidy_v1.1.csv"))

}

# Calculate trim_prop for each country-species combination
result <- data %>%
  # Group by country and scientific name
  group_by(country, sciname, aquaculture) %>%
  # Calculate the proportion of rows where trimmings = "yes"
  summarize(
    trim_prop = mean(trimmings == "yes", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ungroup() %>%
    # filter(!is.na(sciname)) %>% 
  # left_join(artis_taxa) %>%
  # mutate(trimmings = ifelse(trim_prop > 0, "yes", "no"),
  #        wholefish = ifelse(trim_prop < 1, "yes", "no"))
  # Join back to the original data
  right_join(data, by = c("country", "sciname", "aquaculture")) %>%
  filter(!is.na(sciname))

# test <-  data  %>%
# # Group by country and scientific name
#   group_by(country, sciname, aquaculture) %>%
#   # Calculate the proportion of rows where trimmings = "yes"
#   summarize(
#     trim_prop = mean(trimmings == "yes", na.rm = TRUE),
#     .groups = "drop"
#   ) %>%
#   ungroup() %>%
#   filter(!is.na(sciname))
# 
# test2 <- result %>%
#   group_by(country, sciname, aquaculture) %>%
#   summarise(trim_prop = mean(trim_prop, na.rm = TRUE))
# ok cool, they're the same. We'll save it like this for now then. 

# Write the filtered result to a new CSV file
if(artis_version == "new"){
write.csv(result, here("int/material_origins_shea_2025_v1.1.csv"), row.names = FALSE)
}else{
write.csv(result, here("int/material_origins_shea_2025_v0.1.csv"), row.names = FALSE)

}

test <- read.csv(here("int/material_origins_shea_2025.csv"))

```



