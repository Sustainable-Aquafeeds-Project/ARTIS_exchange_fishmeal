---
title: "Manuscript figures"
output: html_document
date: "2024-11-25"
editor_options: 
  chunk_output_type: console
---

## Summary

Here we created figures that are used in the main manuscript. 

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(janitor)
library(countrycode)
library(qs)
library(scales)
library(viridis)
library(dplyr)
library(exploreARTIS)
library(patchwork)
library(ggsankey)
library(stringr)

source(here("R/directories.R"))

artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) %>% ## read in attribute table with common names
  mutate(phylum = case_when(
    common_name %in% c("mackerels, tunas, and bonitos", "salmons and trouts", "herrings", "cartilaginous fishes nei", "flounders", "african lungfishes", "toothfish", "carps, minnows, loaches, etc", "blue whitings") ~ "chordata",
    TRUE ~ phylum
  )) # fix phylum mistakes
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

fm_data <-   qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_gf_final.qs")) %>%
  left_join(artis_taxa)


fm_data_adjusted <-   qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_adjusted_final.qs")) %>%
  left_join(artis_taxa)

```

Figure 1: 
Trends from 1996-2020 split by phylum

```{r}
fm_data_top_spp <- qs::qread( here("outputs/top_species_fm_1996_2020.qs"))

fm_data_top_spp %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum()/fm_data %>% filter(year == 2020) %>% pull(product_weight_t) %>% sum() # 0.8264647; we retain ~83% of fishmeal reported in ARTIS by only keeping top 20 species.

# Calculate proportion of total fishmeal represented by top species
# Note: fm_data reference removed as it's not defined in this script
# Retains ~81% of fishmeal reported in ARTIS by only keeping top 20 species

all_spp_time <- fm_data_top_spp %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "All species")

finfish_time <- fm_data_top_spp %>%
  filter(phylum == "chordata") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Finfish") 

crust_time <- fm_data_top_spp %>%
  filter(phylum == "arthropoda") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Crustaceans") 

mollusc_time <- fm_data_top_spp %>%
  filter(phylum == "mollusca") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t) %>%
  mutate(data_type = "Cephalopoda")  %>%
  filter(product_t != 0)

overtime_all <- rbind(all_spp_time, finfish_time, crust_time, mollusc_time) %>%
  mutate(perc = scales::percent(round(prop, 2), accuracy = 1))

# Create label data for start and end points with automatic positioning
label_data <- overtime_all %>%
  filter(year %in% c(1996, 2020)) %>%
  group_by(data_type, fishmeal_type) %>%
  arrange(year) %>%
  mutate(
    label_x = case_when(
      # Special positioning for Cephalopoda panel
      data_type == "Cephalopoda" & year == 1996 ~ year - 0,  # Move closer to plot
      data_type == "Cephalopoda" & year == 2020 ~ year + 0,  # Move closer to plot
      # Standard positioning for other panels - moved both years closer to plot
      year == 1996 ~ year - 0.1,  # Moved from -0.8 to -0.5 (closer to plot)
      year == 2020 ~ year + 0.1   # Moved from +0.8 to +0.5 (closer to plot)
    ),
    hjust_val = case_when(
      # Adjust horizontal justification for Cephalopoda
      data_type == "Cephalopoda" & year == 1996 ~ 0.8,  # Slightly left-justified
      data_type == "Cephalopoda" & year == 2020 ~ 0.2,  # Slightly right-justified
      # Standard justification for other panels
      year == 1996 ~ 1,
      year == 2020 ~ 0
    ),
    vjust_val = case_when(
      # Adjust vertical positioning to avoid overlaps
      data_type == "Crustaceans" & fishmeal_type == "wholefish" ~ 0.5,
      data_type == "Cephalopoda" & year == 2020 ~ -0.3,
      data_type == "Cephalopoda" & year == 1996 ~ -0.5,
      fishmeal_type == "wholefish" ~ 0.2,
      TRUE ~ 0
    )
  ) %>%
  ungroup()

# artis_palette(length(unique(overtime_all$fishmeal_type)))

# Create the plot with increased text sizes
figure_1 <- ggplot(overtime_all, aes(x = year, y = product_t, color = fishmeal_type)) +
  geom_line(linewidth = 1.2) +  # Increased line width
  theme_bw(base_size = 14) +  # Increased base font size
  facet_wrap(~data_type, scales = "free_x") + 
  labs(x = "Year", y = "Fishmeal product (million tonnes)", color = "Fishmeal type") + 
  scale_color_manual(values = c("trimmings" = "#741A32", "wholefish" = "#114F59"), 
                     labels = c("Trimmings-derived", "Whole fish-derived")) + 
  scale_x_continuous(limits = c(1993.5, 2022.5), breaks = c(1996, 2002, 2008, 2014, 2020), 
                     labels = c(1996, 2002, 2008, 2014, 2020)) +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 12),  # Increased legend text size
    legend.title = element_text(size = 13), # Increased legend title size
    axis.text = element_text(size = 11),    # Increased axis text size
    axis.title = element_text(size = 13),   # Increased axis title size
    strip.text = element_text(size = 12),   # Increased facet label size
    panel.spacing = unit(1, "lines")        # Increased spacing between panels
  ) +
  scale_y_continuous(labels = function(x) x/1e6,
                     name = "Fishmeal product (million tonnes)") + 
  geom_text(data = label_data,
            aes(x = label_x, y = product_t, label = perc, 
                hjust = hjust_val, vjust = vjust_val),
            show.legend = FALSE, 
            size = 4.5,  # Increased text size from 3 to 4.5
            fontface = "bold")  # Made text bold for better visibility

# Display the plot
# print(figure_1)

# Save with updated path and optimized dimensions for better text visibility
ggsave(here("outputs/figs/MS/Figure_1_time.png"), 
       plot = figure_1,
       width = 200, height = 180,  # Slightly increased width for better spacing
       units = "mm", bg = "white", dpi = 300)
```


## Figure 2. Production and trade flows

```{r}
top_species_by_country_2019 <- qs::qread(here("outputs/top_species_fm_2015_2019.qs"))

test <- top_species_by_country_2019 %>%
  filter(class == "cephalopoda",
         product_weight_t > 0) 

  sum(top_species_by_country_2019$product_weight_t) # 5071250; ok cool. Seems reasonable. FAO reports ~5.1 million tonnes for 2019 (figure 68 in FAO SOFIA, hard to tell the exact number)

   # Create a simplified trade flow visualization
  trade_flows <- top_species_by_country_2019 %>% 
        group_by(source_country_iso3c, exporter_iso3c, importer_iso3c, fishmeal_type, phylum) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
    ungroup() %>%
    mutate(prop = product_weight_t/sum(product_weight_t))
  
  sum(trade_flows$product_weight_t) # 5071250
  
    
## Ok let's try to make the sankey a bit prettier
    
# Setting up parameters based on user input-----------------------------------
  
  # Assign weight column to quantity
  quantity <- "product_weight_t"
    
    cols <- c("source_country_iso3c", "fishmeal_type", "importer_iso3c")

  # Summarizing data based on quantity variable selected
  links <- trade_flows %>%
    group_by(source_country_iso3c, fishmeal_type, importer_iso3c) %>% 
    summarize(total_q = sum(.data[[quantity]], na.rm = TRUE))

  
  # Rename specified columns to generic names for processing
  colnames(links) <- c(paste("col_", 1:length(cols), sep = ""), "total_q")
  cols <- colnames(links)[1:length(cols)]
  
  # Identify list of nodes by column by proportional flow cutoff
  node_names <- c()
  
  for(i in 1:length(cols)){
    # Identify nodes in the column falling below the threshold
    # i = 1
    node_i <- links %>%
      rename(col_i = paste("col_", i, sep = "")) %>%
      group_by(col_i) %>%
      summarize(total_q = sum(total_q, na.rm=TRUE)) %>%
      ungroup() %>%
      mutate(total = sum(total_q, na.rm=TRUE)) %>%
      mutate(prop = total_q / total) %>%
      # label those below threshold as "Other" - otherwise keep name
      mutate(name_new = case_when(
        prop < 0.03368936501508 ~ "Other", # this is the cutoff for including Chile on the left hand side
        TRUE ~ col_i
      ))
    
    # Create vector of nodes
    node_names_i <- node_i$name_new
    
    # Replace node names with "Other" when it falls below the threshold 
    # in links dataframe
    links <- links %>%
      rename(col_i = paste("col_", i, sep = "")) %>%
      mutate(col_i = case_when(
        col_i %in% node_names_i ~ col_i,
        TRUE ~ "Other"
      ))
    # rename working column with generic name perscribed above 
    colnames(links)[colnames(links) == "col_i"] <- paste("col_", i, sep = "")
    
    # vector of all node names
    node_names <- unique(c(node_names, node_names_i))
  }
  # vector of all node names across all columns of interest 
  node_names <- unique(node_names)
  
  # Creating dataframe from sankey----------------------------------------------
  # keep "Other" observation values if specified, remove if flase
  show.other = FALSE
  
  if(show.other == FALSE){
    node_names <- node_names[node_names != "Other"]
  }else{
    node_names <- node_names
  }
  
  sankey_df <- links %>%
    # Filtering data based on prop flow cutoff - use show.other value 
    filter_at(vars(cols), all_vars(. %in% node_names)) %>%
    ungroup() %>% 
    rename("Producing countries" = "col_1",
           "Fishmeal type" = "col_2",
           "Consuming countries" = "col_3") %>%
    mutate(`Fishmeal type` = str_to_sentence(`Fishmeal type`),
           `Producing countries` = countrycode(sourcevar = `Producing countries`, origin = "iso3c", destination = "country.name"),
           `Consuming countries` = countrycode(sourcevar = `Consuming countries`, origin = "iso3c", destination = "country.name")) %>%
    filter(!is.na(`Producing countries`))

  
    # col_1 = "phylum"
  # col_2 = "fishmeal_type"
  # col_3 = "importer_iso3c"
  
  sankey_df <- sankey_df %>%
    # Transforming into ggsankey format (x, node, next_x, next_node)
            ggsankey::make_long(c("Producing countries", "Fishmeal type", "Consuming countries"), value = total_q) 

  
  num_nodes <- length(unique(c(sankey_df$node,sankey_df$next_node)))
  
  # Visualizing sankey diagram--------------------------------------------------

# Save the Sankey plot as object A
plot_a <- sankey_df %>%
    ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node
               )) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_label(size = 5, color = "black", fill = "gray") +
    theme_sankey(base_size = 10) +
    scale_fill_manual(values = artis_palette(num_nodes)) + 
    labs(x = NULL, title = "", 
         subtitle = "A") +
    theme(
      legend.position = "none",
      axis.text.x = element_text(color = "black", size = 14),
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
    )  + 
    scale_x_discrete(position = "bottom") 

ggsave(plot = plot_a, filename = here("outputs/figs/MS/figure_2a.png"), 
       width = 180, 
       height = 100,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the fishmeal production map as plot D
plot_d1 <- plot_map(top_species_by_country_2019 %>% filter(fishmeal_type == "wholefish"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t"
                  )  

trade_flows_2 <- filter(top_species_by_country_2019, exporter_iso3c != importer_iso3c)

plot_d2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "wholefish"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_d2$layer[[2]]

arrow_scale <- plot_d2$scales$scales[[
  which(sapply(plot_d2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_d <- plot_d1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "B",
       color = "Exports (million t)",
       fill = "Production (million t)") +
  theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
    plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
     # plot.caption=element_text(size=12, color="black"),   # Remove any rectangular elements
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.direction = "horizontal",
    legend.justification = "center",
    legend.spacing.x = unit(1, "cm"),
        legend.text = element_text(size = 10),   #  legend labels
    legend.title = element_text(size = 14)   # legend titles
    ) +
  guides(
    colour = guide_colorbar(
      order = 1,
      barwidth = 8,
      barheight = 0.3,
      title.position = "top",
      title.hjust = 0,
      label.position = "bottom",
      ticks.linewidth = 0.5,
      frame.linewidth = 0.5,
      direction = "horizontal"
    ),
    fill = guide_colorbar(
      order = 2,
      barwidth = 8,
      barheight = 0.3,
      title.position = "top",
      title.hjust = 0,
      label.position = "bottom",
      ticks.linewidth = 0.5,
      frame.linewidth = 0.5,
      direction = "horizontal"
    )
  ) +
    annotate(
    "text", 
    x = Inf, y = Inf,                # top-right corner of map
    label = "Whole fish fishmeal",
    hjust = 1.2 , vjust = 1,        # tweak offsets so it doesn't clip
    size = 5, color = "black"
  )

ggsave(plot = plot_d, filename = here("outputs/figs/MS/figure_2b_new.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Save the fishmeal production map as plot E
plot_e1 <- plot_map(top_species_by_country_2019 %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t" 
                  ) 

plot_e2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_e2$layer[[2]]

arrow_scale <- plot_e2$scales$scales[[
  which(sapply(plot_e2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_e <- plot_e1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "C",
       color = "Exports (million t)", 
       fill = "Production (million t)") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
      plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      # plot.caption=element_text(size=12, color="black"),   # Remove any rectangular elements
      legend.position = "bottom",
    legend.box = "horizontal",
    legend.direction = "horizontal",
        legend.justification = "center",
    legend.spacing.x = unit(1, "cm"),
            legend.text = element_text(size = 10),   #  legend labels
    legend.title = element_text(size = 14)   # legend titles
    ) +
  guides(
    colour = guide_colorbar(
      order = 1,
      barwidth = 8,
      barheight = 0.3,
      title.position = "top",
      title.hjust = 0,
      label.position = "bottom",
      ticks.linewidth = 0.5,
      frame.linewidth = 0.5,
      direction = "horizontal"
    ),
    fill = guide_colorbar(
      order = 2,
      barwidth = 8,
      barheight = 0.3,
      title.position = "top",
      title.hjust = 0,
      label.position = "bottom",
      ticks.linewidth = 0.5,
      frame.linewidth = 0.5,
      direction = "horizontal"
    )
  ) +
    annotate(
    "text", 
    x = Inf, y = Inf,                # top-right corner of map
    label = "Trimmings fishmeal",
    hjust = 1.2 , vjust = 1,        # tweak offsets so it doesn't clip
    size = 5, color = "black"
  )

   ggsave(plot = plot_e, filename = here("outputs/figs/MS/figure_2c_new.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

tight <- theme(
  plot.margin       = margin(0, 0, 0, 0),
  panel.spacing     = unit(0, "pt"),
  legend.box.margin = margin(0, 0, 0, 0)
)

plot_a_t  <- plot_a + tight + theme(plot.margin = margin(0, 5, -8, 5))  # pull DOWN
plot_d_t  <- plot_d + tight + theme(plot.margin = margin(-8, 5,  0, 5)) # pull UP
plot_e_t  <- plot_e + tight + theme(plot.margin = margin(-8, 5,  0, 5)) # pull UP

combined_plot <-
  (plot_a_t) /
  (plot_d_t | plot_e_t) +
  plot_layout(heights = c(0.35, 0.65), guides = "keep") +
  plot_annotation(theme = theme(plot.margin = margin(0, 0, 0, 0)))

ggsave(
  here("outputs/figs/MS/figure_2_combined_NEW.png"),
  combined_plot,
  width = 320, height = 300, units = "mm", bg = "white", dpi = 300
)

```

There is a weird white space between the sankey and maps, so we will use python to remove those: 

```{r}
library(reticulate)
# Add needed packages to the ephemeral env *before* Python initializes
py_require("pillow", action = "add")
py_require("numpy",  action = "add")
py_config()  # just to confirm it works

# Inputs (edit these)
img_path <- "outputs/figs/MS/figure_2_combined_NEW.png"
gap_px   <- 100L   # <-- change this to taste (e.g., 25, 40, 60)

# Expose to the python chunk
py$img_path <- img_path
py$gap_px   <- gap_px
```


```{python}
# Collapse the big white band between panels, preserving a fixed gap
from PIL import Image
import numpy as np
import os

img_path = r.img_path
gap      = int(r.gap_px)

im = Image.open(img_path).convert("RGB")
arr = np.array(im)
h, w, _ = arr.shape

# rows that are nearly white across the row
white_mask = (arr > 250).all(axis=2)
row_white_frac = white_mask.mean(axis=1)
near_blank = row_white_frac > 0.995

# find contiguous near-blank segments
segments = []
in_seg = False
start = 0
for i, v in enumerate(near_blank):
    if v and not in_seg:
        in_seg = True; start = i
    elif not v and in_seg:
        in_seg = False; segments.append((start, i-1))
if in_seg:
    segments.append((start, len(near_blank)-1))

# pick the *internal* largest band (i.e., between panels)
internal = [(s,e) for (s,e) in segments if s > 50 and e < h-50]
target = max(internal or segments, key=lambda t: t[1]-t[0])
s, e = target

# keep a small uniform gap
keep_top    = gap // 2
keep_bottom = gap - keep_top

top_part    = arr[:s+keep_top, :, :]
bottom_part = arr[e+1-keep_bottom:, :, :]
new_arr     = np.vstack([top_part, bottom_part])

out_dir  = os.path.dirname(img_path)
base    = os.path.splitext(os.path.basename(img_path))[0]
out_path = os.path.join(out_dir, f"{base}_gap{gap}.png")

Image.fromarray(new_arr).save(out_path)

# hand the output path back to R
r.out_path = out_path
```

```{r}
cat("Saved:", out_path, "\n")
knitr::include_graphics(out_path)
```


Figure 3. Species level bar chart 

```{r}
trade_flows_barchart <- top_species_by_country_2019 %>%
    group_by(common_name, fishmeal_type) %>%
    summarise(
      product_weight_t = sum(product_weight_t, na.rm = TRUE),
            live_weight_t = sum(live_weight_t, na.rm = TRUE)

    ) %>%
    arrange(desc(product_weight_t)) %>%
    filter(product_weight_t > 0) %>%
  mutate(common_name = 
           case_when( 
             common_name == "anchoveta(=peruvian anchovy)" ~ "peruvian anchoveta",
             common_name == "european pilchard(=sardine)" ~ "european pilchard",
             common_name == "blue whiting(=poutassou)" ~ "blue whiting",
             TRUE ~ common_name
           )) %>%
  mutate(common_name = str_to_sentence(common_name)) %>%
  mutate(fill_name = ifelse(fishmeal_type == "wholefish", "Whole fish-derived", "Trimmings-derived"))
    

plot_data <- trade_flows_barchart %>%
  group_by(common_name, fill_name) %>%
  summarise(total_product = sum(product_weight_t, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  group_by(common_name) %>%
  mutate(species_total = sum(total_product)) %>%  # total across fishmeal types
  ungroup() %>%
  arrange(desc(species_total)) %>%
  slice_head(n = 30) %>% # keep rows for top 20 species
  mutate(common_name = reorder(common_name, species_total))

# Plot
ggplot(plot_data, aes(x = total_product, y = common_name, fill = fill_name)) +
  geom_col() +
  labs(
    x = "Fishmeal production (t, product weight)",
    y = "",
    fill = ""
  ) +
  theme_minimal() +
    scale_fill_manual(
    values = c(
      "Whole fish-derived"   = "#254E58",
      "Trimmings-derived"    = "#6A2233"
    )
  ) +
    scale_x_continuous(expand = c(0, 0)) +   # removes space at y-axis
  theme(
    axis.text.y = element_text(size = 10, color = "black"),
      axis.text.x = element_text(size = 10, color = "black"),
    legend.position = c(0.8, 0.2),   # move legend inside plot
    legend.background = element_rect(fill = alpha("white", 0.6), colour = NA), # semi-transparent background
    legend.text  = element_text(size = 10, color = "black")
  )

ggsave(here("outputs/figs/MS/figure_3.png"),width = 250, height =100.92 , units = "mm", bg = "white")

```


From JG: 
"A potentially interesting figure (maybe for SI) could be the share of FM consumed that is foreign sourced (or domestic since that is just 1-share forieign) vs aquaculture production and then labeling countries to see where they fall out."

```{r}
fm_share <- top_species_by_country_2019 %>%
  mutate(
    is_import = importer_iso3c != source_country_iso3c
  ) %>%
  group_by(importer_iso3c) %>%
  summarise(
    total_consumed = sum(product_weight_t, na.rm = TRUE),
    imported = sum(product_weight_t[is_import], na.rm = TRUE),
    domestic = sum(product_weight_t[!is_import], na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    prop_imported = imported / total_consumed,
    prop_domestic = domestic / total_consumed
  )


# aquaculture production data from FAO
aqua_country <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/CL_FI_COUNTRY_GROUPS.csv") %>%
  clean_names() %>%
  dplyr::select(country_un_code = un_code, iso3c = iso3_code)

aqua_spp <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/CL_FI_SPECIES_GROUPS.csv") %>%
  clean_names() %>%
  dplyr::select(x3a_code, common_name = name_en, isscaap_group_en, major_group, scientific_name)

aqua_prod <- read.csv("/mnt/rdsi/raw_data/fao/FAO_fishstat_2020/aquaculture_production_2024/Aquaculture_Quantity.csv") %>%
  clean_names() %>%
  left_join(aqua_country) %>%
  filter(iso3c != "") %>%
  left_join(aqua_spp, by = c("species_alpha_3_code" = "x3a_code")) %>%
  dplyr::select(iso3c, year = period, common_name, scientific_name, isscaap_group_en, major_group, tonnes_lw = value)


all_aquaculture_fed <- aqua_prod %>%
  filter(year %in% c(2015:2019)) %>%
  filter(!(isscaap_group_en %in% c("Brown seaweeds", "Red seaweeds", "Green seaweeds", "Miscellaneous aquatic plants", "Freshwater molluscs", "Abalones, winkles, conchs", "Oysters", "Mussels", "Scallops, pectens",                "Clams, cockles, arkshells", "Miscellaneous marine molluscs", "Sea-urchins and other echinoderms", "Miscellaneous aquatic invertebrates", "Pearls, mother-of-pearl, shells"))) %>% # filter out any algae/seaweeds
   filter(!str_detect(common_name, "carp")) %>% # filter out carps, seaweeds, and bivalve molluscs
      group_by(iso3c, year) %>%
    summarise(
            live_weight_t = sum(tonnes_lw, na.rm = TRUE)

    ) %>%
    ungroup() %>%
  filter(live_weight_t > 0)

iso3c_aqua_fed <- all_aquaculture_fed %>%
  group_by(iso3c) %>%
  summarise(live_weight_t_farmed = mean(live_weight_t, na.rm = TRUE)) %>%
  ungroup()


fm_aqua_share <- fm_share %>%
  left_join(iso3c_aqua_fed, by = c("importer_iso3c" = "iso3c"))


# packages
library(tidyverse)
library(ggrepel)
library(scales)

# add continent variable
fm_plot_df <- fm_aqua_share %>%
  transmute(
    iso3c = importer_iso3c,
    aquaculture_t = live_weight_t_farmed,
    foreign_share = prop_imported,
    continent = countrycode(importer_iso3c, origin = "iso3c", destination = "continent")
  ) %>%
  filter(!is.na(aquaculture_t), !is.na(foreign_share))

# label largest producers
to_label <- fm_plot_df %>%
  slice_max(aquaculture_t, n = 10) %>%
  distinct(iso3c, .keep_all = TRUE)

# plot with continent colors
p <- ggplot(fm_plot_df, aes(x = aquaculture_t, y = foreign_share, color = continent)) +
  geom_point(alpha = 0.7, size = 4) +
  geom_hline(yintercept = 0.5, linetype = 2, linewidth = 0.3) +
  geom_text_repel(
    data = to_label,
    aes(label = iso3c),
    size = 5,
    max.overlaps = Inf,
    box.padding = 0.3,
    point.padding = 0.2,
    min.segment.length = 0,
    show.legend = FALSE
  ) +
  scale_x_log10(
    labels = label_number(scale_cut = cut_si("t")),
    breaks = 10^(0:8)
  ) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, 0.1),
    labels = label_percent(accuracy = 1)
  ) +
  labs(
    x = "Aquaculture production (live weight, tonnes, log scale)",
    y = "Foreign share of fishmeal consumed",
    color = "Continent",
  ) +
  theme_minimal(base_size = 16) +
  theme(panel.grid.minor = element_blank())

# p

ggsave(p, filename = here("outputs/figs/SI/figure_s1.png"), 
       width = 300, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

test <- top_species_by_country_2019 %>%
  filter(importer_iso3c == "CHL") # interesting. they import a lot of fishmeal?? From peru. Makes sense

sum(test$product_weight_t) # 3432.691
```

ARCHIVE: 

```{r}
# Save the whole fish map as plot B
trade_flows_2 <- filter(top_species_by_country_2019, exporter_iso3c != importer_iso3c)

plot_b <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "wholefish"), 
                   country_fill = "importer_iso3c", 
                   flow_arrows = TRUE, 
                   arrow_label = "Exports (million t)", 
                   fill_label = "Imports (million t)", 
                   value = "product_weight_t",
                   n_flows = 5) + 
    labs(subtitle = "B", caption = "Whole fish fishmeal") +
      theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(),            # Remove any rectangular elements
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")                            
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

test <- trade_flows_2 %>% filter(fishmeal_type == "wholefish") %>% group_by(importer_iso3c, exporter_iso3c) %>% summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>% ungroup()

test %>% filter(importer_iso3c == "CHN") %>% pull(tonnes) %>% sum()/sum(test$tonnes) # 0.5078128; ~50% of imports go to China. The scale on the plot makes it seem more like 80%? It's because the scale is out of 1 million. So that is millions of tonnes, not a proportion.


ggsave(plot = plot_b, filename = here("outputs/figs/MS/figure_2b.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the trimmings map as plot C
plot_c <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "importer_iso3c", 
                   flow_arrows = TRUE, 
                   arrow_label = "Exports (million t)", 
                   fill_label = "Imports (million t)", 
                   value = "product_weight_t", 
                   n_flows = 5) +
    labs(subtitle = "C", caption = "Trimmings fishmeal") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(),               # Remove any rectangular elements
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

ggsave(plot = plot_c, filename = here("outputs/figs/MS/figure_2c.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)


# Save the fishmeal production map as plot D
plot_d1 <- plot_map(top_species_by_country_2019 %>% filter(fishmeal_type == "wholefish"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t"
                  )  

plot_d2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "wholefish"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_d2$layer[[2]]

arrow_scale <- plot_d2$scales$scales[[
  which(sapply(plot_d2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_d <- plot_d1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "D",
       caption = "Whole fish fishmeal", 
       color = "Exports (million t)",
       fill = "Production (million t)") +
  theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   # Remove any rectangular elements
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )

ggsave(plot = plot_d, filename = here("outputs/figs/MS/figure_2d.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)

# Save the fishmeal production map as plot E
plot_e1 <- plot_map(top_species_by_country_2019 %>% filter(fishmeal_type == "trimmings"), 
                   country_fill = "source_country_iso3c", 
                   fill_label = "Production (million t)", 
                   value = "product_weight_t" 
                  ) 

plot_e2 <- plot_map(trade_flows_2 %>% filter(fishmeal_type == "trimmings"),
           flow_arrows = TRUE,
           arrow_label = "Exports (million t)",
           value = "product_weight_t",
           n_flows = 5)

arrow_layer <- plot_e2$layer[[2]]

arrow_scale <- plot_e2$scales$scales[[
  which(sapply(plot_e2$scales$scales, function(x) "colour" %in% x$aesthetics))
]]

plot_e <- plot_e1 + 
  arrow_layer + 
  arrow_scale + 
  labs(subtitle = "E",
       caption = "Trimmings fishmeal", 
       color = "Exports (million t)", 
       fill = "Production (million t)") + 
    theme(
      panel.border = element_blank(),    # Remove the border
      panel.background = element_blank(), # Remove the panel background
      plot.background = element_blank(),  # Remove the plot background
      axis.line = element_blank(),        # Remove axis lines
      panel.grid = element_blank(),       # Remove grid lines
      rect = element_blank(), 
           plot.subtitle=element_text(size=14, hjust = 0.1,  color="black", face = "bold"), 
      plot.caption=element_text(size=12, color="black")   # Remove any rectangular elements
    ) +
    guides(
      colour = guide_colorbar(
        order = 1,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      ),
      fill = guide_colorbar(
        order = 2,
        barwidth = 15,
        barheight = 0.3,
        title.position = "top",
        title.hjust = 0,
        label.position = "bottom",
        ticks.linewidth = 0.5,
        frame.linewidth = 0.5,
        direction = "horizontal"
      )
    )



ggsave(plot = plot_e, filename = here("outputs/figs/MS/figure_2e.png"), 
       width = 180, 
       height = 200,  # Increased height to accommodate all plots
       units = "mm", 
       bg = "white", 
       dpi = 300)
```

