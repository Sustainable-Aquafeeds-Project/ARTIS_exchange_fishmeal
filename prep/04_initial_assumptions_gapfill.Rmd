---
title: "Gapfill with simple assumptions"
output: html_document
date: "2024-08-01"
editor_options: 
  chunk_output_type: console
---

## Summary

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(qs)

source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

artis_version <- "new" # set version you want to run (old or new data from Jessica - this is temporary until we get more details on the new data from Jessica)


fillet_artis <- full_artis %>%
  filter(hs6 != 230120) %>%
  dplyr::select(-hs_version) %>% # don't need this
  rename(consumer_iso3c = importer_iso3c) # just to make things consistent

if(artis_version == "old"){
fm_artis <- full_artis %>%
  filter(hs6 == 230120) %>%
    rename(consumer_iso3c = importer_iso3c) %>%
  dplyr::select(-hs_version)

  
}else{

fm_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_2024_09_19.qs")) %>%
  mutate(hs6 = 230120,
         dom_source = ifelse(dom_source == "", consumption_type, dom_source)) %>%
  dplyr::select(year, source_country_iso3c, exporter_iso3c, consumer_iso3c, dom_source, hs6, sciname, habitat, method, product_weight_t, live_weight_t = consumption_t_capped) %>%
  mutate(exporter_iso3c = ifelse(source_country_iso3c == consumer_iso3c, source_country_iso3c, exporter_iso3c))
}

setdiff(colnames(fillet_artis), colnames(fm_artis))
setdiff(colnames(fm_artis), colnames(fillet_artis)) # 0 good


artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) ## read in attribute table with common names
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

asia_iso3c <- countries %>% 
  filter(owid_region == "Asia") %>%
  pull(iso3c)

```

Join ARTIS data to data compiled from literature review

```{r}
fm_origins_df_fin <- read.csv(here("outputs/all_fmfo_material_origins_reports.csv")) %>%
 # mutate(method = ifelse(capture == "yes", "capture", "aquaculture")) %>%
  dplyr::select(-common_name)

# take a look at the distribution of values
ggplot(fm_origins_df_fin) +
  geom_histogram(aes(trim_prop)) +
  theme_bw() +
  labs(x = "Proportion of fishmeal derived from trimmings",
       y = "Distinct species and source country count")

artis_trimmings_all <- fm_artis %>%
 # left_join(artis_taxa) %>%
  left_join(fm_origins_df_fin, by = c("sciname", "source_country_iso3c" = "iso3c")) %>%
   left_join(artis_taxa)

artis_trimmings_info <- artis_trimmings_all %>% 
  filter(!is.na(trimmings)) %>%
  mutate(method_gf = NA,
         trimmings_gf = trimmings,
         wholefish_gf = wholefish,
         trim_prop_gf = trim_prop) %>%
  mutate(trimmings_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", "yes", trimmings_gf),
         wholefish_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", "no", wholefish_gf),
        trim_prop_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", 1, trim_prop_gf)) %>%  # fix the mexico yellowfin tuna instance
  ## fix some (rare) instances when method is aquaculture but our info is capture and they are matching. Just make these NA
  mutate(trimmings_gf = case_when(
    method == "aquaculture" & capture == "yes" & !is.na(trim_prop_gf) ~ NA,
    TRUE ~ trimmings_gf
  ),
         wholefish_gf = case_when(
            method == "aquaculture" & capture == "yes" & !is.na(trim_prop_gf) ~ NA,
            TRUE ~ wholefish_gf
         ),
    trash_fish = case_when(
     method == "aquaculture" & capture == "yes" & !is.na(trim_prop_gf) ~ "no",
     TRUE ~ trash_fish),
         trim_prop_gf = case_when(
            method == "aquaculture" & capture == "yes" & !is.na(trim_prop_gf) ~ NA,
            TRUE ~ trim_prop_gf
         ),
        trimmings = case_when(
            method == "aquaculture" & capture == "yes" & !is.na(trim_prop) ~ NA,
            TRUE ~ trimmings
         ),
        wholefish = case_when(
            method == "aquaculture" & capture == "yes" & !is.na(trim_prop) ~ NA,
            TRUE ~ wholefish
         ),
           trim_prop = case_when(
            method == "aquaculture" & capture == "yes" & !is.na(trim_prop) ~ NA,
            TRUE ~ trim_prop_gf
         )
  )

artis_trimmings_info_fix <- artis_trimmings_info %>%
  filter(!is.na(trim_prop_gf))

artis_trimmings_missing_1 <- artis_trimmings_info %>% 
  filter(is.na(trim_prop_gf)) %>%
  dplyr::select(-trim_prop_gf, -trimmings_gf, -wholefish_gf, -method_gf)

artis_trimmings_missing <- artis_trimmings_all %>% 
  filter(is.na(trimmings)) %>%
  rbind(artis_trimmings_missing_1)

test_all <- artis_trimmings_all %>%
  filter(year == 2020) %>%
  mutate(trim_weight = product_weight_t*trim_prop,
         whole_weight = product_weight_t*(1-trim_prop))

sum(test_all$product_weight_t) # 6237031
sum(test_all$trim_weight, na.rm = TRUE) # 850941.9
sum(test_all$whole_weight, na.rm = TRUE) # 1683809

1683809/6237031 # 27% from whole fish 
850941.9/6237031 # 13.6 from trimmings
0.2699696+0.1364338
# ok so missing ~59% of fishmeal for 2020

# Define a helper function for trash fish conditions
is_asian_trash_fish <- function(common_name, phylum, sciname, source_country_iso3c, method) {
    method != "aquaculture" & 
    str_detect(common_name, "nei|ray-finned fishes") & 
    phylum == "chordata" & 
    source_country_iso3c %in% asia_iso3c & 
    !(sciname %in% c("salmonidae", "salmo", "perciformes"))
}

artis_trimmings_gf <- artis_trimmings_missing %>%
  mutate(
    # Define trimmings_gf column
    trimmings_gf = case_when(
      # trash fish assumption from Majluf et al.: https://www.science.org/doi/10.1126/sciadv.adn5650
      is_asian_trash_fish(common_name, phylum, sciname, source_country_iso3c, method) ~ "no", 
      # finfish aquaculture = trimmings: skretting report, Ytrestroyl et al. 2015, Xu and Ming 2018, Penarubia et al. 2023
      method == "aquaculture" & phylum == "chordata" ~ "yes",
      # wild caught tuna and salmon in IFFO report and from leadbitter conversation
      str_detect(common_name, "tuna|Tuna|albacore|Albacore") & method != "aquaculture" ~ "yes",
      family == "salmonidae" & method != "aquaculture" ~ "yes",
      sciname == "salmoninae" & method != "aquaculture" ~ "yes",
      # From https://link.springer.com/book/10.1007/978-94-011-4018-8; IFFO report
      isscaap == "Squids, cuttlefishes, octopuses" ~ "yes",
      # duh
      str_detect(common_name, "krill") ~ "no",
      # not sure
      str_detect(common_name, "barnacle") ~ "no",
      # same assumption as majluf et al...
      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "no",
      # IFFO report; https://link.springer.com/book/10.1007/978-94-011-4018-8
      isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | 
        common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | 
        str_detect(common_name, "crab|abalone|shrimp|squillid") | 
        genus %in% c("geryon", "scylla") ~ "yes",
      #  assume mollusc meal is whole fish: https://link.springer.com/book/10.1007/978-94-011-4018-8
      isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & 
        phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ "no",
      TRUE ~ trimmings
    ),
    
    # Define wholefish_gf column
    wholefish_gf = case_when(
      is_asian_trash_fish(common_name, phylum, sciname, source_country_iso3c, method) ~ "yes",
      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "yes",
      method == "aquaculture" & phylum == "chordata" ~ "no",
      family == "salmonidae" & method != "aquaculture" ~ "no",
      sciname == "salmoninae" & method != "aquaculture" ~ "no",
      str_detect(common_name, "tuna|Tuna|albacore|Albacore") & method != "aquaculture" ~ "no",
      str_detect(common_name, "krill") ~ "yes",
      isscaap == "Squids, cuttlefishes, octopuses" ~ "no",
      isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | 
        common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | 
        str_detect(common_name, "crab|abalone|shrimp|squillid") | 
        genus %in% c("geryon", "scylla") ~ "no",
      isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & 
        phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ "yes",
      str_detect(common_name, "barnacle") ~ "yes",
      TRUE ~ wholefish
    ),
    
    # Define trim_prop_gf column
    trim_prop_gf = case_when(
      is_asian_trash_fish(common_name, phylum, sciname, source_country_iso3c, method) ~ 0,
      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ 0,
      method == "aquaculture" & phylum == "chordata" ~ 1,
      family == "salmonidae" & method != "aquaculture" ~ 1,
      sciname == "salmoninae" & method != "aquaculture" ~ 1,
      str_detect(common_name, "tuna|Tuna|albacore|Albacore") & method != "aquaculture" ~ 1,
      str_detect(common_name, "krill") ~ 0,
      isscaap == "Squids, cuttlefishes, octopuses" ~ 1,
      isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | 
        common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | 
        str_detect(common_name, "crab|abalone|shrimp|squillid") | 
        genus %in% c("geryon", "scylla") ~ 1,
      isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & 
        phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ 0,
      str_detect(common_name, "barnacle") ~ 0,
      TRUE ~ trim_prop
    ),
    
        # Define methd_gf column
    method_gf = case_when(
      is_asian_trash_fish(common_name, phylum, sciname, source_country_iso3c, method) ~ "Asian trash fish assumption",
      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "unknown species, assume wholefish",
      method == "aquaculture" & phylum == "chordata" ~ "aquaculture trimmings",
      family == "salmonidae" & method != "aquaculture" ~ "wild caught salmon trimmings",
      sciname == "salmoninae" & method != "aquaculture" ~ "wild caught salmon trimmings",
      str_detect(common_name, "tuna|Tuna|albacore|Albacore") & method != "aquaculture" ~ "wild caught tuna trimmings",
      str_detect(common_name, "krill") ~ "krill meal",
      isscaap == "Squids, cuttlefishes, octopuses" ~ "squid, cuttlefish, or octopus trimmings",
      isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | 
        common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | 
        str_detect(common_name, "crab|abalone|shrimp|squillid") | 
        genus %in% c("geryon", "scylla") ~ "Shrimp, prawns, lobster, crab, or abalone trimmings",
      isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & 
        phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ "mollusc meat",
      str_detect(common_name, "barnacle") ~ "barnacle",
      TRUE ~ NA
    )
  ) %>%
  
  # add trash fish column
  mutate(
    trash_fish = case_when(
      is_asian_trash_fish(common_name, phylum, sciname, source_country_iso3c, method) ~ "yes",
      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "yes",
      TRUE ~ trash_fish
    )
    ) %>%
  
  # Leadbitter report suggests that pangasius are always trimmings in vietnam
  mutate(
    trimmings_gf = ifelse(str_detect(sciname, "pangasi") & source_country_iso3c == "VNM", "yes", trimmings_gf),
    wholefish_gf = ifelse(str_detect(sciname, "pangasi") & source_country_iso3c == "VNM", "no", wholefish_gf),
    trim_prop_gf = ifelse(str_detect(sciname, "pangasi") & source_country_iso3c == "VNM", 1, trim_prop_gf),
    method_gf = ifelse(str_detect(sciname, "pangasi") & source_country_iso3c == "VNM", "Leadbitter report pangasius", method_gf)
  ) %>%
  distinct()



## rbind back together after prelimnary gapfilling
setdiff(colnames(artis_trimmings_info_fix), colnames(artis_trimmings_gf))

artis_trimmings_all_gf <- artis_trimmings_info_fix %>%
  rbind(., artis_trimmings_gf) %>%
  distinct() %>%
  dplyr::select(-wholefish, -trimmings, -trim_prop) %>%
mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing
## ok looks like all gapfilling went good


## lets save this to RDSI
if(artis_version == "old"){
qs::qsave(artis_trimmings_all_gf, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded.qs"))
}else{
  qs::qsave(artis_trimmings_all_gf, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded_consumption.qs"))

}

```

Some testing to make sure things ran ok 

```{r}
trim_gf <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded_consumption.qs"))

summary <- trim_gf %>%
  filter(year == 2020) %>%
  group_by(method_gf) %>%
  summarise(tonnes_prod_gf = sum(product_weight_t, na.rm = TRUE),
            spp = n_distinct(sciname),
            iso3c = n_distinct(source_country_iso3c)) %>%
  ungroup() %>%
  mutate(prop = tonnes_prod_gf/sum(tonnes_prod_gf))


test_all <- trim_gf %>%
  filter(year == 2020) 

sum(test_all$product_weight_t) # 6237031
sum(test_all$trim_product, na.rm = TRUE) + sum(test_all$wholefish_product, na.rm = TRUE)

5765249/6237031
# only missing ~8% now 
```


```{r}
test_sal_tuna <- artis_trimmings_all_gf %>%
  filter(year == "2020",
         str_detect(common_name, "tuna|almonids nei"),
         method == "capture",
         trash_fish == "yes") # should be 0 

test_trash <- artis_trimmings_all_gf %>%
  filter(trash_fish == "yes") %>%
  distinct(sciname, common_name, method) # should be no aquaculture here

test <- artis_trimmings_all_gf %>%
  filter(sciname %in% c("larimichthys crocea", "lateolabrax japonicus", "oreochromis"),
         method == "aquaculture", 
         year == 2020,
         trash_fish == "yes") # good 0 


test <- artis_trimmings_info %>%
  filter(
         method == "aquaculture", 
         year == 2020,
         trim_prop_gf  <1 & trim_prop_gf > 0) # cool these are all as defined in the sustainability reports

```


```{r}

## lets do some testing
test_crustacean <- artis_trimmings_gf %>% 
 # filter(year == 2020) %>%
  filter(isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | str_detect(common_name, "crab|shrimp|squillid") |  genus %in% c("geryon", "scylla")) 

sum(test_crustacean$product_weight_t)/sum(artis_trimmings_all$product_weight_t) # 0.1384497

test_shrimp <- artis_trimmings_gf %>%
 # filter(year == 2020) %>%
  filter(isscaap %in% c("Shrimps, prawns") | str_detect(common_name, "shrimp"))
sum(test_shrimp$product_weight_t)/sum(artis_trimmings_all$product_weight_t) # 0.1156375

test_mollusc <- artis_trimmings_gf %>%
 # filter(year == 2020) %>%
  filter(isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle|octopus|squid"))

test2 <- artis_trimmings_all %>%
 # filter(year == 2020) %>%
  pull(product_weight_t) %>%
  sum()

sum(test_mollusc$product_weight_t)/test2 # 0.2013136

test <- artis_trimmings_all %>%
  group_by(phylum, year) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_tonnes = sum(tonnes, na.rm = TRUE)) %>%
  mutate(prop = tonnes/total_tonnes) ## cool, checks out. Will probably make more sense to report numbers for 2020 in the actual paper, but global across all years will do for exploration purposes

# what are we still missing?
test <- artis_trimmings_all_gf %>%
  filter(is.na(trim_prop_gf)) %>%
  group_by(phylum) %>%
  summarise(tonnes  = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() # ok, need to figure out what to do about echinodermata and cnidaria; chordata is expected to have a lot of gaps.

test <- artis_trimmings_all_gf %>% 
  filter(is.na(trim_prop_gf)) %>%
  filter(phylum %in% c("echinodermata", "cnidaria"))
unique(test$common_name)
#  [1] "sea urchins nei"            "chilean sea urchin"         "sea cucumbers nei"          "starfishes nei"            
#  [5] "echinoderms"                "stony sea urchin"           "european edible sea urchin" "japanese sea cucumber"     
#  [9] "white teatfish"             "prickly redfish"            ""                           "sea urchins, etc. nei"     
# [13] "cannonball jellyfish"       "royal cucumber"             "brown mottled sea cucumber" "red starfish"              
# [17] "black sea urchin"   
# my guesses would be mostly trimmings given most of these are expensive (sea urchins in particular). However, I am having a hard time finding any info on if any of these are used as fishmeal.. so will gapfill these all with price data


```


Data checking and exploration

Let's look at just finfish species and see how much is missing. We believe that IFFO might only report finfish destined for human consumption, which would explain why our trimmings numbers are larger.


```{r}

artis_trimmings_all_gf <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_not_gf_traded_consumption.qs"))

colnames(artis_trimmings_all_gf)


```

Make some more pretty plots

```{r}

artis_all_2020 <- artis_trimmings_all_gf %>%
  filter(year == 2020) %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  mutate(owid_region = ifelse(is.na(owid_region), "unknown", owid_region))

total_product_weight <- sum(artis_all_2020$product_weight_t, na.rm = TRUE) 
# 3507032
# 6233093 using new data with domestic consumption!? Not sure if that is right... FAO SOFIA says there is ~5 million tonnes

test <- artis_all_2020 %>%
  mutate(fm_consumed_source = ifelse(source_country_iso3c != consumer_iso3c, "domestic", "foreign")) %>%
  mutate(fm_consumed_source = ifelse(dom_source == "error", "error", fm_consumed_source)) %>%
  group_by(fm_consumed_source) %>%
  summarise(sum_t = sum(product_weight_t, na.rm = TRUE)) # interesting... claims about the same comes from domestic as foreign.. not sure that makes sense. 

## Let's make a bar plot and have x axis be the type of fish meal, y axis the proportion it represents, and fill by continent

no_info_df <- artis_all_2020 %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "Not sure") %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- artis_all_2020 %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "Trimmings", "Whole fish")) %>%
  # mutate(fishmeal_type = ifelse(trash_fish == "yes", "Biomass fishery (trash fish)", 
   #                              ifelse(is.na(trash_fish)|trash_fish == "no", fishmeal_type, fishmeal_type))) %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type))  %>%
  filter(prop > 0) %>%
  arrange(-prop) 

## oceania: #9F6144
## Africa: #A660A1
## Asia: #3F8D87
## South America: #8F464E
## North America: #E47669
## Europe: #5E74A1
## unknown: #808080
  
ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = continent)) +
  geom_bar(stat = "identity", color = "white") + 
 scale_fill_manual(values = c("#A660A1", "#3F8D87", "#5E74A1", "#E47669", "#9F6144", "#8F464E", "#808080")) +
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) # oh gosh... with the new data now ~50% from trimmings WITHOUT gapfilling...



no_info_df <- artis_all_2020 %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "Not sure") %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- artis_all_2020 %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "Trimmings", "Whole fish")) %>%
  # mutate(fishmeal_type = ifelse(trash_fish == "yes", "Biomass fishery (trash fish)", 
   #                              ifelse(is.na(trash_fish)|trash_fish == "no", fishmeal_type, fishmeal_type))) %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type))  %>%
  filter(prop > 0) %>%
  arrange(-prop) 

  
ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = phylum)) +
  geom_bar(stat = "identity", color = "white") + 
# scale_fill_manual(values = c("#A660A1", "#3F8D87", "#5E74A1", "#E47669", "#9F6144", "#8F464E", "#808080")) +
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) # oh gosh... with the new data now ~50% from trimmings WITHOUT gapfilling...

test <- artis_all_2020 %>%
  filter(phylum == "chordata",
         is.na(trim_prop_gf)) %>%
  group_by(common_name) %>%
  summarise(tonnes = sum(product_weight_t))

```


Look at finfish only 

```{r}
artis_finfish <- artis_trimmings_all_gf %>%
  filter(year == 2020) %>% 
  filter(phylum %in% c("chordata", NA)) %>% # ok only finfish (or NA)
  filter(!(common_name %in% c("sea urchins", "saltwater mussels", "sea lamprey", "lampreys nei"))) %>%
    left_join(countries, by = c("source_country_iso3c" = "iso3c"))


test <- artis_finfish %>%
  filter(is.na(trim_prop_gf))

sum(test$product_weight_t) # 331945.7 missing total

## look at countries with trimmings:

test <- artis_finfish %>%
  filter(trimmings_gf == "yes") %>%
  group_by(source_country_iso3c) %>%
  summarise(total_trim_iso3c = sum(trim_product)) %>%
  ungroup() %>%
  mutate(total_trim_prop = total_trim_iso3c/sum(artis_finfish$trim_product, na.rm = TRUE)) %>%
  ungroup()
  
## look at countries with most missing

test <- artis_finfish %>%
  filter(is.na(trim_prop_gf)) %>%
  group_by(source_country_iso3c) %>%
  summarise(total_product = sum(product_weight_t)) %>%
  ungroup() 

unique(test$source_country_iso3c) # lots of countries here 

total_product_weight <- artis_finfish %>% 
  pull(product_weight_t) %>%
  sum() # 2996927

no_info_df <- artis_finfish %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- artis_finfish %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "Trimmings", "Whole fish")) %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type))  %>%
  filter(prop > 0) %>%
  arrange(-prop) 

## oceania: #9F6144
## Africa: #A660A1
## Asia: #3F8D87
## South America: #8F464E
## North America: #E47669
## Europe: #5E74A1
## unknown: #808080
  
ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = continent)) +
  geom_bar(stat = "identity", color = "white") + 
 scale_fill_manual(values = c("#A660A1", "#3F8D87", "#5E74A1", "#E47669", "#9F6144", "#8F464E", "#808080")) +
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) # oh gosh... with the new data now ~50% from trimmings WITHOUT gapfilling...


## seems a bit more reasonable/matching to IFFO looking only at finfish...
```


Cao et al 2015
 - Around 40% of China's domestically produced fish meal is from processing waste 
 - European Union forbids use of farmed fish by-products in finfish feeds but allows them to be used in crustacean diets or vice versa. 


Let's look at just China and see if trimmings represents 40% of its finfish fishmeal

```{r}

artis_chn <- artis_all_2020 %>%
  filter(source_country_iso3c == "CHN",
         phylum == "chordata") 


no_info_df <- artis_chn %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()


bar_plot_df <- artis_chn %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
     rbind(., no_info_df) %>%
  mutate(total_product_t = sum(total, na.rm = TRUE)) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%"))

ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = phylum)) +
  geom_bar(stat = "identity", color = "white") + 
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global finfish fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) 


## Awesome! ~40% of fm in china is trimmings. Cao et al suggests 40% in 2015. There is still around 18% missing, so that number might go up a bit, which seems reasonable given the time difference

```

Random notes: 

https://www.marketsandmarkets.com/Market-Reports/aquafeeds-market-1151.html 
  - https://www.fortunebusinessinsights.com/industry-reports/aquafeed-market-100698 says that the aquafeed industry is worth USD 59 billion in 2024
  - https://www.fortunebusinessinsights.com/industry-reports/aquafeed-market-100698 says aquafeed industry is 64.06 billion USD
  - Cargill had net income of 4.93 billion, revenue is 165 billion
  - biomar revenue 2.6 billion, net income??
  - Skretting had 2.68 billion USD revenue


