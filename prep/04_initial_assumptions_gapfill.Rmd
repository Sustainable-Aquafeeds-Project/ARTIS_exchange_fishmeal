---
title: "Gapfill with simple assumptions"
output: html_document
date: "2024-08-01"
editor_options: 
  chunk_output_type: console
---

## Summary

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(qs)

source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

artis_version <- "new" # set version you want to run (old or new data from Jessica - this is temporary until we get more details on the new data from Jessica)


fillet_artis <- full_artis %>%
  filter(hs6 != 230120) %>%
  dplyr::select(-hs_version) %>% # don't need this
  rename(consumer_iso3c = importer_iso3c) # just to make things consistent

if(artis_version == "old"){
fm_artis <- full_artis %>%
  filter(hs6 == 230120) %>%
    rename(consumer_iso3c = importer_iso3c) %>%
  dplyr::select(-hs_version)

  
}else{

fm_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_2024_09_19.qs")) %>%
  mutate(hs6 = 230120,
         dom_source = ifelse(dom_source == "", consumption_type, dom_source)) %>%
  dplyr::select(year, source_country_iso3c, exporter_iso3c, consumer_iso3c, dom_source, hs6, sciname, habitat, method, product_weight_t, live_weight_t = consumption_t_capped) %>%
  mutate(exporter_iso3c = ifelse(source_country_iso3c == consumer_iso3c, source_country_iso3c, exporter_iso3c))
}

setdiff(colnames(fillet_artis), colnames(fm_artis))
setdiff(colnames(fm_artis), colnames(fillet_artis)) # 0 good


artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) ## read in attribute table with common names
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

asia_iso3c <- countries %>% 
  filter(owid_region == "Asia") %>%
  pull(iso3c)

```

Join ARTIS data to biomar and skretting information. Provide summary stats for how much info is missing. 

```{r}
fm_origins_df_fin <- read.csv(here("outputs/all_fmfo_material_origins_reports.csv"))

# take a look at the distribution of values
ggplot(fm_origins_df_fin) +
  geom_histogram(aes(trim_prop)) +
  theme_bw() +
  labs(x = "Proportion of fishmeal derived from trimmings",
       y = "Distinct species and source country count")

artis_trimmings_all <- fm_artis %>%
  left_join(artis_taxa) %>%
  left_join(fm_origins_df_fin, by = c("sciname", "source_country_iso3c" = "iso3c", "common_name")) 

artis_trimmings_info <- artis_trimmings_all %>% 
  filter(!is.na(trimmings)) %>%
  mutate(method_gf = NA,
         trimmings_gf = trimmings,
         wholefish_gf = wholefish,
         trim_prop_gf = trim_prop) %>%
  mutate(trimmings_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", "yes", trimmings_gf),
         wholefish_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", "no", wholefish_gf),
        trim_prop_gf = ifelse(source_country_iso3c == "MEX" & common_name == "yellowfin tuna", 1, trim_prop_gf))  # fix the mexico yellowfin tuna instance



# https://www.science.org/doi/10.1126/sciadv.adn5650 say much trash fish fish meal is classified as “mixed fish” or “nei” in FAO; i think these are safe assumptions for SE asia 

#         - U. R. Sumaila, W. W. L. Cheung, L. S. L. Teh, A. H. Y. Bang, T. Cashion, Z. Zeng, J. J. Alava, S. Le Clue, Y. Sadovy de Mitcheson, “Sink or swim: The future of fisheries in the East and South China Seas” (ADM Capital Foundation, 2021).
#         - Y. Sadovy de Mitcheson, D. Leadbitter, C. Law, “History, profiles and implications of feed fish and fishmeal supply from domestic trawlers in the East and South China Seas - Final Report to ADMCF” (2018).



artis_trimmings_missing <- artis_trimmings_all %>% 
  filter(is.na(trimmings))

test_all <- artis_trimmings_all %>%
  group_by(trimmings) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop = tonnes/sum(tonnes)) # ok missing ~62% of fishmeal 

# nrow(artis_trimmings_missing) + nrow(artis_trimmings_info) == nrow(artis_trimmings_all) # TRUE

artis_trimmings_gf <- artis_trimmings_missing %>% 
  mutate(trimmings_gf = 
           case_when(
                      method == "aquaculture" & phylum == "chordata" ~ "yes", # finfish aquaculture, assume it is trimmings.
                      str_detect(common_name, "tuna|Tuna|albacore|Albacore") ~ "yes", # tuna species are trimmings; Leadbitter backs this up for Asia
                      family == "salmonidae" ~ "yes", #  salmon species are trimmings
                      sciname == "salmoninae" ~ "yes",
                      isscaap == "Squids, cuttlefishes, octopuses" ~ "yes", # squid/octo are high value, so only trimmings
                      str_detect(common_name, "krill") ~ "no", # krill are "wholefish"
                      str_detect(common_name, "barnacle") ~ "no",
                      method != "aquaculture" & str_detect(common_name, "nei|ray-finned fishes") & phylum == "chordata" & source_country_iso3c == asia_iso3c ~ "no", # likely trash fish - according to majluf et al. We will include all asia
                      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "no", # unknown capture fisheries are whole fish; might need to revise this. This might not be true in the western world. 
             isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | str_detect(common_name, "crab|abalone|shrimp|squillid") | genus %in% c("geryon", "scylla") ~ "yes", 
             isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ "no",
             TRUE ~ trimmings
           ),
         wholefish_gf = 
           case_when(
      method != "aquaculture" & str_detect(common_name, "nei|ray-finned fishes") & phylum == "chordata" & source_country_iso3c %in% asia_iso3c ~ "yes",   
       method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "yes",
            method == "aquaculture" & phylum == "chordata" ~ "no",
             family == "salmonidae" ~ "no",
             sciname == "salmoninae" ~ "no",
             str_detect(common_name, "tuna|Tuna|albacore|Albacore") ~ "no", # any tuna species are trimmings
            str_detect(common_name, "krill") ~ "yes",
       isscaap == "Squids, cuttlefishes, octopuses" ~ "no",
      isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | str_detect(common_name, "crab|abalone|shrimp|squillid") |  genus %in% c("geryon", "scylla") ~ "no", 
                   isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ "yes",
      str_detect(common_name, "barnacle") ~ "yes",
             TRUE ~ wholefish
           ),
        trim_prop_gf = 
           case_when(
                   method != "aquaculture" & str_detect(common_name, "nei|ray-finned fishes") & phylum == "chordata" & source_country_iso3c %in% asia_iso3c ~ 0,   
                    method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ 0,
             method == "aquaculture" & phylum == "chordata" ~ 1, # assume finfish aquaculture is all trimmings, unless feed reports suggest otherwise
             family == "salmonidae" ~ 1, # assume salmon is all trimmings
             sciname == "salmoninae" ~ 1, # assume salmon is all trimmings
             str_detect(common_name, "tuna|Tuna|albacore|Albacore") ~ 1, # assume tuna is all trimmings
             str_detect(common_name, "krill") ~ 0, 
              isscaap == "Squids, cuttlefishes, octopuses" ~ 1,
             isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | str_detect(common_name, "crab|abalone|shrimp|squillid") |  genus %in% c("geryon", "scylla") ~ 1, 
                          isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & phylum == "mollusca" & !str_detect(common_name, "abalone") ~ 0,
             str_detect(common_name, "barnacle") ~ 0,
             TRUE ~ trim_prop
           ),
        method_gf = 
           case_when(
                   method != "aquaculture" & str_detect(common_name, "nei|ray-finned fishes") & phylum == "chordata" & source_country_iso3c %in% c(asia_iso3c) ~ "Asian trash fish assumption",   
                    method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "unknown species, assume wholefish",
            method == "aquaculture" & phylum == "chordata" ~ "aquaculture", # assume finfish aquaculture is all trimmings
             family == "salmonidae" ~ "salmon; high value", # assume salmon is all trimmings
             sciname == "salmoninae" ~ "salmon; high value", # assume salmon is all trimmings
             str_detect(common_name, "tuna|Tuna|albacore|Albacore") ~ "tuna; high value", # assume tuna is all trimmings
             str_detect(common_name, "krill") ~ "krill", 
             isscaap == "Squids, cuttlefishes, octopuses" ~ "squid, cuttlefish, or octopus trimmings",
            isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | str_detect(common_name, "crab|abalone|shrimp|squillid") |  genus %in% c("geryon", "scylla") ~ "Shrimps, prawns, lobster, crab, or abalone trimmings", 
                         isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle") ~ "mollusc meat",
            str_detect(common_name, "barnacle") ~ "barnacle",
             TRUE ~ NA
           ),
      trash_fish = case_when(
                              method != "aquaculture" & str_detect(common_name, "nei|ray-finned fishes") & phylum == "chordata" & source_country_iso3c == asia_iso3c ~ "yes", # likely trash fish - according to majluf et al. We will include all asia
                      method != "aquaculture" & sciname %in% c("animalia", "actinopterygii") ~ "yes", # unknown capture fisheries are whole fish; might need to revise this. This might not be true in the western world. 
                      TRUE ~ trash_fish
      )
         ) %>%
  mutate(capture = 
           case_when(
             method == "capture" ~ "yes",
             method == "aquaculture" ~ "no",
             TRUE ~ capture
           )) %>%
  distinct() %>%
  mutate(trash_fish = ifelse(is.na(trash_fish), "no", trash_fish)) %>%
  mutate(trimmings_gf = case_when(
    str_detect(sciname, "pangasi") & source_country_iso3c == "VNM" ~ "yes", 
    TRUE ~ trimmings_gf
  ),
  wholefish_gf = case_when(
    str_detect(sciname, "pangasi") & source_country_iso3c == "VNM" ~ "no", 
    TRUE ~ wholefish_gf
  ), 
  trim_prop_gf = case_when(
    str_detect(sciname, "pangasi") & source_country_iso3c == "VNM" ~ 1,  # leadbitter report says catfish are only used as trimmings on VNM.
    TRUE ~ trim_prop_gf
  ))

## rbind back together after prelimnary gapfilling

artis_trimmings_all_gf <- artis_trimmings_info %>%
  rbind(., artis_trimmings_gf) %>%
  distinct() %>%
  dplyr::select(-wholefish, -trimmings, -trim_prop) %>%
mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing
## ok looks like all gapfilling went good


## lets save this to RDSI
if(artis_version == "old"){
qs::qsave(artis_trimmings_all_gf, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded.qs"))
}else{
  qs::qsave(artis_trimmings_all_gf, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded_consumption.qs"))

}

```

```{r}

## lets do some testing
test_crustacean <- artis_trimmings_gf %>% 
 # filter(year == 2020) %>%
  filter(isscaap %in% c("Shrimps, prawns", "Lobsters, spiny-rock lobsters", "King crabs, squat-lobsters") | common_name %in% c("squillids nei", "stomatopods nei", "west african geryon") | str_detect(common_name, "crab|shrimp|squillid") |  genus %in% c("geryon", "scylla")) 

sum(test_crustacean$product_weight_t)/sum(artis_trimmings_all$product_weight_t) # 0.1395017

test_shrimp <- artis_trimmings_gf %>%
 # filter(year == 2020) %>%
  filter(isscaap %in% c("Shrimps, prawns") | str_detect(common_name, "shrimp"))
sum(test_shrimp$product_weight_t)/sum(artis_trimmings_all$product_weight_t) # 0.1156375

test_mollusc <- artis_trimmings_gf %>%
 # filter(year == 2020) %>%
  filter(isscaap %in% c("Abalones, winkles, conchs", "Clams, cockles, arkshells", "Multiple ISSCAAP groups", "Mussels", "Oysters", "Scallops, pectens") & phylum == "mollusca" & !str_detect(common_name, "abalone|barnacle|octopus|squid"))

test2 <- artis_trimmings_all %>%
 # filter(year == 2020) %>%
  pull(product_weight_t) %>%
  sum()

sum(test_mollusc$product_weight_t)/test2 # 0.2013136

test <- artis_trimmings_all %>%
  group_by(phylum, year) %>%
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_tonnes = sum(tonnes, na.rm = TRUE)) %>%
  mutate(prop = tonnes/total_tonnes) ## cool, checks out. Will probably make more sense to report numbers for 2020 in the actual paper, but global across all years will do for exploration purposes

# what are we still missing?
test <- artis_trimmings_all_gf %>%
  filter(is.na(trim_prop_gf)) %>%
  group_by(phylum) %>%
  summarise(tonnes  = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() # ok, need to figure out what to do about echinodermata and cnidaria; chordata is expected to have a lot of gaps.

test <- artis_trimmings_all_gf %>% 
  filter(is.na(trim_prop_gf)) %>%
  filter(phylum %in% c("echinodermata", "cnidaria"))
unique(test$common_name)
#  [1] "sea urchins nei"            "chilean sea urchin"         "sea cucumbers nei"          "starfishes nei"            
#  [5] "echinoderms"                "stony sea urchin"           "european edible sea urchin" "japanese sea cucumber"     
#  [9] "white teatfish"             "prickly redfish"            ""                           "sea urchins, etc. nei"     
# [13] "cannonball jellyfish"       "royal cucumber"             "brown mottled sea cucumber" "red starfish"              
# [17] "black sea urchin"   
# my guesses would be mostly trimmings given most of these are expensive (sea urchins in particular). However, I am having a hard time finding any info on if any of these are used as fishmeal.. so will gapfill these all with price data


```


Data checking and exploration

Let's look at just finfish species and see how much is missing. We believe that IFFO might only report finfish destined for human consumption, which would explain why our trimmings numbers are larger.


```{r}

artis_trimmings_all_gf <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_not_gf_traded_consumption.qs"))

colnames(artis_trimmings_all_gf)


```

Make some more pretty plots

```{r}

artis_all_2020 <- artis_trimmings_all_gf %>%
  filter(year == 2020) %>%
  left_join(countries, by = c("source_country_iso3c" = "iso3c")) %>%
  mutate(owid_region = ifelse(is.na(owid_region), "unknown", owid_region))

total_product_weight <- sum(artis_all_2020$product_weight_t, na.rm = TRUE) 
# 3507032
# 6233093 using new data with domestic consumption!? Not sure if that is right... FAO SOFIA says there is ~5 million tonnes

test <- artis_all_2020 %>%
  mutate(fm_consumed_source = ifelse(source_country_iso3c != consumer_iso3c, "domestic", "foreign")) %>%
  mutate(fm_consumed_source = ifelse(dom_source == "error", "error", fm_consumed_source)) %>%
  group_by(fm_consumed_source) %>%
  summarise(sum_t = sum(product_weight_t, na.rm = TRUE)) # interesting... claims about the same comes from domestic as foreign.. not sure that makes sense. 

## Let's make a bar plot and have x axis be the type of fish meal, y axis the proportion it represents, and fill by continent

no_info_df <- artis_all_2020 %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "Not sure") %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- artis_all_2020 %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "Trimmings", "Whole fish")) %>%
  # mutate(fishmeal_type = ifelse(trash_fish == "yes", "Biomass fishery (trash fish)", 
   #                              ifelse(is.na(trash_fish)|trash_fish == "no", fishmeal_type, fishmeal_type))) %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type))  %>%
  filter(prop > 0) %>%
  arrange(-prop) 

## oceania: #9F6144
## Africa: #A660A1
## Asia: #3F8D87
## South America: #8F464E
## North America: #E47669
## Europe: #5E74A1
## unknown: #808080
  
ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = continent)) +
  geom_bar(stat = "identity", color = "white") + 
 scale_fill_manual(values = c("#A660A1", "#3F8D87", "#5E74A1", "#E47669", "#9F6144", "#8F464E", "#808080")) +
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) # oh gosh... with the new data now ~50% from trimmings WITHOUT gapfilling...



no_info_df <- artis_all_2020 %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "Not sure") %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- artis_all_2020 %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "Trimmings", "Whole fish")) %>%
  # mutate(fishmeal_type = ifelse(trash_fish == "yes", "Biomass fishery (trash fish)", 
   #                              ifelse(is.na(trash_fish)|trash_fish == "no", fishmeal_type, fishmeal_type))) %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type))  %>%
  filter(prop > 0) %>%
  arrange(-prop) 

  
ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = phylum)) +
  geom_bar(stat = "identity", color = "white") + 
# scale_fill_manual(values = c("#A660A1", "#3F8D87", "#5E74A1", "#E47669", "#9F6144", "#8F464E", "#808080")) +
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) # oh gosh... with the new data now ~50% from trimmings WITHOUT gapfilling...

test <- artis_all_2020 %>%
  filter(phylum == "mollusca",
         trim_prop_gf > 0)

```


Look at finfish only 

```{r}
artis_finfish <- artis_trimmings_all_gf %>%
  filter(year == 2020) %>% 
  filter(phylum %in% c("chordata", NA)) %>% # ok only finfish (or NA)
  filter(!(common_name %in% c("sea urchins", "saltwater mussels", "sea lamprey", "lampreys nei"))) %>%
    left_join(countries, by = c("source_country_iso3c" = "iso3c"))


test <- artis_finfish %>%
  filter(is.na(trimmings_gf))

sum(test$product_weight_t) # 331945.7 missing total

## look at countries with trimmings:

test <- artis_finfish %>%
  filter(trimmings_gf == "yes") %>%
  group_by(source_country_iso3c) %>%
  summarise(total_trim_iso3c = sum(trim_product)) %>%
  ungroup() %>%
  mutate(total_trim_prop = total_trim_iso3c/sum(artis_finfish$trim_product, na.rm = TRUE)) %>%
  ungroup()
  
## look at countries with most missing

test <- artis_finfish %>%
  filter(is.na(trim_prop_gf)) %>%
  group_by(source_country_iso3c) %>%
  summarise(total_product = sum(product_weight_t)) %>%
  ungroup() 

unique(test$source_country_iso3c) # lots of countries here 

total_product_weight <- artis_finfish %>% 
  pull(product_weight_t) %>%
  sum() # 2996927

no_info_df <- artis_finfish %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- artis_finfish %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "Trimmings", "Whole fish")) %>%
  group_by(fishmeal_type, continent) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = total_product_weight) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%")) %>%
  arrange(desc(fishmeal_type))  %>%
  filter(prop > 0) %>%
  arrange(-prop) 

## oceania: #9F6144
## Africa: #A660A1
## Asia: #3F8D87
## South America: #8F464E
## North America: #E47669
## Europe: #5E74A1
## unknown: #808080
  
ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = continent)) +
  geom_bar(stat = "identity", color = "white") + 
 scale_fill_manual(values = c("#A660A1", "#3F8D87", "#5E74A1", "#E47669", "#9F6144", "#8F464E", "#808080")) +
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) # oh gosh... with the new data now ~50% from trimmings WITHOUT gapfilling...


## seems a bit more reasonable/matching to IFFO looking only at finfish...
```


Cao et al 2015
 - Around 40% of China's domestically produced fish meal is from processing waste 
 - European Union forbids use of farmed fish by-products in finfish feeds but allows them to be used in crustacean diets or vice versa. 


Let's look at just China and see if trimmings represents 40% of its finfish fishmeal

```{r}

artis_chn <- artis_all_2020 %>%
  filter(source_country_iso3c == "CHN",
         phylum == "chordata") 


no_info_df <- artis_chn %>%
  filter(is.na(trimmings_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()


bar_plot_df <- artis_chn %>% 
  filter(!is.na(trimmings_gf)) %>%
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
     rbind(., no_info_df) %>%
  mutate(total_product_t = sum(total, na.rm = TRUE)) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%"))

ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = phylum)) +
  geom_bar(stat = "identity", color = "white") + 
  theme_classic() +
  labs(fill = "", y = "Proportion of global trade", x = "Fishmeal type", title = "Global finfish fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) 


## Awesome! ~40% of fm in china is trimmings. Cao et al suggests 40% in 2015. There is still around 18% missing, so that number might go up a bit, which seems reasonable given the time difference

## lets gapfill based on fillets and see where the proportions end up 

fillet_chn <- fillet_artis %>% 
  filter(source_country_iso3c == "CHN") %>%
  pull(sciname) %>%
  unique() ## 127 spp

setdiff(unique(artis_chn$sciname), fillet_chn) # 10
setdiff(fillet_chn, unique(artis_chn$sciname)) # 36



artis_fillet_chn <- artis_chn %>% 
  mutate(trim_prop_gf = ifelse(is.na(trim_prop_gf) & sciname %in% c(fillet_chn), 1, trim_prop_gf)) %>%
  mutate(trim_prop_gf = ifelse(is.na(trim_prop_gf), 0, trim_prop_gf)) %>%
  mutate(trim_liveweight = trim_prop_gf*live_weight_t,
    trim_product = trim_prop_gf*product_weight_t, 
    wholefish_liveweight = (1-trim_prop_gf)*live_weight_t,
    wholefish_product = (1-trim_prop_gf)*product_weight_t) ## allocate with what info we have first for testing


no_info_df <- artis_fillet_chn %>%
  filter(is.na(trim_prop_gf)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, trash_fish) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()


bar_plot_df <- artis_fillet_chn %>% 
  pivot_longer(names_to = "fishmeal_type",
               cols = c("wholefish_product", "trim_product")) %>%
  mutate(fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "wholefish")) %>%
  group_by(fishmeal_type, trash_fish) %>%
  summarise(total = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
     rbind(., no_info_df) %>%
  mutate(total_product_t = sum(total, na.rm = TRUE)) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) %>% # Convert to percentage
  mutate(label = paste0(round(perc, 1), "%"))

## wow! ~42%. And the Cao et al one was from 2015. Feeling good about China. 

ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = trash_fish)) +
  geom_bar(stat = "identity", color = "white") + 
  theme_classic() +
  labs(fill = "Possibly trash fish", y = "Proportion of global trade", x = "Fishmeal type", title = "Global finfish fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) 


```

Random notes: 

https://www.marketsandmarkets.com/Market-Reports/aquafeeds-market-1151.html 
  - https://www.fortunebusinessinsights.com/industry-reports/aquafeed-market-100698 says that the aquafeed industry is worth USD 59 billion in 2024
  - https://www.fortunebusinessinsights.com/industry-reports/aquafeed-market-100698 says aquafeed industry is 64.06 billion USD
  - Cargill had net income of 4.93 billion, revenue is 165 billion
  - biomar revenue 2.6 billion, net income??
  - Skretting had 2.68 billion USD revenue


