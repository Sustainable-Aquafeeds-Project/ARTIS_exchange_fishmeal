---
title: "Gapfill with price and fillet"
output: html_document
date: "2024-08-01"
editor_options: 
  chunk_output_type: console
---

## Summary

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(glue)
library(sf)
library(devtools)
library(janitor)
library(countrycode)
library(qs)

source(here("R/directories.R"))

full_artis <- qs::qread(file.path(artis_dir, "full_artis_fm_fillet.qs"))

fillet_artis <- full_artis %>%
  filter(hs6 != 230120) %>%
  dplyr::select(-hs_version) %>% # don't need this
  rename(consumer_iso3c = importer_iso3c) # just to make things consistent

artis_taxa <- read.csv(file.path(artis_dir, "artis_full_data/data/attribute tables/sciname.csv")) ## read in attribute table with common names
countries <- read.csv(here("data/countries.csv")) ## artis countries with info

```

```{r}
dataset = "new"

if(dataset == "old"){
  artis_trimmings_all_gf <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded.qs"))

}else{
  artis_trimmings_all_gf <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_simple_gf_traded_consumption.qs"))

}

colnames(artis_trimmings_all_gf)


```

Join price data with this trimmings info, and get an 3-year rolling average price for whole fish rendered species per year (with a 10% buffer) (any species in data with info and used <50% of the time as trimmings). Any species below that price will be considered all whole fish fish meal. 

Following this, we gapfill based on any species that is filleted and share the same source country AND exporter country (we assume source and exporter, so that we know that the fish would be processed in the same place, and in theory, this could be the same fish) and year, assume these are all species which are "trimmings only" (for species that don't already have info). Then if there are still gaps, because some species do not have price data at all and are not reported as fillets, we will assume that it is whole fish derived, as a last resort because historically more often than not, fishmeal is derived from whole fish rendering. 

```{r}

fillet_data <- fillet_artis %>% 
  distinct(year, source_country_iso3c, exporter_iso3c, sciname) %>%
  mutate(filleted = "yes")

# prices <- read.csv(file.path(rdsi_raw_data_dir, "sea-around-us/ex-vessel-prices/outputFMFO2021-03-12.csv")) %>%
#   dplyr::select(-X) 

prices2 <- read.csv(file.path(rdsi_raw_data_dir, "sea-around-us/ex-vessel-prices/exvessel_price_database_1976_2019.csv")) %>%
  dplyr::select(-X) %>%
  clean_names() %>%
    mutate(sciname = tolower(scientific_name)) %>%
  dplyr::select(sciname, year, price2010usd_mean = exvessel) %>%
  filter(!is.na(price2010usd_mean))

expanded_data <- prices2 %>%
  expand(year = 1976:2020,  sciname)


filled_price_data <- expanded_data %>%
  # Left join to bring in existing data
  left_join(prices2, by = c("year", "sciname")) %>%
  # Step 3: Arrange data by species, and year
  arrange(sciname, year) %>%
  # Step 4: Fill `price2010usd_mean` up and down by each country and species combination
  group_by(sciname) %>%
  fill(price2010usd_mean, .direction = "downup") %>%  # Fill forward then backward
  # If needed, fill `price2010usd_ci` in the same way
  ungroup() %>%
  filter(!is.na(price2010usd_mean)) %>%
  distinct() %>%
  group_by(year, sciname) %>%
  summarise(price2010usd_mean = mean(price2010usd_mean, na.rm = TRUE)) %>% # there were species with multiple prices for some reason..
  ungroup() %>%
  mutate(sciname = ifelse(sciname == "salmonoidei", "salmonidae", sciname))

salmoninae <- filled_price_data %>%
  filter(sciname == "salmonidae") %>%
  mutate(sciname = "salmoninae")

filled_price_data <- filled_price_data %>%
  rbind(., salmoninae)

prices_aggregated <- artis_trimmings_all_gf  %>%
  right_join(filled_price_data) %>%
    filter(!is.na(trim_prop_gf)) %>%
   filter(trim_prop_gf < 0.5) %>% # so we have whole fish species in each country with a price
  dplyr::select(colnames(filled_price_data), source_country_iso3c) %>%
  distinct() %>%
  arrange(year) %>%
  group_by(year) %>%
  summarise(avg_price2010usd_mean = mean(price2010usd_mean, na.rm = TRUE)) %>%
  ungroup()

# Step 2: Calculate the 3-year rolling average
prices_aggregated <- prices_aggregated %>%
#  group_by(year) %>%
  arrange(year) %>%
  mutate(price_3yr_rolling_mean = zoo::rollapply(avg_price2010usd_mean, 
                                                 width = 3, 
                                                 FUN = mean, 
                                                 align = "right", 
                                                 fill = NA),
         # Add Â±5% buffer
         price_3yr_rolling_mean_lower = price_3yr_rolling_mean * 0.90,
         price_3yr_rolling_mean_upper = price_3yr_rolling_mean * 1.1) %>%
  ungroup() %>%
  fill(price_3yr_rolling_mean, price_3yr_rolling_mean_lower, price_3yr_rolling_mean_upper, .direction = "downup") # fill missing first 2 years

price_empty_gf <- artis_trimmings_all_gf %>%
  filter(is.na(trim_prop_gf)) %>%
  left_join(prices_aggregated) %>%
  left_join(filled_price_data) %>%
   # left_join(fillet_data) %>%
    distinct() %>%
    # mutate(trim_prop_gf = case_when(
    #    filleted == "yes" ~ 1, 
    #    price2010usd_mean <= price_3yr_rolling_mean_lower & is.na(filleted) ~ 0,
    #    price2010usd_mean > price_3yr_rolling_mean_lower & is.na(filleted) ~ 1,
    #   TRUE ~ 0)) %>%
  mutate(trim_prop_gf = ifelse(price2010usd_mean <= price_3yr_rolling_mean_upper, 0, trim_prop_gf),
         method_gf = ifelse(price2010usd_mean <= price_3yr_rolling_mean_upper, "gapfilled whole fish because average price is lower than 3-year average whole fish price", method_gf)) %>%
   dplyr::select(colnames(artis_trimmings_all_gf)) 

summary(price_empty_gf) 


 price_all_gf <- artis_trimmings_all_gf %>%
  filter(!is.na(trim_prop_gf)) %>%
  rbind(., price_empty_gf) %>%
   dplyr::select(-trim_product, -trim_liveweight, -wholefish_product, -wholefish_liveweight) %>%
  distinct() 


## gapfill with fillets last  
fillet_price_all_gf <- price_all_gf %>%
 left_join(fillet_data) %>%
 mutate(
 trimmings_gf = case_when(
   filleted == "yes" & is.na(trimmings_gf) ~ "yes",
   TRUE ~ trimmings_gf
 ),
 wholefish_gf = case_when(
   filleted == "yes" & is.na(wholefish_gf) ~ "no",
   TRUE ~ wholefish_gf
 )
 ) %>%
 mutate(trim_prop_gf_fin = case_when(
   wholefish_gf == "no" & trimmings_gf == "yes" & is.na(trim_prop_gf) ~ 1,
   is.na(filleted) & is.na(trim_prop_gf) ~ 0,
   TRUE ~ trim_prop_gf),
   method_gf_fin = case_when(
   filleted == "yes" & is.na(trim_prop_gf) ~ "assuming trimmings because filleted",
   is.na(filleted) & is.na(trim_prop_gf) ~ "assuming whole fish because not filleted and no price information",
   TRUE ~ method_gf
 ))  %>% # fill any that aren't filleted as whole fish reduction; cursory look and it appears most of these are echinoderms (not sure this makes sense given cucumbers are a delicacy) or things like sardines and pacific herring (pacific herring have history been used a reduction fisheries)
  mutate(trim_liveweight = trim_prop_gf_fin*live_weight_t,
    trim_product = trim_prop_gf_fin*product_weight_t,
    wholefish_liveweight = (1-trim_prop_gf_fin)*live_weight_t,
    wholefish_product = (1-trim_prop_gf_fin)*product_weight_t) %>%
  dplyr::select(year, source_country_iso3c, exporter_iso3c, consumer_iso3c, dom_source, hs6, sciname, common_name, habitat, method, trim_prop_gf_fin, trim_liveweight, trim_product, wholefish_liveweight, wholefish_product, method_trim_gf = method_gf_fin, trash_fish) %>%
  pivot_longer(., cols = c(trim_product, wholefish_product), names_to = "fishmeal_type", values_to = "product_weight_t") %>%
  mutate(live_weight_t = product_weight_t*2.975207,
         fishmeal_type = ifelse(fishmeal_type == "trim_product", "trimmings", "whole fish")) %>%
    dplyr::select(-trim_liveweight, -wholefish_liveweight)

```

Read in forage fisheries data and join; Forage fish species list taken from Clawson et al. 2024 in review: Continued transitions from fish meal and oil in aquafeeds require close attention to biodiversity trade-offs

```{r}
# forage fish spp list
forage_spp_list <- read.csv(here("data/forage_fish_list_final.csv")) %>%
  mutate(sciname = tolower(sci_name),
         common_name = tolower(common_name)) %>%
  dplyr::select(sciname) %>%
  filter(!is.na(sciname)) %>%
  mutate(forage_fish = 1) %>%
  distinct()


fm_data <- fillet_price_all_gf %>%
  left_join(forage_spp_list, by = "sciname")


test <- fm_data %>%
  left_join(artis_taxa) %>%
  filter(year == 2020, 
         phylum == "chordata") %>% 
  group_by(forage_fish, fishmeal_type) %>% 
  summarise(tonnes = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(total = sum(tonnes)) %>%
  mutate(prop = tonnes/total) # cool. Looks like ~30$% of trimmings fish meal is from forage fish. I wonder if this makes sense? Probably mostly from canned anchovies, sardines, etc

fm_data_2020 <- fm_data %>%
  group_by(year, source_country_iso3c, consumer_iso3c, sciname, fishmeal_type, method, forage_fish) %>%
  summarise(product_weight_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(year == 2020, forage_fish == 1, fishmeal_type == "whole fish", method != "aquaculture") # yep, the forage fish trimmings is mostly from anchovies and sardines. I wonder if this matches the market for canned fish? There are definitely trimmings from anchovy canning (heads, tails). From google it seems like 40-60% of a peruvian anchoveta are discarded when canning (if they aren't canned whole)... so it's not implausible to think that the trimmings from canning could be used for FM and this could be the result? 
# most whole fish production is peruvian anchoveta or blue whiting

```


Save the data 

```{r}

if(dataset == "old"){
  qs::qsave(fm_data, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_gf_final.qs"))

  
}else{
  
  qs::qsave(fm_data, file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_gf_final.qs"))

}

```

Testing and plots 

```{r}

fillet_price_all_gf <- qs::qread(file.path(artis_dir, "artis_exchange/artis_fishmeal_trimmings_traded_consumption_gf_final.qs")) %>%
  left_join(artis_taxa)

## make bar chart showing this 

no_info_df <- fillet_price_all_gf %>%
    left_join(artis_taxa) %>%
  filter(year == 2020, phylum == "chordata") %>%
  filter(is.na(trim_prop_gf_fin)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, trash_fish) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- fillet_price_all_gf %>%
    left_join(artis_taxa) %>%
  filter(year == 2020, phylum == "chordata") %>% 
  filter(!is.na(trim_prop_gf_fin)) %>%
  group_by(fishmeal_type, trash_fish) %>%
  summarise(total = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = sum(total)) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) # Convert to percentage
  

ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = trash_fish)) +
  geom_bar(stat = "identity", color = "white") + 
  theme_classic() +
  labs(y = "Proportion of global trade", x = "Fishmeal type", title = "Global finfish fishmeal 2020", fill = "Possibly trash fish") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) 


no_info_df <- fillet_price_all_gf %>%
  filter(year == 2020) %>%
  filter(is.na(trim_prop_gf_fin)) %>%
  mutate(fishmeal_type = "not sure") %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(product_weight_t)) %>%
  ungroup()

bar_plot_df <- fillet_price_all_gf %>%
  filter(year == 2020) %>% 
  filter(!is.na(trim_prop_gf_fin)) %>%
  group_by(fishmeal_type, phylum) %>%
  summarise(total = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  rbind(., no_info_df) %>%
  mutate(total_product_t = sum(total)) %>%
  mutate(prop = total/total_product_t) %>%
  mutate(perc = prop * 100) # Convert to percentage
  

ggplot(bar_plot_df, aes(x = reorder(fishmeal_type, -prop), y = prop, fill = phylum)) +
  geom_bar(stat = "identity", color = "white") + 
  theme_classic() +
  labs(y = "Proportion of global trade", x = "Fishmeal type", title = "Global fishmeal 2020") + 
    scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) 


## look at proportions over time 

over_time <- fillet_price_all_gf %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t)

ggplot(over_time, aes(x = year, y = prop, color = fishmeal_type)) +
  # geom_point() +
  geom_line() +
    geom_text(data = over_time, aes(label = round(prop,2)), 
            # hjust = -0.2, 
            vjust = -0.5,
            size = 3) + 
  theme_bw() +
  labs(title = "Global fishmeal production over time (1996-2020)", x = "Year", y = "Proportion of fishmeal", caption = "All species")


over_time <- fillet_price_all_gf %>%
  filter(phylum %in% c("chordata", NA)) %>% # ok only finfish (or NA)
  filter(!(common_name %in% c("sea urchins", "saltwater mussels", "sea lamprey", "lampreys nei"))) %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t)

ggplot(over_time, aes(x = year, y = prop, color = fishmeal_type)) +
 # geom_point() +
  geom_line() +
  geom_text(data = over_time, aes(label = round(prop,2)), 
            # hjust = -0.2, 
            vjust = -0.5,
            size = 3) + 
  theme_bw() +
  labs(title = "Global fishmeal production over time (1996-2020)", x = "Year", y = "Proportion of fishmeal", caption = "Finfish only")


over_time <- fillet_price_all_gf %>%
  #filter(phylum %in% c("mollusca", NA)) %>% # ok only finfish (or NA)
  group_by(year, fishmeal_type, phylum) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t)

ggplot(over_time, aes(x = year, y = product_t, color = fishmeal_type)) +
 #geom_point() +
  geom_line() +
  facet_wrap(~phylum) + 
  theme_bw() +
  labs(title = "Global fishmeal production over time (1996-2020)", x = "Year", y = "Product weight (tonnes)")


over_time <- fillet_price_all_gf %>%
  filter(phylum %in% c("chordata", NA)) %>% # ok only finfish (or NA)
  filter(!(common_name %in% c("sea urchins", "saltwater mussels", "sea lamprey", "lampreys nei"))) %>%
  filter(source_country_iso3c == "CHN") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t)

ggplot(over_time, aes(x = year, y = prop, color = fishmeal_type)) +
 # geom_point() +
  geom_line() +
  geom_text(data = over_time, aes(label = round(prop,2)), 
            # hjust = -0.2, 
            vjust = -0.5,
            size = 3) + 
  theme_bw() +
  labs(title = "Finfish fishmeal production over time (1996-2020) in China", x = "Year", y = "Proportion of fishmeal", caption = "Finfish only")

over_time <- fillet_price_all_gf %>%
  # filter(phylum %in% c("chordata", NA)) %>% # ok only finfish (or NA)
  # filter(!(common_name %in% c("sea urchins", "saltwater mussels", "sea lamprey", "lampreys nei"))) %>%
 # filter(source_country_iso3c == "CHN") %>%
  group_by(year, fishmeal_type) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(total_t = sum(product_t)) %>%
  ungroup() %>%
  mutate(prop = product_t/total_t)

ggplot(over_time, aes(x = year, y = product_t, color = fishmeal_type)) +
 # geom_point() +
  geom_line() +
 # facet_wrap(~phylum) +
  # geom_text(data = over_time, aes(label = round(prop,2)), 
  #           # hjust = -0.2, 
  #           vjust = -0.5,
  #           size = 3) + 
  theme_bw() +
  labs(title = "Fishmeal production over time (1996-2020)", x = "Year", y = "Product weight (tonnes)")



over_time <- fillet_price_all_gf %>%
  filter(phylum %in% c("chordata")) %>%
  group_by(year, fishmeal_type, common_name, source_country_iso3c) %>%
  summarise(product_t = sum(product_weight_t, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(year %in% c(2009, 2010),
         fishmeal_type == "whole fish",
         product_t > 0) %>%
  pivot_wider(., names_from = year, values_from = product_t) %>%
    mutate(`2010` = ifelse(is.na(`2010`), 0, `2010`),
           `2009` = ifelse(is.na(`2009`), 0, `2009`)) %>%
  mutate(diff = `2010`-`2009`) # yep, el nino year screwed with fish stocks


```


Mussel meal notes: 
 - https://www.feedstrategy.com/animal-nutrition/article/15442527/trial-to-consider-if-mussels-might-replace-fish-meal
 - https://www.feedipedia.org/node/670
 - https://www.tandfonline.com/doi/full/10.1080/09064700902730158#abstract

```{r}
mussel_meal <- fillet_price_all_gf %>%
  filter(year == 2020, isscaap == "Mussels")
## China and Chile to China/Japan

oyster_meal <- fillet_price_all_gf %>%
  filter(year == 2020, isscaap == "Oysters")
## Now USA, used to be a lot more from China before the algal blooms in 2012/2013

# both the oyster and mussel meal are pretty much all aquaculture derived 



```


```{r}
krill_meal <- fillet_price_all_gf %>%
  filter(year == 2020, 
         str_detect(common_name, "krill"),
         product_weight_t > 0) 

sum(krill_meal$product_weight_t) # 19825.16

all_2020 <- fillet_price_all_gf %>%
  filter(year == 2020)
sum(all_2020$product_weight_t) # 6233093


sum(krill_meal$product_weight_t)/ 6233093 # 0.00318063


unspec_meal <- fillet_price_all_gf %>%
  filter(year == 2020, 
         str_detect(sciname, "animalia|actinopterygii"),
         product_weight_t > 0) 

sum(unspec_meal$product_weight_t)/ 6233093 # 0.03199211


unspec_meal <- fillet_price_all_gf %>%
  filter(year == 2020, 
         method_trim_gf == "Asian trash fish assumption",
         product_weight_t > 0) 

sum(unspec_meal$product_weight_t)/ 6233093 # 0.06201794
sum(unspec_meal$live_weight_t) # 1150107 - this is under the value which is estimated in https://www.slideshare.net/slideshow/the-status-of-asian-fisheries-meeting-the-demands-for-food-and-feeds/47356205#4

unspec_meal <- fillet_price_all_gf %>%
  filter(year == 2010, 
         method_trim_gf == "Asian trash fish assumption",
         product_weight_t > 0) 

sum(unspec_meal$live_weight_t) # 1013141 - this is under the value which is estimated in https://www.slideshare.net/slideshow/the-status-of-asian-fisheries-meeting-the-demands-for-food-and-feeds/47356205#4

countries <- read.csv(here("data/countries.csv")) ## artis countries with info

asia_iso3c <- countries %>% 
  filter(owid_region == "Asia") %>%
  pull(iso3c)

trash_fish_test <- fillet_price_all_gf %>%
  filter(year == 2010, 
         source_country_iso3c %in% asia_iso3c, 
         trash_fish == "yes",
         product_weight_t > 0) 
sum(trash_fish_test$live_weight_t) # 1306160

```



https://www.marketsandmarkets.com/Market-Reports/aquafeeds-market-1151.html 
  - https://www.fortunebusinessinsights.com/industry-reports/aquafeed-market-100698 says that the aquafeed industry is worth USD 59 billion in 2024
  - https://www.fortunebusinessinsights.com/industry-reports/aquafeed-market-100698 says aquafeed industry is 64.06 billion USD
  - Cargill had net income of 4.93 billion, revenue is 165 billion
  - biomar revenue 2.6 billion, net income??
  - Skretting had 2.68 billion USD revenue


